!function(){"use strict";const e="MessageList",t="FolderList",s="MessageView",i="Settings",r={Normal:0,FileIsTooBig:1,FilePartiallyUploaded:3,NoFileUploaded:4,MissingTempFolder:6,OnSavingFile:7,FileType:98,Unknown:99},a=-2,o=-1,n=1,l=0,c={RequestError:1,RequestAborted:2,RequestTimeout:3,InvalidToken:101,AuthError:102,ConnectionError:104,DomainNotAllowed:109,AccountNotAllowed:110,CryptKeyError:111,ContactsSyncError:140,CantGetMessageList:201,CantGetMessage:202,CantDeleteMessage:203,CantMoveMessage:204,CantCopyMessage:205,CantSaveMessage:301,CantSendMessage:302,InvalidRecipients:303,CantSaveFilters:351,CantGetFilters:352,CantActivateFiltersScript:353,CantDeleteFiltersScript:354,CantCreateFolder:400,CantRenameFolder:401,CantDeleteFolder:402,CantSubscribeFolder:403,CantUnsubscribeFolder:404,CantDeleteNonEmptyFolder:405,DomainAlreadyExists:601,DemoSendMessageError:750,DemoAccountError:751,AccountAlreadyExists:801,AccountDoesNotExist:802,AccountSwitchFailed:803,MailServerError:901,ClientViewError:902,InvalidInputArgument:903,JsonFalse:950,JsonParse:952,UnknownError:999,CantInstallPackage:701,CantDeletePackage:702,InvalidPluginPackage:703,UnsupportedPluginPackage:704,CantSavePluginSettings:705},d=Array.isArray,h=e=>d(e)&&e.length,u=e=>"function"==typeof e,p=e=>null!=e?""+e:"",m=(e,t)=>Object.values(e).forEach(t),g=(e,t)=>Object.entries(e).forEach(([e,s])=>t(e,s)),f=(e,t=0)=>(e=parseInt(e,10),isFinite(e)?e:t),y=(e,t)=>t&&void 0!==t.disabled&&e?.classList.toggle("disabled",e.disabled=t.disabled),b=e=>btoa(unescape(encodeURIComponent(e))),S=e=>(e=>b(JSON.stringify(e)))(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),v=(e,t)=>Object.keys(e).find(s=>e[s]===t);let w="all";const E="Menu",A=document,C=A.documentElement.classList,k=e=>A.getElementById(e),T=k("rl-app"),M=rl.settings,F=M.get,L=e=>(F("Admin")||{})[e],x=e=>e&&!!(F("Capa")||{})[e],I=[],P=ko.observable(!1).extend({rateLimit:0}),O=ko.observable(!1),N=()=>O(!O()),D=(e,t)=>{let s=A.createElement(e);return t&&Object.entries(t).forEach(([e,t])=>s.setAttribute(e,t)),s},R=(e,t,s)=>dispatchEvent(new CustomEvent(e,{detail:t,cancelable:!!s})),V=e=>{e.preventDefault(),e.stopPropagation()},U=()=>A.activeElement?.matches("input,textarea"),_=(...e)=>shortcuts.add(...e),q=(e,t,s,i)=>_(e,t,s,e=>!!U()||i(e)),B=(e,t,s,i)=>t.forEach(t=>e.addEventListener(t,s,i)),K=(e,t)=>Object.entries(t).forEach(([t,s])=>e.addEventListener(t,s)),H=ko.observable("all"),G=e=>{if(!e)return w;E!==e&&(w=e,P()&&(e=E)),H(e),shortcuts.setScope(e)};P.subscribe(e=>{e?G(E):E===shortcuts.getScope()&&G(w)}),O.subscribe(e=>C.toggle("rl-left-panel-disabled",e));const $=A.location.pathname.replace(/\/+$/,"")+"/",j="#/",W=()=>rl.adminArea()&&!L("host"),J=()=>$+"?"+(W()?L("path"):""),z="&q[]=",Y=(e,t)=>$+"?/Raw/"+z+"/0/"+(e?e+"/"+(t?z+"/"+t:""):""),Z=e=>Y("Download",e),X=e=>$+"?/ProxyExternal/"+btoa(e.replace(/ /g,"%20")).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),Q=e=>J()+"/"+e+"/"+z+"/0/",ee=e=>M.app("webVersionPath")+"static/"+e,te=(e="")=>"#/settings"+(e?"/"+e:""),se=(e,t,s,i,r)=>{let a=["#/mailbox"];return e&&a.push(e+(i?"~"+i:"")),r?a.push("m"+r):(1<(t=f(t,1))&&a.push("p"+t),s&&a.push(encodeURI(s))),a.join("/")},ie={language:ko.observable(""),languages:ko.observableArray(),userLanguage:ko.observable(""),hourCycle:ko.observable(""),populate:function(){const e=M.app("languages");this.languages(d(e)?e:[]),this.language(F("language")),this.userLanguage(F("clientLanguage")),this.hourCycle(F("hourCycle"))}};let re={};const ae=()=>{if(rl.I18N)return re=rl.I18N,rl.I18N=null,A.documentElement.dir=re.LANG_DIR,1},oe=e=>{let t=v(c,e);return t?re.NOTIFICATIONS[t]:""},ne=e=>ce(Math.round((e.getTime()-Date.now())/1e3)),le=ko.observable(!1),ce=e=>{let t="second",s=[[60,"minute"],[3600,"hour"],[86400,"day"],[2628e3,"month"],[31536e3,"year"]],i=5,r=Math.abs(e);for(;i--;)if(s[i][0]<=r){e=Math.round(e/s[i][0]),t=s[i][1];break}if(Intl.RelativeTimeFormat)return new Intl.RelativeTimeFormat(A.documentElement.lang).format(e,t);r=Math.abs(e);let a=rl.relativeTime.long[t][0>e?"past":"future"];return(a[rl.relativeTime.plural(r)]||a).replace("{0}",r)},de=(e,t,s)=>{let i=s??e,r=e.split("/");return re[r[0]]&&r[1]&&(i=re[r[0]][r[1]]||i),t&&g(t,(e,t)=>{i=i.replace("%"+e+"%",t)}),i},he=e=>setTimeout(()=>e.querySelectorAll("[data-i18n]").forEach(e=>{const t=e.dataset.i18n;if("["===t[0])switch(t.slice(1,6)){case"html]":e.innerHTML=de(t.slice(6));break;case"place":e.placeholder=de(t.slice(13));break;case"title":e.title=de(t.slice(7))}else e.textContent=de(t)}),1),ue=(e,t)=>{const s=Date.now(),i=0<e?1e3*e:0===e?s:0;if(31536e6<i){const e=new Date(i),r=ie.hourCycle();switch(t){case"FROMNOW":return ne(e);case"AUTO":{if(144e5>=s-i)return ne(e);const t=new Date,a=t.setHours(0,0,0,0);return i>a-864e5?de(i>a?"MESSAGE_LIST/TODAY_AT":"MESSAGE_LIST/YESTERDAY_AT",{TIME:e.format("LT",0,r)}):e.format(t.getFullYear()===e.getFullYear()?{day:"2-digit",month:"short",hour:"numeric",minute:"numeric"}:{dateStyle:"medium",timeStyle:"short"},0,r)}case"FULL":return e.format("LLL",0,r);default:return e.format(t,0,r)}}return""},pe=(e,t)=>{try{t?e.dateTime=new Date(1e3*t).toISOString():t=Date.parse(e.dateTime)/1e3;let s=e.dataset.timeFormat;s&&(e.textContent=ue(t,s),"FULL"!==s&&"FROMNOW"!==s&&(e.title=ue(t,"FULL")))}catch(e){console.error(e)}},me=()=>A.querySelectorAll("time").forEach(e=>pe(e)),ge=(e,t)=>{e?.(),e&&le.subscribe(e),t&&le.subscribe(t)},fe=(e,t="",s=0)=>(e=f(e),c.ClientViewError===e&&t?t:oe(e)||oe(f(s))||""),ye=(e,t)=>fe(e)||t?.messageAdditional||t?.message||t,be=e=>{let t=v(r,parseInt(e,10));return de("UPLOAD/ERROR_"+(t?(e=>e.replace(/([a-z])([A-Z])/g,"$1_$2").toUpperCase())(t):"UNKNOWN"))},Se=(e,t)=>new Promise((s,i)=>{const r=D("script");r.onload=()=>{ae()&&(he(A),le(!le())),r.remove(),s()},r.onerror=()=>i(Error("Language "+e+" failed")),r.src=$+"?/Lang/0/"+(t?"Admin":"App")+"/"+encodeURI(e)+"/"+M.app("version")+"/",A.head.append(r)}),ve=(e,t=!1)=>de("LANGS_NAMES"+(!0===t?"_EN":"")+"/"+e,null,e),we=e=>new Intl.Collator(A.documentElement.lang,{numeric:!!e,sensitivity:"base"});ae();const Ee=(e,t)=>t?setTimeout(()=>e.setAttribute("data-rainloopErrorTip",t),100):e.removeAttribute("data-rainloopErrorTip"),Ae=e=>ko.computed(e,{pure:!0}),Ce=(e,t)=>g(t,(t,s)=>e[t]||(e[t]=ko.observable(s))),ke=(e,t)=>g(t,(t,s)=>e[t]=Ae(s)),Te=(e,t)=>g(t,(t,s)=>e[t].subscribe(s)),Me=e=>u(e?.dispose)&&e.dispose(),Fe=(e,t,s)=>{e.addEventListener(t,s),ko.addDisposeCallback(e,()=>e.removeEventListener(t,s))},Le=(e,t,s,i,r)=>{Fe(t,"keydown",t=>{e==t.key&&s().call(r)})},xe=e=>((e=ko.observableArray(e)).subscribe(e=>e.forEach(e=>"deleted"===e.status&&null==e.moved&&e.value.onDestroy?.()),e,"arrayChange"),e);Object.assign(ko.bindingHandlers,{tooltipErrorTip:{init:(e,t)=>{A.addEventListener("click",()=>{let s=t();ko.isObservable(s)&&!ko.isComputed(s)&&s(""),Ee(e)})},update:(e,t)=>{let s=ko.unwrap(t());Ee(e,u(s)?s():s)}},onEnter:{init:(e,t,s,i)=>Le("Enter",e,t,0,i)},onEsc:{init:(e,t,s,i)=>Le("Escape",e,t,0,i)},onSpace:{init:(e,t,s,i)=>Le(" ",e,t,0,i)},toggle:{init:(e,t)=>{let s=t(),i=()=>s(!s());Fe(e,"click",i),Fe(e,"keydown",e=>" "==e.key&&i())}},i18nUpdate:{update:(e,t)=>{ko.unwrap(t()),he(e)}},command:{init:(e,t,s,i,r)=>{const a=t();if(!a||!a.canExecute)throw Error("Value should be a command");ko.bindingHandlers["FORM"==e.nodeName?"submit":"click"].init(e,t,s,i,r)},update:(e,t)=>{let s=!t().canExecute();e.classList.toggle("disabled",s),e.matches("INPUT,TEXTAREA,BUTTON")&&(e.disabled=s)}},saveTrigger:{init:e=>{let t=e;e.matches("input,select,textarea")&&(e.classList.add("settings-save-trigger-input"),e.after(e.saveTriggerIcon=t=D("span"))),t.classList.add("settings-save-trigger")},update:(e,t)=>{const s=parseInt(ko.unwrap(t()),10);let i=(e.saveTriggerIcon||e).classList;e.saveTriggerIcon&&(i.toggle("saving",s===a),i.toggle("success",s===n),i.toggle("error",s===l)),i=e.classList,i.toggle("success",s===n),i.toggle("error",s===l)}}}),ko.extenders.toggleSubscribeProperty=(e,t)=>{const s=t[1];return s&&(e.subscribe(e=>e?.[s]?.(!1),t[0],"beforeChange"),e.subscribe(e=>e?.[s]?.(!0),t[0])),e},ko.extenders.falseTimeout=(e,t)=>(e.subscribe((()=>e(!1)).debounce(parseInt(t,10)||0)),e),ko.observable.fn.askDeleteHelper=function(){return this.extend({falseTimeout:3e3,toggleSubscribeProperty:[this,"askDelete"]})};const Ie="message/rfc822",Pe={},Oe="application/",Ne=Oe+"vnd.openxmlformats-officedocument.",De=Oe+"vnd.oasis.opendocument.",Re=["B","KiB","MiB","GiB","TiB"],Ve=e=>e.toLowerCase().trim(),Ue={eml:Ie,mime:Ie,vcard:"text/vcard",vcf:"text/vcard",htm:"text/html",html:"text/html",csv:"text/csv",ics:"text/calendar",xml:"text/xml",json:Oe+"json",p10:Oe+"pkcs10",p7c:Oe+"pkcs7-mime",p7m:Oe+"pkcs7-mime",p7s:Oe+"pkcs7-signature",p12:Oe+"pkcs12",pfx:Oe+"x-pkcs12",torrent:Oe+"x-bittorrent",js:Oe+"javascript",pl:"text/perl",css:"text/css",asp:"text/asp",php:Oe+"x-php",jpg:"image/jpeg",ico:"image/x-icon",tif:"image/tiff",svg:"image/svg+xml",svgz:"image/svg+xml",zip:Oe+"zip","7z":Oe+"x-7z-compressed",rar:Oe+"x-rar-compressed",cab:Oe+"vnd.ms-cab-compressed",gz:Oe+"x-gzip",tgz:Oe+"x-gzip",bz:Oe+"x-bzip",bz2:Oe+"x-bzip2",deb:Oe+"x-debian-package",mp3:"audio/mpeg",wav:"audio/x-wav",mp4a:"audio/mp4",weba:"audio/webm",m3u:"audio/x-mpegurl",qt:"video/quicktime",mov:"video/quicktime",wmv:"video/windows-media",avi:"video/x-msvideo","3gp":"video/3gpp","3g2":"video/3gpp2",mp4v:"video/mp4",mpg4:"video/mp4",ogv:"video/ogg",m4v:"video/x-m4v",asf:"video/x-ms-asf",asx:"video/x-ms-asf",wm:"video/x-ms-wm",wmx:"video/x-ms-wmx",wvx:"video/x-ms-wvx",movie:"video/x-sgi-movie",pdf:Oe+"pdf",psd:"image/vnd.adobe.photoshop",ai:Oe+"postscript",eps:Oe+"postscript",ps:Oe+"postscript",doc:Oe+"msword",rtf:Oe+"rtf",xls:Oe+"vnd.ms-excel",ppt:Oe+"vnd.ms-powerpoint",docx:Ne+"wordprocessingml.document",xlsx:Ne+"spreadsheetml.sheet",dotx:Ne+"wordprocessingml.template",pptx:Ne+"presentationml.presentation",odt:De+"text",ods:De+"spreadsheet",odp:De+"presentation"},_e="unknown",qe="text",Be="code",Ke="eml",He="word",Ge="pdf",$e="image",je="audio",We="video",Je="spreadsheet",ze="presentation",Ye="certificate",Ze="archive",Xe="calendar",Qe={getExtension:e=>{const t=(e=Ve(e)).split(".").pop();return t===e?"":t},getContentType:e=>{if("winmail.dat"===(e=Ve(e)))return Oe+"vnd.ms-tnef";let t=e.split(".").pop();return/^(txt|text|def|list|in|ini|log|sql|cfg|conf)$/.test(t)?"text/plain":/^(mpe?g|mpe|m1v|m2v)$/.test(t)?"video/mpeg":/^aif[cf]?$/.test(t)?"audio/aiff":/^(aac|flac|midi|ogg)$/.test(t)?"audio/"+t:/^(h26[134]|jpgv|mp4|webm)$/.test(t)?"video/"+t:/^(otf|sfnt|ttf|woff2?)$/.test(t)?"font/"+t:/^(png|jpeg|gif|tiff|webp)$/.test(t)?"image/"+t:Ue[t]||Oe+"octet-stream"},getType:(e,t)=>{let s=(e=Ve(e))+(t=Ve(t).replace("csv/plain","text/csv").replace("x-",""));if(Pe[s])return Pe[s];let i=_e;const r=t.split("/"),a=r[1].replace("-compressed",""),o=e=>t.includes(e),n=/^(zip|7z|tar|rar|gzip|bzip|bzip2)$/;switch(!0){case"image"==r[0]||["png","jpg","jpeg","gif","webp"].includes(e):i=$e;break;case"audio"==r[0]||["mp3","ogg","oga","wav"].includes(e):i=je;break;case"video"==r[0]||"mkv"==e||"avi"==e:i=We;break;case["php","js","css","xml","html"].includes(e)||"text/html"==t:i=Be;break;case"eml"==e||["message/delivery-status",Ie].includes(t):i=Ke;break;case"ics"==e||"text/calendar"==t:i=Xe;break;case"text"==r[0]||"txt"==e||"log"==e:i=qe;break;case n.test(a)||n.test(e):i=Ze;break;case"pdf"==a||"pdf"==e:i=Ge;break;case[Oe+"pgp-signature",Oe+"pgp-keys",Ue.p7m,Ue.p7s,Ue.p12,Ue.pfx].includes(t)||["asc","pem","ppk","p7s","p7m","p12","pfx"].includes(e):i=Ye;break;case o(Ne+".wordprocessingml")||o(De+".text")||o("vnd.ms-word")||["rtf","msword","vnd.msword"].includes(a):i=He;break;case o(Ne+".spreadsheetml")||o(De+".spreadsheet")||o("ms-excel"):i=Je;break;case o(Ne+".presentationml")||o(De+".presentation")||o("ms-powerpoint"):i=ze}return Pe[s]=i},getTypeIconClass:e=>{let t="icon-file";switch(e){case qe:case Ke:case Ge:case He:return t+"-text";case Be:case $e:case je:case We:case Ze:case Ye:case Je:case ze:case Xe:return t+"-"+e}return t},getIconClass:(e,t)=>Qe.getTypeIconClass(Qe.getType(e,t)),getAttachmentsIconClass:e=>{if(h(e)){let t=e.map(e=>e?Qe.getIconClass(Qe.getExtension(e.fileName),e.mimeType):"").validUnique();return 1===t?.length&&"icon-file"!==t[0]?t[0]:"icon-attachment"}return""},friendlySize:e=>{let t=(e=f(e))?Math.floor(Math.log(e)/Math.log(1024)):0;return(e/Math.pow(1024,t)).toFixed(2>t?0:1)+" "+Re[t]}},et={Inbox:1,Sent:2,Drafts:3,Junk:4,Trash:5,Archive:6},tt="/private/vendor/kolab/folder-type",st="/shared/vendor/kolab/folder-type",it={Empty:0,Reply:1,ReplyAll:2,Forward:3,ForwardAsAttachment:4,Draft:5,EditAsNew:6},rt=0,at=1,ot=2,nt=3,lt=4,ct=5;let dt=0;const ht=matchMedia("(max-width: 799px)"),ut={theme:ko.observable(""),themes:ko.observableArray(),userBackgroundName:ko.observable(""),userBackgroundHash:ko.observable(""),fontSansSerif:ko.observable(""),fontSerif:ko.observable(""),fontMono:ko.observable(""),isMobile:ko.observable(!1)},pt=()=>{const e=F("Theme"),t=M.app("themes");ut.themes(d(t)?t:[]),ut.theme(e),mt(e),ut.isMobile()||(ut.userBackgroundName(F("userBackgroundName")),ut.userBackgroundHash(F("userBackgroundHash"))),ut.fontSansSerif(F("fontSansSerif")),ut.fontSerif(F("fontSerif")),ut.fontMono(F("fontMono")),O(ut.isMobile())},mt=(e,t=()=>0)=>{const s=k("app-theme-style"),i=()=>{dt=setTimeout(()=>t(o),1e3)},r=$+"?/Css/0/User/-/"+encodeURI(e)+"/-/"+Date.now()+"/Hash/-/Json/";s.dataset.name!=e&&(clearTimeout(dt),t(a),rl.app.Remote.abort("theme").get("theme",r).then(r=>{2===h(r)&&(s.textContent=r[1],s.dataset.name=e,t(n)),i()},i))};Te(ut,{fontSansSerif:e=>{if(null!=e){let t=T.classList;t.forEach(e=>{e.startsWith("font")&&!/font(Serif|Mono)/.test(e)&&t.remove(e)}),e&&t.add("font"+e)}},fontSerif:e=>{if(null!=e){let t=T.classList;t.forEach(e=>e.startsWith("fontSerif")&&t.remove(e)),e&&t.add("fontSerif"+e)}},fontMono:e=>{if(null!=e){let t=T.classList;t.forEach(e=>e.startsWith("fontMono")&&t.remove(e)),e&&t.add("fontMono"+e)}},userBackgroundHash:e=>{T.classList.toggle("UserBackground",!!e),T.style.backgroundImage=e?"url("+Y("UserBackground",e)+")":null}}),ht.onchange=e=>{ut.isMobile(e.matches),C.toggle("rl-mobile",e.matches),O(e.matches)},ht.onchange(ht);const gt="__UNUSE__";let ft=new Map,yt=new Map,bt="INBOX";const St=()=>bt,vt=e=>{e.etag="",ft.set(e.fullName,e),yt.set(e.fullNameHash,e.fullName)},wt=(e,t)=>ft.has(e)&&(ft.get(e).etag=t),Et=e=>ft.get(e),At=e=>ft.delete(e),Ct=["$forwarded","$mdnsent","$submitpending","$submitted","$junk","$notjunk","$phishing","sent","$encrypted","$error","$ignored","$invitation","$queued","$sent","$signed","$todo","$watched","$notphishing","junk","nonjunk","$attachment","$replied","$readreceipt","$notdelivered"],kt=e=>"\\"!=e[0]&&!Ct.includes(e.toLowerCase()),Tt=new class{constructor(){const e=this;Ce(e,{displaySpecSetting:!1,sortMode:"",quotaLimit:0,quotaUsage:0,sentFolder:"",draftsFolder:"",spamFolder:"",trashFolder:"",archiveFolder:"",optimized:!1,error:"",foldersLoading:!1,foldersCreating:!1,foldersDeleting:!1,foldersRenaming:!1,foldersInboxUnreadCount:0}),e.namespace="",e.folderList=ko.observableArray(),e.capabilities=ko.observableArray(),e.currentFolder=ko.observable(null).extend({toggleSubscribeProperty:[e,"selected"]}),ke(e,{draftsFolderNotEnabled:()=>!e.draftsFolder()||gt===e.draftsFolder(),currentFolderFullName:()=>e.currentFolder()?e.currentFolder().fullName:"",currentFolderFullNameHash:()=>e.currentFolder()?e.currentFolder().fullNameHash:"",foldersChanging:()=>e.foldersLoading()|e.foldersCreating()|e.foldersDeleting()|e.foldersRenaming(),systemFoldersNames:()=>{const t=[St()],s=[e.sentFolder(),e.draftsFolder(),e.spamFolder(),e.trashFolder(),e.archiveFolder()];return e.folderList().length&&s.forEach(e=>e&&gt!==e&&t.push(e)),t},systemFolders:()=>e.systemFoldersNames().map(e=>Et(e)).filter(e=>e)});const t=t=>{t.subscribe(()=>Et(t())?.type(0),e,"beforeChange")},s=e=>t=>Et(t)?.type(e);t(e.sentFolder),t(e.draftsFolder),t(e.spamFolder),t(e.trashFolder),t(e.archiveFolder),Te(e,{sentFolder:s(et.Sent),draftsFolder:s(et.Drafts),spamFolder:s(et.Junk),trashFolder:s(et.Trash),archiveFolder:s(et.Archive)}),e.quotaPercentage=Ae(()=>{const t=e.quotaLimit(),s=e.quotaUsage();return 0<t?Math.ceil(s/t*100):0})}hasCapability(e){return this.capabilities().includes(e)}allowKolab(){return Tt.hasCapability("METADATA")&&x("Kolab")}getNextFolderNames(e){const t=[],s=Date.now(),i=s-e,r=[],a=this.displaySpecSetting(),o=e=>{e.forEach(e=>{e?.selectable()&&e.exists&&i>e.expires&&(e.isSystemFolder()||e.isSubscribed()&&(e.checkable()||!a))&&r.push([e.expires,e.fullName]),e?.subFolders.length&&o(e.subFolders())})};return o(this.folderList()),r.sort((e,t)=>e[0]<t[0]?-1:e[0]>t[0]?1:0),r.find(e=>{const i=Et(e[1]);return i&&(i.expires=s,t.push(e[1])),10<=t.length}),t}saveSystemFolders(e){e=e||{sent:Tt.sentFolder(),drafts:Tt.draftsFolder(),junk:Tt.spamFolder(),trash:Tt.trashFolder(),archive:Tt.archiveFolder()},g(e,(e,t)=>M.set(e+"Folder",t)),rl.app.Remote.request("SystemFoldersUpdate",null,e)}},Mt=new class{constructor(){const e=this;e.messagesPerPage=ko.observable(25).extend({debounce:999}),e.checkMailInterval=ko.observable(15).extend({debounce:999}),e.messageReadDelay=ko.observable(5).extend({debounce:999}),Ce(e,{viewHTML:1,viewImages:0,viewImagesWhitelist:"",removeColors:0,allowStyles:0,collapseBlockquotes:1,maxBlockquotesLevel:0,listInlineAttachments:0,simpleAttachmentsList:0,useCheckboxesInList:1,listGrouped:0,showNextMessage:0,allowDraftAutosave:1,useThreads:0,defaultSort:"",threadAlgorithm:"",replySameFolder:0,hideUnsubscribed:0,hideDeleted:1,unhideKolabFolders:0,autoLogout:0,keyPassForget:15,showUnreadCount:0,messageNewWindow:0,messageReadAuto:0,requestReadReceipt:0,requestDsn:0,requireTLS:0,pgpSign:0,pgpEncrypt:0,allowSpellcheck:0,layout:1,editorDefaultType:"Html",editorWysiwyg:"Squire",markdown:0,msgDefaultAction:1}),e.init(),e.usePreviewPane=Ae(()=>ut.isMobile()?0:e.layout());const t=()=>{const t=e.usePreviewPane();C.toggle("sm-msgView-side",1===t),C.toggle("sm-msgView-bottom",2===t),R("rl-layout",t)};let s;e.layout.subscribe(t),ut.isMobile.subscribe(t),t(),e.delayLogout=(()=>{clearTimeout(s),0<e.autoLogout()&&!F("accountSignMe")&&(s=setTimeout(rl.app.logout,6e4*e.autoLogout()))}).throttle(5e3)}init(){const e=this;["EditorDefaultType","editorWysiwyg","messageNewWindow","messageReadAuto","MsgDefaultAction","ViewHTML","ViewImages","ViewImagesWhitelist","RemoveColors","AllowStyles","CollapseBlockquotes","MaxBlockquotesLevel","ListInlineAttachments","simpleAttachmentsList","UseCheckboxesInList","listGrouped","showNextMessage","AllowDraftAutosave","useThreads","defaultSort","threadAlgorithm","ReplySameFolder","HideUnsubscribed","HideDeleted","ShowUnreadCount","UnhideKolabFolders","requestReadReceipt","requestDsn","requireTLS","pgpSign","pgpEncrypt","allowSpellcheck","markdown"].forEach(t=>{let s=F(t);t=t[0].toLowerCase()+t.slice(1),e[t](s)}),e.layout(f(F("Layout"))),e.messagesPerPage(f(F("MessagesPerPage"))),e.checkMailInterval(f(F("CheckMailInterval"))),e.messageReadDelay(f(F("MessageReadDelay"))),e.autoLogout(f(F("AutoLogout"))),e.keyPassForget(f(F("keyPassForget"))),Tt.sortMode(e.defaultSort())}},Ft=ko.observableArray();Ft.push({name:"Squire",construct:(e,t,s)=>s(new SquireUI(t))}),rl.registerWYSIWYG=(e,t)=>Ft.push({name:e,construct:t});class HtmlEditor{constructor(e,t=null,s=null,i=null){if(this.blurTimer=0,this.onBlur=i,this.onModeChange=s,e){t=t?[t]:[],this.onReady=e=>t.push(e);const s=Mt.editorWysiwyg();(Ft.find(e=>s==e.name)||Ft.find(e=>"Squire"==e.name)).construct(this,e,e=>setTimeout(()=>{this.editor=e,e.on("blur",()=>this.blurTrigger()),e.on("focus",()=>clearTimeout(this.blurTimer)),e.on("mode",()=>{this.blurTrigger(),this.onModeChange?.(!this.isPlain())}),this.onReady=e=>e(),t.forEach(e=>e())},1))}}blurTrigger(){this.onBlur&&(clearTimeout(this.blurTimer),this.blurTimer=setTimeout(()=>this.onBlur?.(),200))}isHtml(){return!!this.editor&&!this.isPlain()}isPlain(){return!!this.editor&&"plain"===this.editor.mode}clearCachedSignature(){this.onReady(()=>this.editor.execCommand("insertSignature",{clearCache:!0}))}setSignature(e,t,s=!1){this.onReady(()=>this.editor.execCommand("insertSignature",{isHtml:t,insertBefore:s,signature:e}))}getData(){let e="";if(this.editor)try{e=this.isPlain()?this.editor.getPlainData():this.editor.getData()}catch(e){}return e}getDataWithHtmlMark(){return(this.isHtml()?":HTML:":"")+this.getData()}modeWysiwyg(){this.onReady(()=>this.editor.setMode("wysiwyg"))}modePlain(){this.onReady(()=>this.editor.setMode("plain"))}setHtmlOrPlain(e){e.startsWith(":HTML:")?this.setHtml(e.slice(6)):this.setPlain(e)}setData(e,t){this.onReady(()=>{const s=this.editor;this.clearCachedSignature();try{s.setMode(e),this.isPlain()?s.setPlainData(t):s.setData(t)}catch(e){console.error(e)}})}setHtml(e){this.setData("wysiwyg",e)}setPlain(e){this.setData("plain",e)}focus(){this.onReady(()=>this.editor.focus())}blur(){this.onReady(()=>this.editor.blur())}clear(){this.onReady(()=>this.isPlain()?this.setPlain(""):this.setHtml(""))}}const Lt=D("template"),xt=new TurndownService,It=/[&<>"']/g,Pt=/^(https?:)?\/\//i,Ot={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"},Nt=["blockquote","br","div","figcaption","figure","h1","h2","h3","h4","h5","h6","hgroup","hr","p","wbr","article","aside","header","footer","main","section","details","summary","nav","dd","dl","dt","li","ol","ul","a","abbr","address","b","bdi","bdo","cite","code","del","dfn","em","i","ins","kbd","mark","pre","q","rp","rt","ruby","s","samp","small","span","strong","sub","sup","time","u","var","acronym","big","center","dir","font","marquee","nobr","plaintext","rb","rtc","strike","tt","img","caption","col","colgroup","table","tbody","td","tfoot","th","thead","tr","style","xmp"].join(","),Dt=["A","B","EM","I","SPAN","STRONG"],Rt=()=>{Mt.collapseBlockquotes()&&[...Lt.content.querySelectorAll("blockquote")].reverse().forEach(e=>{const t=D("details",{class:"sm-bq-switcher"});t.innerHTML="<summary>•••</summary>",e.replaceWith(t),t.append(e)})},Vt=e=>e.replaceWith(...e.childNodes),Ut=/https?:\/\/[^\p{C}\p{Z}]+[^\p{C}\p{Z}.]/gu,_t=/(^|\r|\n|\p{C}\p{Z})((?:[^"(),.:;<>@[\]\\\p{C}\p{Z}]+(?:\.[^"(),.:;<>@[\]\\\p{C}\p{Z}]+)*|"(?:\\?[^"\\\p{C}\p{Z}])*")@[^@\p{C}\p{Z}]+[^@\p{C}\p{Z}.])/giu,qt=/(tel:(\+[0-9().-]+|[0-9*#().-]+(;phone-context=\+[0-9+().-]+)?))/g,Bt=/^(utm_|ec_|fbclid|mc_eid|mkt_tok|_hsenc|vero_id|oly_enc_id|oly_anon_id|__s|Referrer|mailing|elq|bch|trc|ref|correlation_id|pd_|pf_|email_hash)$/i,Kt=(e,t)=>new URL(e).searchParams.get(t)||e,Ht=e=>atob(e.replace(/_/g,"/").replace(/-/g,"+")),Gt=decodeURIComponent,$t=e=>{try{let t=e.replace(/^.+\/(https%253A[^/?&]+).*$/i,(...e)=>Gt(Gt(e[1]))).replace(/tracking\.(printabout\.nl[^?]+)\?.*/i,(...e)=>e[1]).replace(/(zalando\.nl[^?]+)\?.*/i,(...e)=>e[1]).replace(/^.+(awstrack\.me|redditmail\.com)\/.+(https:%2F%2F[^/]+).*/i,(...e)=>Gt(e[2])).replace(/^.+(www\.google|safelinks\.protection\.outlook\.com|mailchimp\.com).+url=.+$/i,()=>Kt(e,"url")).replace(/^.+click\.godaddy\.com.+$/i,()=>Kt(e,"redir")).replace(/^.+delivery-status\.com.+$/i,()=>Kt(e,"fb")).replace(/^.+go\.dhlparcel\.nl.+\/([A-Za-z0-9_-]+)$/i,(...e)=>Ht(e[1])).replace(/^(.+mopinion\.com.+)\?.*$/i,(...e)=>e[1]).replace(/^.+sellercentral\.amazon\.com\/nms\/redirect.+$/i,()=>Ht(Kt(e,"u"))).replace(/^.+amazon\.com\/gp\/r\.html.+$/i,()=>Kt(e,"U")).replace(/^.+\/track\/click\/.+\?p=.+$/i,()=>{let t=Kt(e,"p");try{t=JSON.parse(Ht(t)),t?.p&&(t=JSON.parse(t.p))}catch(e){console.error(e)}return t?.url||e}).replace(/[\s<>]+/gi,"");t=new URL(t);let s=t.searchParams;return[...s.keys()].forEach(e=>Bt.test(e)&&s.delete(e)),t.toString()}catch(t){console.dir({error:t,url:e})}return e},jt=e=>e.trim().replace(/;\s*-[^;]+/g,"").replace(/^\s*-[^;]+(;|$)/g,"").replace(/white-space[^;]+/g,""),Wt=e=>{const t=[];if(t.toString=()=>t.reduce((e,t)=>e+t.selector+" {\n"+("media"===t.type?t.subStyles.toString():t.rules)+"}\n",""),t.applyNamespace=e=>t.forEach(t=>{"media"===t.type?t.subStyles.applyNamespace(e):t.selector=t.selector.split(",").map(t=>(e+" .mail-body "+t.replace(/\./g,".msg-")).replace(/\sbody/gi,"")).join(",")}),e){e=e.replace(/\/\*[\s\S]*?\*\//gi,"").replace(/<!--[\s\S]*?-->/gi,"").replace(/<[\s\S]*/gi,"");let s,i=/(?:(\s*?@(?:media)[\s\S]*?){([\s\S]*?)}\s*?})|(?:([\s\S]*?){([\s\S]*?)})/gi;for(;s=i.exec(e),null!==s;){let e=s[void 0===s[2]?3:1].split("\r\n").join("\n").trim().replace(/\n+/,"\n").split(/\s+/g).map(e=>e.replace(/^(:root|html)$/,"")).join(" ").trim();e.includes("@media")?t.push({selector:e,type:"media",subStyles:Wt(s[2]+"\n}")}):e&&!e.includes("@")&&t.push({selector:e,rules:jt(s[4])})}}return t},Jt=e=>(e?.toString?.()||""+e).replace(It,e=>Ot[e]),zt=(e,t,s)=>{let i;const r=parseInt(Mt.maxBlockquotesLevel()),a={hasExternals:!1,tracking:!1,linkedData:[]},o=!!s,n=e=>t.findByCid(e),l={link:e=>i=e,text:(e,t)=>t.style.color=e,topmargin:(e,t)=>t.style.marginTop=f(e)+"px",leftmargin:(e,t)=>t.style.marginLeft=f(e)+"px",bottommargin:(e,t)=>t.style.marginBottom=f(e)+"px",rightmargin:(e,t)=>t.style.marginRight=f(e)+"px"},c=["data-x-src","name","dir","lang","style","title","background","bgcolor","alt","height","width","src","href","border","bordercolor","charset","direction","download","hreflang","alink","bottommargin","leftmargin","link","rightmargin","text","topmargin","vlink","align","valign","color","face","size","noshade","hspace","sizes","srcset","vspace","low","high","optimum","value","reversed","start","cols","rows","frame","rules","summary","cellpadding","cellspacing","abbr","scope","colspan","rowspan","headers"];Mt.allowStyles()?c.push("class"):s=0,Lt.innerHTML=e.replace(/<(\/?)x-html(\s[^>]*)?>/gi,"").replace(/<(\/?)head(\s[^>]*)?>/gi,"").replace(/<(\/?)body(\s[^>]*)?>/gi,'<$1div class="mail-body"$2>').replace(/<span class="preview-text"[\s\S]+?<\/span>/,"").replace(/\u2028/g," ").replace(/<br>\s*<\/p>/gi,"</p>").trim(),e="";const h=document.createNodeIterator(Lt.content,NodeFilter.SHOW_COMMENT);for(;h.nextNode();)h.referenceNode.remove();Lt.content.querySelectorAll('script[type="application/ld+json"]').forEach(e=>{try{const t=JSON.parse(e.textContent);(d(t)?t:[t]).forEach(e=>a.linkedData.push(e))}catch(t){console.error(t,e.textContent)}}),Lt.content.querySelectorAll("form,button,data").forEach(e=>Vt(e)),Lt.content.querySelectorAll(":not("+Nt+"),a:empty,span:empty"+(0<r?","+new Array(1+r).fill("blockquote").join(" "):"")).forEach(e=>e.remove());let u=Lt.content.querySelector(".mail-body");return[...Lt.content.querySelectorAll(".mail-body + .mail-body")].forEach(e=>u.append(...e.childNodes)),[...Lt.content.querySelectorAll("*")].forEach(e=>{const t=e.tagName,r=e.style;if("STYLE"===t){let t=s?Wt(e.textContent):[];return void(t.length?(t.applyNamespace(s),t=t.toString(),Mt.removeColors()&&(t=t.replace(/(background-)?color:[^};]+;?/g,"")),e.textContent=t):e.remove())}if("XMP"===t){const t=D("pre");return t.innerHTML=Jt(e.innerHTML),void e.replaceWith(t)}if("none"==r.display||"hidden"==r.visibility)return void e.remove();const d=e.className,h=t=>e.hasAttribute(t),u=(t,s)=>e.setAttribute(t,s),p=t=>{let s=(t=>h(t)?e.getAttribute(t).trim():"")(t);return e.removeAttribute(t),s};if("mail-body"===d?g(l,(t,s)=>h(t)&&s(p(t),e)):s&&d&&(e.className=d.replace(/(^|\s+)/g,"$1msg-")),e.hasAttributes()){let t=e.attributes.length;for(;t--;){let s=e.attributes[t].name.toLowerCase();c.includes(s)||"class"===s&&"mail-body"===d||p(s)}}let m;if(r.backgroundImage||"TD"!==t&&"TH"!==t&&(["width","height"].forEach(e=>{h(e)&&(m=p(e),r[e]||(r[e]=m.includes("%")?m:m+"px"))}),m=r.width,100<parseInt(m,10)&&!r.maxWidth&&(r.maxWidth=m,r.width="100%"),m=r.removeProperty("height"),m&&!r.maxHeight&&(r.maxHeight=m)),"A"===t&&(m=e.href,/^([a-z]+):/i.test(m)?(e.href=$t(m),e.href!=m&&(a.tracking=!0,u("data-x-href-tracking",m)),u("target","_blank")):(u("data-x-href-broken",m),p("href")),u("tabindex","-1"),i&&!e.style.color&&(e.style.color=i)),Dt.includes(t)&&""==e.textContent.trim())return void(("A"!==t||!e.querySelector("IMG"))&&Vt(e));let y=!1;if(o&&(m=o&&p("src"),m))if("IMG"===t){let t;if(e.loading="lazy",m.startsWith("cid:"))u("data-x-src",m),m=m.slice(4),t=n(m),t?.download&&(e.src=t.linkPreview(),t.isInline(!0),t.isLinked(!0));else if(t=(e=>{const t=n(e);return t?.contentLocation?t:0})(m))t.download&&(e.src=t.linkPreview(),t.isLinked(!0));else if(r.maxHeight&&3>f(r.maxHeight)||r.maxWidth&&3>f(r.maxWidth)||r.width&&2>f(r.width)||["email.microsoftemail.com/open","github.com/notifications/beacon/","/track/open","google-analytics.com"].filter(e=>m.toLowerCase().includes(e)).length)y=!0,r.display="none",u("data-x-src-hidden",m);else if(Pt.test(m)){let t=$t(m);t!=m&&(a.tracking=!0,u("data-x-src-tracking",m)),u("data-x-src",t),a.hasExternals=!0,e.alt||(e.alt=t.replace(/^.+\/([^/?]+).*$/,"$1").slice(-20))}else m.startsWith("data:image/")?e.src=m:u("data-x-src-broken",m)}else u("data-x-src-broken",m);if(h("background")&&(r.backgroundImage='url("'+p("background")+'")'),h("bgcolor")&&(r.backgroundColor=p("bgcolor")),h("color")&&(r.color=p("color")),!y){r.removeProperty("behavior"),r.removeProperty("cursor"),r.removeProperty("min-width");const e=[],s=[];["backgroundImage","listStyleImage","content"].forEach(i=>{if(r[i]){let o=r[i],l=o.match(/url\s*\(([^)]+)\)/i);if(l){r[i]=null,l=l[1].replace(/^["'\s]+|["'\s]+$/g,"");let c=l.toLowerCase();if(c.startsWith("cid:")){const e=n(l);e?.linkPreview&&t&&(r[i]="url('"+e.linkPreview()+"')",e.isInline(!0),e.isLinked(!0))}else Pt.test(c)?(a.hasExternals=!0,e.push([i,l])):c.startsWith("data:image/")?r[i]=o:s.push([i,l])}}}),e.length&&u("data-x-style-url",JSON.stringify(e)),s.length&&u("data-x-style-broken-urls",JSON.stringify(s)),Mt.removeColors()&&(r.removeProperty("background-color"),r.removeProperty("background-image"),r.removeProperty("color")),r.cssText&&(r.cssText=jt(r.cssText))}}),o&&Rt(),a.html=Lt.innerHTML.trim(),a},Yt=e=>{if(Mt.markdown())return Zt(e);const t="⎯".repeat(64),s=(e,t)=>Lt.content.querySelectorAll(e).forEach(t),i=e=>{let t;for(;t=e.querySelector("blockquote");)i(t),t.replaceWith("\n"+("\n"+t.textContent.replace(/\n{3,}/g,"\n\n").trim()+"\n").replace(/^/gm,"> "))};for(e=e.replace(/<pre[^>]*>([\s\S]*?)<\/pre>/gim,(...e)=>1<e.length?e[1].toString().replace(/\n/g,"<br>"):"").replace(/<br><\/div>/gi,"</div>").replace(/\r?\n/g,"").replace(/\s+/gm," ");/<(div|tr)[\s>]/i.test(e);)e=e.replace(/\n*<(div|tr)(\s[\s\S]*?)?>\n*/gi,"\n");for(;/<\/(div|tr)[\s>]/i.test(e);)e=e.replace(/\n*<\/(div|tr)(\s[\s\S]*?)?>\n*/gi,"\n");return Lt.innerHTML=e.replace(/<t[dh](\s[\s\S]*?)?>/gi,"\t").replace(/<\/tr(\s[\s\S]*?)?>/gi,"\n"),s("style",e=>e.remove()),s("hr",e=>e.replaceWith(`\n\n${t}\n\n`)),s("h1,h2,h3,h4,h5,h6",e=>e.replaceWith(`\n\n${"#".repeat(e.tagName[1])} ${e.textContent}\n\n`)),s("p",e=>{e.prepend("\n\n"),""==e.textContent.trim()?e.remove():e.after("\n\n")}),s("ol,ul",e=>{let t="",s=e,i="OL"==e.tagName,r=0;for(;s=s?.parentNode?.closest?.("ol,ul");)t="    "+t;e.querySelectorAll(":scope > li").forEach(e=>{e.prepend("\n"+t+(i?++r+". ":" * "))}),e.prepend("\n\n"),e.after("\n\n")}),s("a",e=>{let t=e.textContent,s=e.href;return e.replaceWith(t.replace(/[\s()-]+/g,"").includes(s.replace(/^[a-z]:/,"").replace(/[\s()-]+/g,""))?t:t+" "+s+" ")}),s("b,strong",e=>e.replaceWith(`**${e.textContent}**`)),s("i,em",e=>e.replaceWith(`*${e.textContent}*`)),Lt.innerHTML=Lt.innerHTML.replace(/\n{3,}/gm,"\n\n").replace(/\n<br[^>]*>/g,"\n").replace(/<br[^>]*>\n/g,"\n"),s("br",e=>e.replaceWith("\n")),i(Lt.content),(Lt.content.textContent||"").trim()},Zt=e=>(Lt.innerHTML=e,xt.turndown(Lt.content)),Xt=e=>{e=e.toString().replace(/\r/g,"").replace(/^>[> ]>+/gm,([e])=>e?e.replace(/[ ]+/g,""):e).replace(/\u2028/g," ");let t=!1,s=!0,i=!0,r=[],a=e.split("\n");do{s=!1,r=[],a.forEach(e=>{i=">"===e.slice(0,1),i&&!t?(s=!0,t=!0,r.push("~~~blockquote~~~"),r.push(e.slice(1))):!i&&t?e?(t=!1,r.push("~~~/blockquote~~~"),r.push(e)):r.push(e):i&&t?r.push(e.slice(1)):r.push(e)}),t&&(t=!1,r.push("~~~/blockquote~~~")),a=r}while(s);return Lt.innerHTML=a.join("\n").replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(Ut,(...e)=>(e[0]=$t(e[0]),`<a href="${e[0]}" target="_blank">${e[0]}</a>`)).replace(_t,'$1<a href="mailto:$2">$2</a>').replace(qt,'<a href="$1">$1</a>').replace(/~~~blockquote~~~\s*/g,"<blockquote>").replace(/\s*~~~\/blockquote~~~/g,"</blockquote>").replace(/\n/g,"<br>"),Rt(),Lt.innerHTML.trim()};function Qt(e,t){if(null!=e)switch(typeof e){case"boolean":return 0!=t&&!!t;case"number":return t=parseFloat(t),isFinite(t)?t:0;case"string":return null!=t?""+t:"";case"object":if(e.constructor.reviveFromJson)return e.constructor.reviveFromJson(t);if(d(e)&&!d(t))return[]}return t}rl.Utils={cleanHtml:zt,htmlToPlain:Yt,plainToHtml:Xt,htmlToMarkdown:Zt};class AbstractModel{constructor(){Object.defineProperty(this,"disposables",{value:[]})}addObservables(e){Ce(this,e)}addComputables(e){ke(this,e)}addSubscribables(e){g(e,(e,t)=>this.disposables.push(this[e].subscribe(t)))}onDestroy(){this.disposables.forEach(Me),m(this,e=>{(ko.isObservableArray(e)?e():e)?.onDestroy?.()})}static validJson(e){return!(!e||"Object/"+this.name.replace("Model","")!==e["@Object"])}static reviveFromJson(e){let t=this.validJson(e)?new this:null;return t?.revivePropertiesFromJson(e),t}revivePropertiesFromJson(e){const t=this.constructor,s=t.validJson(e);return s&&g(e,(e,s)=>{if("@"!==e[0])try{switch(typeof this[e]){case"function":ko.isObservable(this[e])&&this[e](Qt(this[e](),s));break;case"boolean":case"number":case"object":case"string":this[e]=Qt(this[e],s);break;case"undefined":console.log(`Undefined ${t.name}.${e} set`),this[e]=s}}catch(s){console.log(t.name+"."+e),console.error(s)}}),s}}class EmailModel extends AbstractModel{constructor(e,t,s="none"){super(),this.email=e||"",this.name=t||"",this.dkimStatus=s,this.cleanup()}static reviveFromJson(e){const t=super.reviveFromJson(e);return t?.cleanup(),t?.valid()?t:null}valid(){return this.name||this.email}cleanup(){this.name===this.email&&(this.name="")}toLine(e,t){let s=this.name,i=this.email,r=e=>'<a href="mailto:'+Jt(i)+(s?"?to="+encodeURIComponent('"'+s+'" <'+i+">"):"")+'" target="_blank" tabindex="-1">'+Jt(e||i)+"</a>";return i&&(s?i=e?t?r(s):s:t?Jt('"'+s+'" <')+r()+Jt(">"):'"'+s+'" <'+i+">":t&&(i=r())),i||s}get domain(){return this.email.replace(/^.+@([^@]+)$/,"$1")}}const es=[/=([0-9A-F]{2})/g,(...e)=>String.fromCharCode(parseInt(e[1],16))],ts=atob,ss=e=>e.replace(/=\r?\n/g,"").replace(...es),is=e=>e.replace(/=\?([^?]+)\?(B|Q)\?(.+?)\?=/g,(e,t,s,i)=>rs(t,"B"==s?ts(i):ss(i))),rs=(e,t)=>{try{return new TextDecoder(e).decode(Uint8Array.from(t,e=>e.charCodeAt(0)))}catch(t){console.error({charset:e,error:t})}};function as(e){e=(e||"").toString();let t="",s={type:"text",value:""},i=!1,r=[],a=[];const o={'"':'"',"(":")","<":">",",":"",":":";",";":""},n=e=>{e.value=(e.value||"").toString().trim(),e.value.length&&r.push(e),s={type:"text",value:""},i=!1},l=()=>{r.length&&(r=function(e){let t=!1,s={},i=[],r={email:[],comment:[],group:[],text:[]};e.forEach(e=>{t=t||"group"===e.type,r[e.type].push(e.value)}),!r.text.length&&r.comment.length&&(r.text=r.comment,r.comment=[]);if(t)i=i.concat(as(r.group.join(",")));else{if(!r.email.length&&r.text.length){for(var a=r.text.length;a--;)if(r.text[a].match(/^[^@\s]+@[^@\s]+$/)){r.email=r.text.splice(a,1);break}if(!r.email.length)for(a=r.text.length;a--&&(r.text[a]=r.text[a].replace(/\s*\b[^@\s]+@[^@\s]+\b\s*/,e=>r.email.length?e.trim():(r.email=[e.trim()],"")),!r.email.length););}!r.text.length&&r.comment.length&&(r.text=r.comment,r.comment=[]),r.email.length>1&&(r.text=r.text.concat(r.email.splice(1))),s={email:is(r.email.join(" ").trim()),name:is(r.text.join(" ").trim())},s.email===s.name&&(s.email.includes("@")?s.name="":s.email=""),i.push(s)}return i}(r),r.length&&(a=a.concat(r))),r=[]};return[...e].forEach(e=>{i||e!==t&&(t||!(e in o))?(s.value+=e,i=!i&&"\\"===e):(n(s),","===e||";"===e?l():(t=t?"":o[e],"<"===e?s.type="email":"("===e?s.type="comment":":"===e&&(s.type="group")))}),n(s),l(),a}const os=e=>e?.emailaddress?.key;let ns,ls;class EmailAddressesComponent{constructor(e,t){ls||(ls=D("datalist",{id:"emailaddresses-datalist"}),A.body.append(ls));const s=this,i=D("input",{type:"text",list:ls.id,autocomplete:"off",autocorrect:"off",autocapitalize:"off"}),r=()=>ns?.li.parentNode!==s.ul,a=e=>r()&&e.preventDefault();s.element=e,s.options=Object.assign({focusCallback:null,autoCompleteSource:"",onChange:null},t),s._chosenValues=[],s._lastEdit="",s.ul=D("ul",{class:"emailaddresses"}),K(s.ul,{click:e=>s._focus(e),dblclick:e=>s._editTag(e),dragenter:a,dragover:a,drop:e=>{r()&&ns.value&&(e.preventDefault(),ns.source._removeDraggedTag(ns.li),s._parseValue(ns.value))}}),s.input=i,K(i,{focus:()=>{s._focusTrigger(!0),i.value||s._resetDatalist()},blur:()=>{s._parseInput(!0),s._focusTrigger(!1)},keydown:e=>{if("Backspace"===e.key||"ArrowLeft"===e.key){var t=s.inputCont.previousElementSibling;t&&(!i.value||"selectionStart"in i&&0===i.selectionStart&&0===i.selectionEnd)&&(e.preventDefault(),t.querySelector("a").focus()),s._updateDatalist()}else"Enter"==e.key&&(e.preventDefault(),s._parseInput(!0))},input:()=>{s._parseInput(),s._updateDatalist()}}),e.placeholder&&(i.placeholder=e.placeholder),s.inputCont=D("li",{class:"emailaddresses-input"}),s.inputCont.append(i),s.ul.append(s.inputCont),e.replaceWith(s.ul),e.value.trim()&&s._parseValue(e.value),s._updateDatalist=s.options.autoCompleteSource?(()=>{let e=i.value.trim();ls.inputValue!==e&&(ls.inputValue=e,e.length&&s.options.autoCompleteSource(e,t=>{s._resetDatalist();let r=e.length;t?.forEach(e=>{ls.append(new Option(e)),r=Math.max(r,e.length)}),r*=8,i.clientWidth<r&&(i.style.width=r+"px")}))}).throttle(500):()=>0}_focusTrigger(e){this.ul.classList.toggle("emailaddresses-focused",e),this.options.focusCallback(e)}_resetDatalist(){ls.textContent=""}_parseInput(e){let t=this.input.value;(e||t.includes(",")||t.includes(";")||" "===t.charAt(t.length-1)&&this._simpleEmailMatch(t))&&this._parseValue(t)&&(this.input.value=""),this._resizeInput()}_parseValue(e){if(e){const t=this,s=e.trim(),i=((s&&[",",";","\n"].includes(s.slice(-1))?(e=>{const t=[];let s=!1;return as(e).forEach(e=>{const i=e.name||e.email?new EmailModel(e.email,e.name):null;i?.email&&(s=!0),t.push(i?i.toLine():e.name)}),s?t:null})(e):null)||[e]).map(e=>as(e).map(e=>e.name||e.email?new EmailModel(e.email,e.name):null).filter(e=>e)).flat(1/0).map(e=>e.toLine?[e.toLine(),e]:[e,null]);if(i.length)return i.forEach(e=>{var s=e[0].trim(),i=!1,r=-1,a={key:"",obj:null,value:""};t._chosenValues.forEach((e,a)=>{e.value===t._lastEdit&&(r=a),i|=e.value===s}),""!==s&&e[1]&&!i&&(a.key="mi_"+Math.random().toString(16).slice(2,10),a.value=s,a.obj=e[1],-1<r?t._chosenValues.splice(r,0,a):t._chosenValues.push(a),t._lastEdit="",t._renderTags())}),1===i.length&&""===i[0]&&""!==t._lastEdit&&(t._lastEdit="",t._renderTags()),t._setValue(t._buildValue()),!0}}_resizeInput(){let e=this.input;e.clientWidth<e.scrollWidth&&(e.style.width=e.scrollWidth+20+"px")}_editTag(e){var t=e.target.closest("li"),s=os(t);if(!s)return!0;var i=this,r="",a=null,o=!1;i._chosenValues.forEach(e=>{e.key===s?(r=e.value,o=!0):o&&!a&&(a=e)}),a&&(i._lastEdit=a.value),t.after(i.inputCont),i.input.value=r,setTimeout(()=>i.input.select(),100),i._removeTag(e,t),i._resizeInput(e)}_buildValue(){return this._chosenValues.map(e=>e.value).join(",")}_setValue(e){this.element.value!==e&&(this.element.value=e,this.options.onChange(e))}_simpleEmailMatch(e){const t=e.trim();return/^[^@]*<[^\s@]{1,128}@[^\s@]{1,256}\.[\w]{2,32}>$/g.test(t)||/^[^\s@]{1,128}@[^\s@]{1,256}\.[\w]{2,32}$/g.test(t)}_renderTags(){let e=this;[...e.ul.children].forEach(t=>t!==e.inputCont&&t.remove()),e._chosenValues.forEach(t=>{if(t.obj){let s=D("li",{title:t.obj.toLine(),draggable:"true"}),i=D("span");i.append(t.obj.toLine(!0)),s.append(i),i=D("a",{href:"#",class:"ficon"}),i.append("✖"),K(i,{click:t=>e._removeTag(t,s),focus:()=>s.className="emailaddresses-selected",blur:()=>s.className=null,keydown:t=>{switch(t.key){case"Delete":case"Backspace":e._removeTag(t,s);break;case"e":case"Enter":e._editTag(t);break;case"ArrowLeft":var r=i.closest("li").previousElementSibling;r.matches("li")?r.querySelector("a").focus():e.focus();break;case"ArrowRight":var a=i.closest("li").nextElementSibling;a!==this.inputCont?a.querySelector("a").focus():this.focus();break;case"ArrowDown":e._focus(t)}}}),s.append(i),s.emailaddress=t,K(s,{dragstart:t=>{ns={source:e,li:s,value:s.emailaddress.obj.toLine()},t.dataTransfer.setData("text/plain","snappymail/emailaddress"),t.dataTransfer.effectAllowed="move",s.style.opacity=.25},dragend:()=>{ns=null,s.style.cssText=""}}),e.inputCont.before(s)}})}_removeTag(e,t){e.preventDefault();var s=os(t),i=this,r=i._chosenValues.findIndex(e=>s===e.key);r>-1&&i._chosenValues.splice(r,1),i._setValue(i._buildValue()),t.remove(),setTimeout(()=>i.input.focus(),100)}_removeDraggedTag(e){var t=os(e),s=this,i=s._chosenValues.findIndex(e=>t===e.key);-1<i&&(s._chosenValues.splice(i,1),s._setValue(s._buildValue())),e.remove()}focus(){this.input.focus()}blur(){this.input.blur()}_focus(e){var t=e.target.closest("li");os(t)?t.querySelector("a").focus():this.focus()}set value(e){var t=this;t.element.value!==e&&(t._chosenValues=[],t._renderTags(),t._parseValue(t.element.value=e))}}let cs=null,ds=null,hs=e=>!!ds?.canPlayType(e).replace("no",""),us=window.AudioContext||window.webkitAudioContext,ps=(e,t)=>{ds&&(ds.src=e,ds.play(),t=t.trim(),R("audio.start",t.replace(/\.([a-z0-9]{3})$/,"")||"audio"))},ms=()=>{try{const e=new Audio;if(e.canPlayType&&e.pause&&e.play)return e.preload="none",e.loop=!1,e.autoplay=!1,e.muted=!1,e}catch(e){console.error(e)}return null},gs=["click","dblclick","contextmenu","auxclick","mousedown","mouseup","pointerup","touchstart","touchend","keydown","keyup"],fs=()=>{gs.forEach(e=>A.removeEventListener(e,fs,!0)),us&&(console.log("AudioContext "+us.state),us.resume())};us&&(us=us?new us:null,us.onstatechange=fs),gs.forEach(e=>A.addEventListener(e,fs,!0));const ys=new class{constructor(){if(ds||(ds=ms()),this.supported=!!ds,this.supportedMp3=hs("audio/mpeg;"),this.supportedWav=hs('audio/wav; codecs="1"'),this.supportedOgg=hs('audio/ogg; codecs="vorbis"'),ds){const e=()=>this.pause();B(ds,["ended","error"],e),addEventListener("audio.api.stop",e)}Ce(this,{notifications:!1})}paused(){return!ds||ds.paused}stop(){this.pause()}pause(){ds?.pause(),R("audio.stop")}playMp3(e,t){this.supportedMp3&&ps(e,t)}playOgg(e,t){this.supportedOgg&&ps(e,t)}playWav(e,t){this.supportedWav&&ps(e,t)}playNotification(e,t){(e||this.notifications())&&("running"==us.state&&(this.supportedMp3||this.supportedOgg)?(cs=cs||ms(),cs&&(cs.src=ee("sounds/"+F("NotificationSound")+(this.supportedMp3?".mp3":".ogg")),cs.volume=t?.01:1,cs.play())):console.log("No audio: "+us.state))}};class AbstractCollectionModel extends Array{constructor(){super()}onDestroy(){this.forEach(e=>e.onDestroy?.())}static reviveFromJson(e,t){const s=new this;return e&&("Collection/"+this.name.replace("Model","")===e["@Object"]&&(g(e,(e,t)=>"@"!==e[0]&&(s[e]=t)),e=e["@Collection"]),d(e)&&e.forEach(e=>{e&&t&&(e=t(e,s)),e&&s.push(e)})),s}}class EmailCollectionModel extends AbstractCollectionModel{static reviveFromJson(e){return super.reviveFromJson(e,e=>EmailModel.reviveFromJson(e))}static fromString(e){let t=new this;return t.fromString(e),t}toString(e,t){return this.map(s=>s.toLine(e,t)).join(", ")}fromString(e){if(e){let t,s={};as(e).forEach(e=>{e=new EmailModel(e.email,e.name),t=e.email||e.name,!t||!e.name&&s[t]||(s[t]=e)}),m(s,e=>this.push(e))}}}class AttachmentModel extends AbstractModel{constructor(){super(),this.checked=ko.observable(!0),this.mimeType="",this.fileName="",this.fileNameExt="",this.fileType=_e,this.cId="",this.contentLocation="",this.folder="",this.uid="",this.url="",this.mimeIndex="",this.estimatedSize=0,Ce(this,{isInline:!1,isLinked:!1})}static reviveFromJson(e){const t=super.reviveFromJson(e);return t&&(t.fileNameExt=Qe.getExtension(t.fileName),t.fileType=Qe.getType(t.fileNameExt,t.mimeType)),t}toggleChecked(e,t){V(t),e.checked(!e.checked())}friendlySize(){return Qe.friendlySize(this.estimatedSize)+(this.isLinked()?" 🔗":"")}contentId(){return this.cId.replace(/^<+|>+$/g,"")}isImage(){return $e===this.fileType}isMp3(){return je===this.fileType&&"mp3"===this.fileNameExt}isOgg(){return je===this.fileType&&("oga"===this.fileNameExt||"ogg"===this.fileNameExt)}isWav(){return je===this.fileType&&"wav"===this.fileNameExt}isText(){return qe===this.fileType||Ke===this.fileType}pdfPreview(){return null!=navigator.mimeTypes["application/pdf"]&&Ge===this.fileType}hasPreview(){return this.isImage()||this.pdfPreview()||this.isText()}hasPreplay(){return ys.supportedMp3&&this.isMp3()||ys.supportedOgg&&this.isOgg()||ys.supportedWav&&this.isWav()}get download(){return S(this.url?{fileName:this.fileName,data:this.url.replace(/^.+,/,"")}:{folder:this.folder,uid:this.uid,mimeIndex:this.mimeIndex,mimeType:this.mimeType,fileName:this.fileName,accountHash:F("accountHash")})}linkDownload(){return this.url||Z(this.download)}linkPreview(){return this.url||Y("View",this.download)}hasThumbnail(){return x("AttachmentThumbnails")&&this.isImage()&&!this.isLinked()}thumbnailStyle(){return this.hasThumbnail()?"background:url("+Y("ViewThumbnail",this.download)+")":null}linkPreviewMain(){let e="";switch(!0){case this.isImage():case this.pdfPreview():e=this.linkPreview();break;case this.isText():e=Y("ViewAsPlain",this.download)}return e}eventDragStart(e,t){const s=t.originalEvent||t;if(e&&s&&s.dataTransfer&&s.dataTransfer.setData){let e=this.linkDownload();e.startsWith("http")||(e=location.protocol+"//"+location.host+location.pathname+e),s.dataTransfer.setData("DownloadURL",this.mimeType+":"+this.fileName+":"+e)}return!0}iconClass(){return this.fileType}}class AttachmentCollectionModel extends AbstractCollectionModel{static reviveFromJson(e){const t=super.reviveFromJson(e,e=>AttachmentModel.reviveFromJson(e));let s=we(!0);return t.sort((e,t)=>{if(e.isInline()){if(!t.isInline())return 1}else if(!t.isInline())return-1;return s.compare(e.fileName,t.fileName)}),t}findByCid(e){return e=e.replace(/^<+|>+$/g,""),this.find(t=>e===t.contentId())}}class MimeHeaderModel extends AbstractModel{constructor(){super(),this.name="",this.value="",this.parameters=ko.observableArray()}}class MimeHeaderCollectionModel extends AbstractCollectionModel{static reviveFromJson(e){return super.reviveFromJson(e,e=>MimeHeaderModel.reviveFromJson(e))}getByName(e){return e=e.toLowerCase(),this.find(t=>t.name.toLowerCase()===e)}valueByName(e){const t=this.getByName(e);return t?t.value:""}valuesByName(e){return e=e.toLowerCase(),this.filter(t=>t.name.toLowerCase()===e).map(e=>e.value)}}let bs=null,Ss="";const vs=new Map,ws=e=>e.querySelector("[autofocus]")?.focus(),Es=new Set,As=e=>e&&vs.get(e)||null,Cs=(e,t)=>{if(e&&!e.__vm){const s=new e(t),i=s.viewModelTemplateID,r="rl-"+s.viewType,a=Fs===s.viewType,o=A.getElementById(r);if(o){e.__vm=s,console.log(a);let t=a&&"PopupsCompose"!=i?D("dialog",{id:"V-"+i}):D("div",{id:"V-"+i,hidden:""});if(o.append(t),s.viewModelDom=t,a){t.showModal||(t.className="polyfill",t.showModal=()=>{t.backdrop||t.before(t.backdrop=D("div",{class:"dialog-backdrop"})),t.setAttribute("open",""),t.open=!0,t.backdrop.hidden=!1},t.close=()=>{t.backdrop.hidden=!0,t.removeAttribute("open",null),t.open=!1});const e=e=>{e.target===t&&"opacity"===e.propertyName&&(t.classList.contains("animate")?(s.afterShow?.(),R("rl-vm-visible",s)):(t.close(),s.afterHide?.()))};s.modalVisible.subscribe(e=>{e?(he(t),Es.add(s),t.style.zIndex=3001+2*Es.size,t.showModal(),t.backdrop&&(t.backdrop.style.zIndex=3e3+2*Es.size),s.keyScope.set(),setTimeout(()=>ws(t),1),requestAnimationFrame(()=>{t.offsetHeight,t.classList.add("animate"),"PopupsCompose"==i&&(t.classList.add("active"),history.pushState({},"","/apps/f7mail/#/new-letter/"),document.querySelectorAll("#rl-menu ul.menu li.active").forEach(e=>e.classList.remove("active")),document.querySelectorAll("#rl-menu ul.menu li")[0]?.classList.add("active"))})):"PopupsAsk"!=i&&(Es.delete(s),s.onHide?.(),s.keyScope.unset(),t.classList.remove("animate"),"PopupsCompose"==i&&(t.classList.remove("active"),history.pushState({},"","/apps/f7mail/#/mailbox/"),document.querySelectorAll("#rl-menu ul.menu li.active").forEach(e=>e.classList.remove("active")),document.querySelectorAll("#rl-menu ul.menu li")[1]?.classList.add("active"))),xs(0<Es.size)}),t.addEventListener("transitionend",e)}R("rl-view-model.create",s),ko.applyBindingAccessorsToNode(t,{template:()=>({name:i})},s),s.onBuild?.(t),R("rl-view-model",s)}else console.log("Cannot find view model position: "+r)}return e?.__vm},ks=(e,t)=>{e.viewModels.forEach(e=>{e.__vm&&Fs!==e.__vm.viewType&&t(e.__vm,e.__vm.viewModelDom)})},Ts=(e,t)=>{e.onHide?.(),ks(e,(e,s)=>{s.hidden=!0,e.onHide?.(),t&&s.remove()}),ut.isMobile()&&O(!0)},Ms=(e,t)=>{if((e=e||Ss)&&R("sm-show-screen",e+(t?"/"+t:""),1)){for(let e of Es)e.tryToClose();let s=As(e);if(s||(s=As(Ss),s&&(t=e+"/"+t,e=Ss)),s?.__started){let e=bs&&s===bs;s.__builded||(s.__builded=!0,s.viewModels.forEach(e=>Cs(e,s)),s.onBuild?.()),setTimeout(()=>{bs&&!e&&Ts(bs),bs=s,e||(s.onShow?.(),ks(s,(e,t)=>{e.beforeShow?.(),he(t),t.hidden=!1,e.onShow?.(),ws(t)})),s.__cross?.parse(t)},1)}}},Fs="popups",Ls=(e,t=[])=>{const s=Cs(e);s&&(t=t||[],s.beforeShow?.(...t),s.modalVisible(!0),s.onShow?.(...t))},xs=ko.observable(!1),Is=e=>{hasher.clear(),vs.forEach(e=>Ts(e,1)),vs.clear(),bs=null,Ss="",e.forEach(e=>{const t=new e,s=t.screenName;Ss||(Ss=s),vs.set(s,t)}),vs.forEach(e=>{e.__started||(e.onStart(),e.__started=!0)});const t=new Crossroads;t.addRoute(/^([^/]*)\/?(.*)$/,Ms),hasher.add(t.parse.bind(t)),hasher.init(),setTimeout(()=>C.remove("rl-started-trigger"),100);const s=k("rl-content"),i=k("rl-loading");s&&(s.hidden=!1),i?.remove()},Ps=(e,t)=>g(t,(t,s)=>{let i=e[t],r=(...t)=>r.canExecute()&&i.apply(e,t);r.canExecute=Ae(()=>s.call(e,e)),e[t]=r});ko.decorateCommands=Ps;const Os={allowContacts:()=>!!F("contactsAllowed")};Ce(Os,{focusedState:"none",threadsAllowed:!1}),Os.focusedState.subscribe(e=>{["FolderList","MessageList","MessageView"].forEach(t=>{t===e&&(xs()||G(e),ut.isMobile()&&O("FolderList"!==e)),k("V-Mail"+t).classList.toggle("focused",t===e)})});let Ns=0;const Ds=(e="")=>Q("Json")+p(e),Rs=e=>{const t=e?e.code:null;c.InvalidToken===t?(console.error(fe(t)+` (${e.messageAdditional})`),setTimeout(rl.logoutReload,5e3)):[c.AuthError,c.ConnectionError,c.DomainNotAllowed,c.AccountNotAllowed,c.MailServerError,c.UnknownError].includes(t)&&7<++Ns&&rl.logoutReload()},Vs={},Us=(e,t,s)=>{let i=Vs[e];Vs[e]=null,i&&(clearTimeout(i.timeoutId),s||i.abort(new DOMException(e,t||"AbortError")))},_s=(e,t,s,i,r)=>{s&&(s instanceof FormData?s.set("Action",e):s.Action=e);const a=new AbortController,o=a.signal;return Vs[e]=a,a.timeoutId=i&&setTimeout(()=>Us(e,"TimeoutError"),i),rl.fetchJSON(t,{signal:o},s).then(t=>(Us(e,0,1),r?r(t):Promise.resolve(t))).catch(e=>(clearTimeout(a.timeoutId),e.aborted=o.aborted,Promise.reject(e)))};class FetchError extends Error{constructor(e,t){super(t),this.code=e||c.JsonFalse}}class AbstractFetchRemote{abort(e,t){return Us(e,t),this}streamPerLine(e,t,s){rl.fetch(Ds(t),{},s).then(e=>e.body).then(t=>{let s="";const i=t.getReader(),r=/\r\n|\n|\r/gm,a=new TextDecoder,o=({done:t,value:n})=>{for(s+=n?a.decode(n,{stream:!0}):"";;){let a=r.exec(s);if(!a){if(t)break;return void i.read().then(o)}e(s.slice(0,a.index)),s=s.slice(a.index+1),r.lastIndex=0}s.length&&e(s)};i.read().then(o)})}request(e,t,s,i,r){s=s||{};const a=Date.now();_s(e,Ds(r),r?null:s||{},f(i??3e4),async o=>{let n=0;if(o&&(o.Result?Ns=0:(Rs(o),n=o.code||c.UnknownError)),111===n&&rl.app.ask&&await rl.app.ask.cryptkey())return this.request(e,t,s,i,r);t&&t(n,o,o?.epoch&&o.epoch<Math.floor(a/1e3)-60)}).catch(e=>{console.error({fetchError:e}),t&&t("TimeoutError"==e.name?3:"AbortError"==e.name?2:1,e)})}setTrigger(e,t){e&&(t=!!t,(d(e)?e:[e]).forEach(e=>{e?.(t)}))}get(e,t){return _s(e,t)}post(e,t,s,i){return this.setTrigger(t,!0),_s(e,Ds(),s||{},f(i,3e4),async r=>(Us(e,0,1),r?111===r?.code&&rl.app.ask&&await rl.app.ask.cryptkey()?this.post(e,t,s,i):(this.setTrigger(t,!1),r.Result&&e===r.Action?r:(Rs(r),Promise.reject(new FetchError(r?r.code:0,r?r.messageAdditional||r.message:"")))):Promise.reject(new FetchError(c.JsonParse))))}}Object.assign(AbstractFetchRemote.prototype,{SUCCESS:0,ERROR:1,ABORT:2});var qs=new class RemoteUserFetch extends AbstractFetchRemote{message(e,t,s){return t=p(t),s=f(s),!!(Et(t)&&0<s)&&(this.abort("Message").request("Message",e,{},null,"Message/&q[]=/"+S([t,s,Os.threadsAllowed()&&Mt.useThreads()?1:0,F("accountHash")])),!0)}saveSettings(e,t){this.request("SettingsUpdate",e,t)}saveSetting(e,t,s){this.saveSettings(s,{[e]:t})}};function Bs(e){class MimePart{header(e){return this.headers?.[e]}headerValue(e){return this.header(e)?.value}get raw(){return e.slice(this.start,this.end)}get bodyRaw(){return e.slice(this.bodyStart,this.bodyEnd)}get body(){let e=this.bodyRaw,t=this.header("content-type")?.params.charset,s=this.headerValue("content-transfer-encoding")?.toLowerCase();return"quoted-printable"==s?e=ss(e):"base64"==s&&(e=ts(e.replace(/\r?\n/g,""))),rs(t,e)}get dataUrl(){let e=this.bodyRaw,t=this.headerValue("content-transfer-encoding")?.toLowerCase();return"base64"==t?e=e.replace(/\r?\n/g,""):("quoted-printable"==t&&(e=ss(e)),e=btoa(unescape(encodeURIComponent(e)))),"data:"+this.headerValue("content-type")+";base64,"+e}forEach(e){e(this),this.parts.forEach(t=>t.forEach(e))}getByContentType(e){if(e==this.headerValue("content-type")?.toLowerCase())return this;let t,s=0,i=this.parts;for(;s<i.length;++s)if(t=i[s].getByContentType(e))return t}}const t=["from","reply-to","to","cc","bcc"],s=(e,i=0,r="")=>{let a=new MimePart,o=e.match(/^[\s\S]+?\r?\n\r?\n/)?.[0],n={};if(r&&(a.id=r,a.start=i,a.end=i+e.length),a.parts=[],o){o.replace(/\r?\n\s+/g," ").split(/\r?\n/).forEach(e=>{let s=e.match(/^([^:]+):\s*([^;]+)/),i={};if(s){[...e.matchAll(/;\s*([^;=]+)=\s*"?([^;"]+)"?/g)].forEach(e=>i[e[1].trim().toLowerCase()]=e[2].trim());let r=s[1].trim().toLowerCase();t.includes(r)?s[2]=as(s[2]):"keywords"===r?(s[2]=s[2].split(",").forEach(e=>is(e.trim())),s[2]=(n[r]?.value||[]).concat(s[2])):(s[2]=is(s[2].trim()),"comments"===r&&(s[2]=(n[r]?.value||[]).push(s[2]))),n[r]={value:s[2],params:i}}}),a.bodyStart=i+o.length,a.bodyEnd=i+e.length;let l=n["content-type"]?.params.boundary;if(l){a.boundary=l;let t=new RegExp("(?:^|\r?\n)--"+RegExp.escape(l)+"(?:--)?(?:\r?\n|$)","g"),i=e.slice(o.length),n=i.split(t),c=a.bodyStart;[...i.matchAll(t)].forEach(([e],t)=>{t||(a.bodyText=n[0]),"--"!=e.trim().slice(-2)&&(c+=n[t].length+e.length,a.parts.push(s(n[1+t],c,(r?r+".":"")+(1+t))))})}a.headers=n}return a};return s(e)}class AbstractView{constructor(e,t){this.viewModelTemplateID=e||this.constructor.name.replace("UserView",""),this.viewType=t,this.viewModelDom=null,this.keyScope={scope:"none",previous:"none",set:function(){this.previous=G(),G(this.scope)},unset:function(){G(this.previous)}}}querySelector(e){return this.viewModelDom.querySelector(e)}addObservables(e){Ce(this,e)}addComputables(e){ke(this,e)}addSubscribables(e){Te(this,e)}}class AbstractViewPopup extends AbstractView{constructor(e){super("Popups"+e,Fs),this.keyScope.scope=e,this.modalVisible=ko.observable(!1).extend({rateLimit:0}),this.close=()=>this.modalVisible(!1),this.tryToClose=()=>!1===this.onClose()||this.close(),_("escape,close","",e,()=>(this.modalVisible()&&this.tryToClose(),!1))}onClose(){}}AbstractViewPopup.showModal=function(e=[]){Ls(this,e)},AbstractViewPopup.hidden=function(){return!this.__vm||!this.__vm.modalVisible()};class AbstractViewLeft extends AbstractView{constructor(e){super(e,"left"),this.toggleLeftPanel=N}}class AbstractViewRight extends AbstractView{constructor(e){super(e,"right")}}class AbstractViewSettings{addSetting(e,t){let s=e[0].toLowerCase()+e.slice(1),i=s+"Trigger";Ce(this,{[s]:F(e),[i]:o}),Te(this,{[s]:(s=>{this[i](a),t?.(s),rl.app.Remote.saveSetting(e,s,e=>{this[i](e?l:n),setTimeout(()=>this[i](o),1e3)})}).debounce(999)})}addSettings(e){e.forEach(e=>{let t=e[0].toLowerCase()+e.slice(1);this[t]||(this[t]=ko.observable(F(e))),this[t].subscribe(t=>rl.app.Remote.saveSetting(e,t))})}}class AbstractViewLogin extends AbstractView{constructor(e){super(e,"content"),this.formError=ko.observable(!1).extend({falseTimeout:500})}onBuild(e){e.classList.add("LoginView")}onShow(){k("rl-left").hidden=!0,k("rl-right").hidden=!0,rl.route.off()}onHide(){k("rl-left").hidden=!1,k("rl-right").hidden=!1}submitForm(){}}class OpenPgpKeyPopupView extends AbstractViewPopup{constructor(){super("OpenPgpKey"),Ce(this,{key:"",keyDom:null})}selectKey(){const e=this.keyDom();if(e){let t=getSelection(),s=A.createRange();t.removeAllRanges(),s.selectNodeContents(e),t.addRange(s)}navigator.clipboard&&navigator.clipboard.writeText(this.key()).then(()=>console.log("Copied to clipboard"),e=>console.error(e))}onShow(e){this.key(e?e.armor:"")}onBuild(){_("a","meta","OpenPgpKey",()=>(this.selectKey(),!1))}}class AskPopupView extends AbstractViewPopup{constructor(){super("Ask"),Ce(this,{askDesc:"",yesButton:"",noButton:"",username:"",askUsername:!1,passphrase:"",askPass:!1,remember:!0,askRemeber:!1}),this.fYesAction=null,this.fNoAction=null,this.focusOnShow=!0}yesClick(){this.close(),document.querySelector("#V-PopupsAsk").classList.remove("animate"),u(this.fYesAction)&&this.fYesAction(this)}noClick(){this.close(),document.querySelector("#V-PopupsAsk").classList.remove("animate"),u(this.fNoAction)&&this.fNoAction(this)}onShow(e,t=null,s=null,i=!0,r=0,a=""){this.askDesc(e||""),this.askUsername(2&r),this.askPass(1&r),this.askRemeber(4&r),this.username(""),this.passphrase(""),this.remember(!0),this.yesButton(de(a||"GLOBAL/YES")),this.noButton(de(r?"GLOBAL/CANCEL":"GLOBAL/NO")),this.fYesAction=t,this.fNoAction=s,this.focusOnShow=i?r?'input[type="'+(2&r?"text":"password")+'"]':".buttonYes":""}afterShow(){this.focusOnShow&&this.querySelector(this.focusOnShow).focus()}onClose(){return this.noClick(),!1}onBuild(){shortcuts.add("tab,arrowright,arrowleft","","Ask",()=>{let e=this.querySelector(".buttonYes"),t=this.querySelector(".buttonNo");return e.matches(":focus")?(t.focus(),!1):t.matches(":focus")?(e.focus(),!1):void 0})}}const Ks=new WeakMap;Ks.ask=async(e,t,s)=>Ks.has(e)?{password:Ks.handle(e)}:await AskPopupView.password(t,s,5);const Hs={};Ks.handle=(e,t)=>{const s=Mt.keyPassForget();return s&&!Hs[e]&&(Hs[e]=(()=>Ks.delete(e)).debounce(1e3*s)),t&&Ks.set(e,t),s&&Hs[e](),Ks.get(e)};const Gs=(e,t)=>e.find(e=>(e.can_sign||e.can_decrypt)&&(e.for(t)||e.subkeys.find(e=>t==e.keyid||t==e.fingerprint))),$s=new class{constructor(){this.keyring,this.publicKeys=ko.observableArray(),this.privateKeys=ko.observableArray()}loadKeyrings(){this.keyring=null,this.publicKeys([]),this.privateKeys([]),x("GnuPG")&&qs.request("GnupgGetKeys",(e,t)=>{if(t?.Result){this.keyring=t.Result;const e=(e,t)=>{const s=[];return e.id=e.subkeys[0].keyid,e.fingerprint=e.subkeys[0].fingerprint,e.uids.forEach(e=>e.email&&s.push(e.email)),e.emails=s,e.for=e=>s.includes(IDN.toASCII(e)),e.askDelete=ko.observable(!1),e.openForDeletion=ko.observable(null).askDeleteHelper(),e.remove=()=>{e.askDelete()&&qs.request("GnupgDeleteKey",(s,i)=>{i&&(s?alert(i.message):i.Result&&(t?this.privateKeys.remove(e):this.publicKeys.remove(e)))},{keyId:e.id,isPrivate:t})},t&&(e.password=async t=>{const s=await Ks.ask(e,"GnuPG key<br>"+e.id+" "+e.emails[0],t);return s&&s.remember&&Ks.handle(e,s.password),s?.password}),e.fetch=async s=>{if(e.armor)s&&s();else{let i=t?await e.password("OPENPGP/POPUP_VIEW_TITLE"):"";if(null!=i)try{const r=await qs.post("GnupgExportKey",null,{keyId:e.id,isPrivate:t,passphrase:i});r?.Result?(e.armor=r.Result,s&&s()):Ks.delete(e)}catch(t){Ks.delete(e),alert(t.message)}}return e.armor},e.view=()=>e.fetch(()=>Ls(OpenPgpKeyPopupView,[e])),e},s=we(),i=e=>e.sort((e,t)=>s.compare(e.emails[0],t.emails[0])||s.compare(e.id,t.id));this.publicKeys(i(t.Result.public.map(t=>e(t,0)))),this.privateKeys(i(t.Result.private.map(t=>e(t,1)))),console.log("gnupg ready")}})}isSupported(){return x("GnuPG")}storeKeyPair(e,t){qs.request("PgpStoreKeyPair",(e,s)=>{t?.(e,s)},e)}hasPublicKeyForEmails(e){const t=e.length,s=t?e.filter(e=>this.publicKeys.find(t=>t.for(e))).length:0;return s&&s===t}getPublicKeyFingerprints(e){const t=[];return e.forEach(e=>{t.push(this.publicKeys.find(t=>t.for(e)).fingerprint)}),t}getPrivateKeyFor(e){return Gs(this.privateKeys,e)}async decrypt(e){const t=e.pgpEncrypted();if(t){let s,i=[e.to[0].email].concat(t.keyIds),r=i.length;for(;r--&&(s=Gs(this.privateKeys,i[r]),!s););if(s){let i={folder:e.folder,uid:e.uid,partId:t.partId,keyId:s.id,passphrase:await s.password("CRYPTO/DECRYPT"),data:""};if(null!=i.passphrase)try{const e=await qs.post("GnupgDecrypt",null,i);if(e?.Result?.data)return e.Result;throw e}catch(e){throw Ks.delete(s),e}}}}async verify(e){let t=e.pgpSigned();if(t){t={...t},t.folder=e.folder,t.uid=e.uid,t.bodyPart&&(t.bodyPart=t.bodyPart.raw,t.sigPart=t.sigPart.body);let s=await qs.post("PgpVerifyMessage",null,t);if(s?.Result)return{fingerprint:s.Result.fingerprint,success:0==s.Result.status,error:s.Result.message}}}async sign(e){return await e.password("CRYPTO/SIGN")}},js=()=>!!window.openpgp,Ws=(e,t)=>e.find(e=>e.for(t)||t==e.id||t==e.fingerprint),Js=async(e,t="SIGN")=>{if(e.key.isDecrypted())return e.key;const s=e.id,i=await Ks.ask(e,"OpenPGP.js key<br>"+s+" "+e.emails[0],"CRYPTO/"+t);if(i){const t=i.password,s=await openpgp.decryptKey({privateKey:e.key,passphrase:t});return s&&i.remember&&Ks.handle(e,t),s}},zs=we(),Ys=e=>e.sort((e,t)=>zs.compare(e.emails[0],t.emails[0])||zs.compare(e.id,t.id)),Zs=e=>Ys((e||[]).filter((e,t,s)=>s.findIndex(t=>t.fingerprint==e.fingerprint)===t)),Xs="openpgp-public-keys",Qs="openpgp-private-keys",ei=window.localStorage,ti=async e=>{let t,s=[],i=JSON.parse(ei.getItem(e)),r=h(i);for(;r--;)try{t=await openpgp.readKey({armoredKey:i[r]}),t.err||s.push(new OpenPgpKeyModel(i[r],t))}catch(e){console.error(e)}return s},si=(e,t)=>{let s=e.map(e=>e.armor);s.length?ei.setItem(t,JSON.stringify(s)):ei.removeItem(t)};class OpenPgpKeyModel{constructor(e,t){this.key=t,this.id=t.getKeyID().toHex().toUpperCase(),this.fingerprint=t.getFingerprint(),this.can_encrypt=!!t.getEncryptionKey(),this.can_sign=!!t.getSigningKey(),this.emails=t.users.map(e=>IDN.toASCII(e.userID.email)).filter(e=>e),this.armor=e,this.askDelete=ko.observable(!1),this.openForDeletion=ko.observable(null).askDeleteHelper()}for(e){return this.emails.includes(IDN.toASCII(e))}view(){Ls(OpenPgpKeyPopupView,[this])}remove(){this.askDelete()&&(this.key.isPrivate()?(ii.privateKeys.remove(this),si(ii.privateKeys,Qs)):(ii.publicKeys.remove(this),si(ii.publicKeys,Xs)))}}const ii=new class{constructor(){this.publicKeys=ko.observableArray(),this.privateKeys=ko.observableArray()}loadKeyrings(){js()&&ti(Xs).then(e=>{this.publicKeys(Zs(e)),console.log("openpgp.js public keys loaded")}).finally(()=>{ti(Qs).then(e=>{this.privateKeys(Zs(e)),console.log("openpgp.js private keys loaded")}).finally(()=>{this.loadBackupKeys()})})}loadBackupKeys(){qs.request("GetPGPKeys",(e,t)=>!e&&t.Result&&this.importKeys(t.Result))}isSupported(){return js()}importKey(e){this.importKeys([e])}async importKeys(e){if(js()){const t=this.privateKeys(),s=this.publicKeys();for(const i of e)try{let e=await openpgp.readKey({armoredKey:i});if(!e.err){e=new OpenPgpKeyModel(i,e);const r=e.key.isPrivate()?t:s;r.find(t=>t.fingerprint==e.fingerprint)||r.push(e)}}catch(e){console.error(e,i)}this.privateKeys(Ys(t)),this.publicKeys(Ys(s)),si(t,Qs),si(s,Xs)}}storeKeyPair(e){js()&&(openpgp.readKey({armoredKey:e.publicKey}).then(t=>{this.publicKeys.push(new OpenPgpKeyModel(e.publicKey,t)),si(this.publicKeys,Xs)}),openpgp.readKey({armoredKey:e.privateKey}).then(t=>{this.privateKeys.push(new OpenPgpKeyModel(e.privateKey,t)),si(this.privateKeys,Qs)}))}hasPublicKeyForEmails(e){const t=e.length,s=t?e.filter(e=>this.publicKeys().find(t=>t.for(e))).length:0;return s&&s===t}getPrivateKeyFor(e){return Ws(this.privateKeys,e)}async decrypt(e,t){const s=await openpgp.readMessage({armoredMessage:e}),i=this.privateKeys(),r=s.getEncryptionKeyIDs().map(e=>e.bytes);let a,o=i.length;for(;o--;)if((await i[o].key.getDecryptionKeys()).find(e=>r.includes(e.getKeyID().bytes))){a=i[o];break}if(a)try{const e=await Js(a,"DECRYPT");if(e){const i=Ws(this.publicKeys,t);return await openpgp.decrypt({message:s,verificationKeys:i?.key,decryptionKeys:e})}}catch(e){alert(e),console.error(e)}}async verify(e){const t=e.pgpSigned(),s=this.publicKeys().find(t=>t.for(e.from[0].email));if(t&&s){let i;if(t.folder=e.folder,t.uid=e.uid,t.tryGnuPG=0,i=t.sigPartId?await qs.post("PgpVerifyMessage",null,t):t.bodyPart?{Result:{text:t.bodyPart.raw,signature:t.sigPart.body}}:{Result:{text:e.plain(),signature:null}},i){const e=i.Result.signature?await openpgp.readSignature({armoredSignature:i.Result.signature}):null,t=e?await openpgp.createMessage({text:i.Result.text}):await openpgp.readCleartextMessage({cleartextMessage:i.Result.text});let r=await openpgp.verify({message:t,verificationKeys:s.key,signature:e});return{fingerprint:s.fingerprint,success:r&&!!r.signatures.length}}}}async sign(e,t,s){const i=await Js(t);if(i){const t=s?await openpgp.createMessage({text:e}):await openpgp.createCleartextMessage({text:e});return await openpgp.sign({message:t,signingKeys:i,detached:!!s})}throw"Sign cancelled"}async encrypt(e,t,s){const i=t.length;if(t=t.map(e=>this.publicKeys().find(t=>t.for(e))).filter(e=>e),i===t.length){if(s&&!(s=await Js(s)))return;return await openpgp.encrypt({message:await openpgp.createMessage({text:e}),encryptionKeys:t.map(e=>e.key),signingKeys:s})}throw"Encrypt failed"}};let ri=null;const ai={keyring:null,loadKeyring(e){if(e=e||F("Email"),window.mailvelope){const t=e=>{ri=e,console.log("mailvelope ready")};mailvelope.getKeyring().then(t,s=>{e?mailvelope.createKeyring(e).then(t,e=>console.error(e)):console.error(s)}),addEventListener("mailvelope-disconnect",e=>{alert("Mailvelope is updated to version "+e.detail.version+". Reload page")},!1)}else addEventListener("mailvelope",()=>this.loadKeyring(e))},async hasPublicKeyForEmails(e){const t=ri&&await ri.validKeyForAddress(e),s=t&&Object.entries(t);return s&&s.filter(e=>e[1]).length===e.length},getPrivateKeyFor:async e=>!(!ri||!await ri.hasPrivateKey({email:e}))&&["mailvelope",e],async decrypt(e){if(ri){const t=e.from[0].email,s=e.plain();try{let i=[...e.from,...e.to,...e.cc].validUnique(),r=i.length;for(;r--;)if(await this.getPrivateKeyFor(i[r].email)){const i=e.body;i.textContent="";let r=await mailvelope.createDisplayContainer("#"+i.id,s,ri,{senderAddress:t});if(r){if(!r.error?.message)return i.classList.add("mailvelope"),!0;"PWD_DIALOG_CANCEL"!==r.error.code&&alert(r.error.code+": "+r.error.message)}break}}catch(e){console.error(e)}}}},oi="-----BEGIN PGP MESSAGE-----",ni=new class{init(){x("OpenPGP")&&window.crypto&&crypto.getRandomValues?rl.loadScript(F("StaticLibsJs").replace("/libs.","/openpgp.")).then(()=>this.loadKeyrings()).catch(e=>{this.loadKeyrings(),console.error(e)}):this.loadKeyrings()}loadKeyrings(e){ai.loadKeyring(e),ii.loadKeyrings(),$s.loadKeyrings()}isSupported(){return!!(ii.isSupported()||$s.isSupported()||window.mailvelope)}isEncrypted(e){return 0===e.trim().indexOf(oi)}importKey(e,t,s){(t||s)&&qs.request("PgpImportKey",(e,s)=>{t&&s?.Result&&$s.loadKeyrings(),e&&alert(s.message)},{key:e,gnuPG:t,backup:s}),ii.importKey(e)}hasPublicKeyForEmails(e){if(e.length){if($s.hasPublicKeyForEmails(e))return"gnupg";if(ii.hasPublicKeyForEmails(e))return"openpgp"}return!1}async decrypt(e){const t=e.plain();if(!this.isEncrypted(t))throw Error("Not armored text");if(ii.isSupported()){const s=e.from[0].email;let i=await ii.decrypt(t,s);if(i)return i}return await ai.decrypt(e)||$s.decrypt(e)}async verify(e){const t=e.pgpSigned(),s=e.from[0].email;if(t){if(!t.sigPartId&&ii.hasPublicKeyForEmails([s]))return ii.verify(e);if($s.hasPublicKeyForEmails([s]))return $s.verify(e)}}getPublicKeyOfEmails(e){if(e.length){let t={};return e.forEach(e=>{ii.publicKeys().forEach(s=>{s.for(e)&&(t[e]=s.armor)}),$s.publicKeys.map(async s=>{!t[e]&&s.for(e)&&(t[e]=await s.fetch())})}),t}return!1}};function li(e,t){const s=Bs(e);if(s.headers){let e=s.getByContentType("text/html"),i=s.headerValue("subject");e=e?e.body:"",i&&t.subject(i),["from","to"].forEach(e=>{const i=t[e];s.headerValue(e)?.forEach(e=>{((e=new EmailModel(e.email,e.name)).email&&e.name||!i.find(t=>t.email==e.email))&&i.push(e)})}),s.forEach(s=>{let i=s.header("content-disposition"),r=s.header("content-id"),a=s.header("content-type");if(r||i){let o=new AttachmentModel;if(o.mimeType=a.value,o.fileName=a.name||i&&i.params.filename||"",o.fileNameExt=o.fileName.replace(/^.+(\.[a-z]+)$/,"$1"),o.fileType=Qe.getType("",a.value),o.url=s.dataUrl,o.estimatedSize=s.body.length,o.cId=r?r.value:"",r&&e){let t="cid:"+o.contentId(),s=e.includes(t);o.isInline(s),o.isLinked(s),s&&(e=e.replace('src="'+t+'"','src="'+o.url+'"').replace("src='"+t+"'","src='"+o.url+"'"))}else t.attachments.push(o)}else if("multipart/signed"===a.value){let e=a.params.protocol;"application/pgp-signature"===e?t.pgpSigned({micAlg:a.micalg,bodyPart:s.parts[0],sigPart:s.parts[1]}):"application/pkcs7-signature"===e.replace("x-")&&t.smimeSigned({micAlg:a.micalg,bodyPart:s,sigPart:s.parts[1],detached:!0})}else"application/pkcs7-mime"===a.value&&t.smimeSigned({micAlg:a.micalg,bodyPart:s,detached:!1})});const r=s.getByContentType("text/plain");t.plain(r?r.body:""),t.html(e)}else t.plain(e);t.plain().includes(oi)&&t.pgpSigned(!0)}const ci=xe();ci.loading=ko.observable(!1).extend({debounce:100}),ci.main=Ae(()=>{const e=ci();return d(e)?e.find(e=>e&&!e.id()):null});const di="<html>\n<head>\n\t<meta charset=\"utf-8\">\n\t<title></title>\n\t<style>\nhtml, body {\n\tmargin: 0;\n\tpadding: 0;\n}\n\nheader {\n\tbackground: rgba(125,128,128,0.3);\n\tborder-bottom: 1px solid #888;\n}\n\nheader h1 {\n\tfont-size: 120%;\n}\n\nheader * {\n\tmargin: 5px 0;\n}\n\nheader time {\n\tfloat: right;\n}\n\nblockquote {\n\tborder-left: 2px solid rgba(125,128,128,0.5);\n\tmargin: 0;\n\tpadding: 0 0 0 10px;\n}\n\npre {\n\twhite-space: pre-wrap;\n\tword-wrap: break-word;\n\tword-break: normal;\n}\n\nbody > * {\n\tpadding: 0.5em 1em;\n}\n\n#attachments > * {\n\tborder: 1px solid rgba(125,128,128,0.5);\n\tpadding: 0.25em;\n\tmargin-right: 1em;\n}\n#attachments > *::before {\n\tcontent: '📎 ';\n}\n\t</style>\n</head>\n<body></body>\n</html>",hi=e=>zt(e.html(),e.attachments(),"#rl-msg-"+e.hash),ui=(e,t)=>{const s=t.toLowerCase(),i=e.flags,r=i.includes(s);qs.request("MessageSetKeyword",e=>{e||(r?i.remove(s):i.push(s))},{folder:e.folder,uids:e.uid,keyword:t,setAction:r?0:1})},pi=(e,t,s)=>e.forEach(e=>t[e.email]||s.has(e.email)||s.set(e.email,e));class MessageModel extends AbstractModel{constructor(){super(),Object.assign(this,{folder:"",uid:0,hash:"",from:new EmailCollectionModel,to:new EmailCollectionModel,cc:new EmailCollectionModel,bcc:new EmailCollectionModel,sender:new EmailCollectionModel,replyTo:new EmailCollectionModel,deliveredTo:new EmailCollectionModel,body:null,draftInfo:[],dkim:[],spf:[],dmarc:[],messageId:"",inReplyTo:"",references:"",hasVirus:null,priority:3,senderEmailsString:"",senderClearEmailsString:"",isSpam:!1,spamScore:0,spamResult:"",size:0,readReceipt:"",preview:null,attachments:ko.observableArray(new AttachmentCollectionModel),threads:ko.observableArray(),threadUnseen:ko.observableArray(),unsubsribeLinks:ko.observableArray(),flags:ko.observableArray(),headers:ko.observableArray(new MimeHeaderCollectionModel)}),Ce(this,{subject:"",plain:"",html:"",dateTimestamp:0,dateTimestampSource:0,focused:!1,selected:!1,checked:!1,isHtml:!1,hasImages:!1,hasExternals:!1,hasTracking:!1,encrypted:!1,pgpSigned:null,pgpEncrypted:null,pgpDecrypted:!1,smimeSigned:null,smimeEncrypted:null,smimeDecrypted:!1,id:"",linkedData:[]}),ke(this,{attachmentIconClass:()=>this.encrypted()?"icon-lock":Qe.getAttachmentsIconClass(this.attachments()),threadsLen:()=>rl.app.messageList.threadUid()?0:this.threads().length,threadUnseenLen:()=>rl.app.messageList.threadUid()?0:this.threadUnseen().length,threadsLenText:()=>{const e=this.threadUnseenLen();return this.threadsLen()+(e>0?"/"+e:"")},isUnseen:()=>!this.flags().includes("\\seen"),isFlagged:()=>this.flags().includes("\\flagged"),isDeleted:()=>this.flags().includes("\\deleted"),tagOptions:()=>{const e=[];return Tt.currentFolder().optionalTags().forEach(t=>{let s=t.toLowerCase();e.push({css:"msgflag-"+s,value:t,checked:this.flags().includes(s),label:de("MESSAGE_TAGS/"+s,0,t),toggle:()=>ui(this,t)})}),e},whitelistOptions:()=>{let e=[];if("match"===Mt.viewImages()){let t=this.from[0],s=Mt.viewImagesWhitelist(),i={};this.html().match(/src=["'][^"']+/g)?.forEach(t=>{t=t.replace(/^.+(:\/\/[^/]+).+$/,"$1"),i[t]?++i[t]:(i[t]=1,e.push(t))}),e=e.filter(e=>!s.includes(e)).sort((e,t)=>i[e]<i[t]?1:i[e]>i[t]?-1:e.localeCompare(t)),t&&e.unshift(t.email)}return e}}),this.smimeSigned.subscribe(e=>e?.body&&li(e.body,this))}get requestHash(){return S({folder:this.folder,uid:this.uid,mimeType:Ie,fileName:(this.subject()||"message")+"-"+this.hash+".eml",accountHash:F("accountHash")})}toggleTag(e){ui(this,e)}spamStatus(){let e=this.spamResult;return e?de(this.isSpam?"GLOBAL/SPAM":"GLOBAL/NOT_SPAM")+": "+e:""}friendlySize(){return Qe.friendlySize(this.size)}computeSenderEmail(){const e=this[[Tt.sentFolder(),Tt.draftsFolder()].includes(this.folder)?"to":"from"];this.senderEmailsString=e.toString(!0),this.senderClearEmailsString=e.map(e=>e?.email).filter(e=>e).join(", ")}revivePropertiesFromJson(e){if(super.revivePropertiesFromJson(e)){this.computeSenderEmail();let e,t=this.headers();return e=t.valueByName("X-MSMail-Priority")||t.valueByName("Importance")||t.valueByName("X-Priority"),e&&(/[h12]/.test(e[0])?this.priority=1:/[l45]/.test(e[0])&&(this.priority=5)),(e=t.valueByName("List-Unsubscribe"))&&this.unsubsribeLinks(e.split(",").map(e=>e.replace(/^[ <>]+|[ <>]+$/g,""))),t.valueByName("X-Virus")&&(this.hasVirus=!0),(e=t.valueByName("X-Virus-Status"))&&(e.includes("infected")?this.hasVirus=!0:e.includes("clean")&&(this.hasVirus=!1)),!0}}lineAsCss(e=1){let t=[];return g({selected:this.selected(),checked:this.checked(),unseen:this.isUnseen(),focused:this.focused(),priorityHigh:1===this.priority,withAttachments:!!this.attachments().length},(e,s)=>s&&t.push(e)),e&&this.flags().forEach(e=>t.push("msgflag-"+e)),t.join(" ")}indent(){return this.level?"margin-left:"+this.level+"em":null}viewRaw(){return Y("ViewAsPlain",this.requestHash)}downloadLink(){return Y("Download",this.requestHash)}replyEmails(e){const t=new Map,s=e||{};return pi(this.replyTo,s,t),t.size||pi(this.from,s,t),t.size?[...t.values()]:[this.to[0]]}replyAllEmails(e){const t=new Map,s=new Map,i=e||{};return pi(this.replyTo,i,t),t.size||pi(this.from,i,t),pi(this.to,i,t),pi(this.cc,i,s),[[...t.values()],[...s.values()]]}viewBody(e){const t=this.body;if(t){if(e){let e=hi(this);this.hasExternals(e.hasExternals),this.hasImages(!!e.hasExternals),this.hasTracking(!!e.tracking),this.linkedData(e.linkedData),t.innerHTML=e.html,this.isSpam||Tt.spamFolder()==this.folder||("always"===Mt.viewImages()&&this.showExternalImages(),"match"===Mt.viewImages()&&this.showExternalImages(1))}else t.innerHTML=Xt(this.plain()?this.plain().replace(/-----BEGIN PGP (SIGNED MESSAGE-----(\r?\n[^\r\n]+)+|SIGNATURE-----[\s\S]*)/gs,"").trim():Yt(t.innerHTML||hi(this).html)),this.hasImages(!1);return t.classList.toggle("html",e),t.classList.toggle("plain",!e),this.isHtml(e),!0}}viewHtml(){return this.html()&&this.viewBody(!0)}viewPlain(){return this.viewBody(!1)}swapColors(){const e=this.body?.classList;e&&e.toggle("swapColors")}popupMessage(e){const t=this.dateTimestamp()||0,s=this.cc.toString(),i=this.bcc.toString(),r=0<t?new Date(1e3*t):null,a=open("","sm-msg-"+this.requestHash,Mt.messageNewWindow()?"innerWidth="+k("V-MailMessageView").clientWidth:""),o=a.document,n=Jt(this.subject()),l=this.isHtml()?"div":"pre",c=`<div>${Jt(de("GLOBAL/TO"))}: ${Jt(this.to)}</div>`+(s?`<div>${Jt(de("GLOBAL/CC"))}: ${Jt(s)}</div>`:"")+(i?`<div>${Jt(de("GLOBAL/BCC"))}: ${Jt(i)}</div>`:""),d=getComputedStyle(A.querySelector(".messageView")),h=e=>d.getPropertyValue(e);let u="";this.attachments.forEach(e=>{u+=`<a href="${e.linkDownload()}">${e.fileName}</a>`}),o.write(di.replace("<title>","<title>"+n).replace("<body>",`<body style="background-color:${h("background-color")};color:${h("color")}"><header><h1>${n}</h1><time>${Jt(r?r.format("LLL",0,ie.hourCycle()):"")}</time><div>${Jt(this.from)}</div>${c}</header><${l}>${this.bodyAsHTML()}</${l}>`).replace("</body>",`<div id="attachments">${u}</div></body>`)),o.close(),!0===e&&setTimeout(()=>a.print(),100)}printMessage(){this.popupMessage(!0)}showExternalImages(e){const t=this.body;if(t&&this.hasImages()){e&&(e=[],Mt.viewImagesWhitelist().trim().split(/[\s\r\n,;]+/g).forEach(t=>{(t=t.split("+"))[0]=t[0].trim(),!t[0]||t.includes("spf")&&"pass"!==this.spf[0]?.[0]||t.includes("dkim")&&"pass"!==this.dkim[0]?.[0]||t.includes("dmarc")&&"pass"!==this.dmarc[0]?.[0]||e.push(t[0].replace(/[/\-\\^$*+?.()|[\]{}]/g,"\\$&"))}),(e=e.join("|").replace(/\|+/g,"|"))&&(console.log("whitelist images = "+e),e=new RegExp(e),this.from[0]?.email.match(e)&&(e=null)));let s,i=!1,r=t=>{if(null==e||e&&t.match(e))return!0;i=!0},a="data-x-src",o=!!F("proxyExternalImages");t.querySelectorAll("img["+a+"]").forEach(e=>{s=e.getAttribute(a),r(s)&&(e.src=o?X(s):s)}),t.querySelectorAll("[data-x-style-url]").forEach(e=>{JSON.parse(e.dataset.xStyleUrl).forEach(t=>{r(t[1])&&(e.style[t[0]]="url('"+(o?X(t[1]):t[1])+"')")})}),this.hasImages(i)}}bodyAsHTML(){if(this.body){let e=this.body.cloneNode(!0);return e.querySelectorAll(".sm-bq-switcher").forEach(e=>e.replaceWith(e.lastElementChild)),(e.querySelector(".mail-body")||e).innerHTML}return hi(this).html||Xt(this.plain())}async decrypt(){const e=this;return e.pgpEncrypted()&&!e.pgpDecrypted()?await e.pgpDecrypt().then(()=>e.pgpDecrypted()):!(e.smimeEncrypted()&&!e.smimeDecrypted())||await e.smimeDecrypt().then(()=>e.smimeDecrypted())}async pgpDecrypt(){const e=this,t=e.pgpEncrypted();delete t.error,await ni.decrypt(e).then(t=>{if(!t)throw Error("Decryption failed, canceled or not possible");e.pgpDecrypted(!0),t.data&&(li(t.data,e),e.html()?e.viewHtml():e.viewPlain(),t.signatures?.length&&e.pgpSigned({signatures:t.signatures,success:!!t.signatures.length}))}).catch(e=>{t.error=e.message}).finally(()=>{e.pgpEncrypted(t)})}pgpVerify(){const e=this;ni.verify(e).then(t=>{t?e.pgpSigned(t):alert("Verification failed or no valid public key found")})}async smimeDecrypt(){const e=this,t=e.from.concat(e.to,e.cc,e.bcc).map(e=>e.email),s=ci.find(e=>t.includes(e.email)),i=e.smimeEncrypted();if(i&&s){delete i.error;let t,r={...i};if(r.folder=e.folder,r.uid=e.uid,r.certificate=s.smimeCertificate(),r.privateKey=s.smimeKey(),s.smimeKeyEncrypted()){if(t=await Ks.ask(s,de("SMIME/PRIVATE_KEY_OF",{EMAIL:s.email}),"CRYPTO/DECRYPT"),!t)return;r.passphrase=t?.password}await qs.post("SMimeDecryptMessage",null,r).then(i=>{i?.Result?.data&&(e.smimeDecrypted(!0),li(i.Result.data,e),e.html()?e.viewHtml():e.viewPlain(),t&&t.remember&&Ks.handle(s,t.password),"signed"in i.Result&&e.smimeSigned(i.Result.signed))}).catch(e=>{i.error=e.message}).finally(()=>{e.smimeEncrypted(i)})}}smimeVerify(){const e=this,t=e.smimeSigned();if(t){const s={...t};s.folder=e.folder,s.uid=e.uid,s.bodyPart=t.bodyPart?.raw,s.sigPart=t.sigPart?.bodyRaw,qs.post("SMimeVerifyMessage",null,s).then(s=>{s?.Result&&(s.Result.body&&(li(s.Result.body,e),e.html()?e.viewHtml():e.viewPlain()),t.success=s.Result.success,e.smimeSigned(t))})}}}const mi=()=>(A.fullscreenElement||A.webkitFullscreenElement)===T,gi=()=>mi()&&(A.exitFullscreen||A.webkitExitFullscreen).call(A),fi=ko.observable(!1),yi=()=>fi()?gi():T.requestFullscreen();if(T){let e="fullscreenchange";!T.requestFullscreen&&T.webkitRequestFullscreen&&(T.requestFullscreen=T.webkitRequestFullscreen,e="webkit"+e),T.requestFullscreen&&A.addEventListener(e,()=>{fi(mi()),C.toggle("rl-fullscreen",mi())})}const bi=new class{constructor(){Ce(this,{message:null,error:"",loading:!1,bodiesDom:null}),Te(this,{message:t=>{clearTimeout(this.MessageSeenTimer),k("rl-right").classList.toggle("message-selected",!!t),t?Mt.usePreviewPane()||Os.focusedState(s):(Os.focusedState(e),gi()),[...this.bodiesDom()?.children||[]].forEach(e=>e.hidden=!0)}}),this.purgeCache=this.purgeCache.throttle(3e4)}purgeCache(e){const t=this.bodiesDom()?.children||[];let s=Math.max(0,t.length-(e?0:15));for(;s--;)t[s].remove(),t[s].message&&(t[s].message.body=null)}};class MessageCollectionModel extends AbstractCollectionModel{static reviveFromJson(e){let t=bi.message();return super.reviveFromJson(e,e=>(t&&t.hash===e.hash?(t.revivePropertiesFromJson(e),e=t):e=MessageModel.reviveFromJson(e),e))}}const Si=xe();Ce(Si,{email:"",loading:!1});const vi=window.Notification,wi=()=>vi?.permission||"denied",Ei=()=>"denied"===wi(),Ai=()=>"granted"===wi(),Ci=e=>{focus(),e.folder&&e.uid?R("mailbox.message.show",e):e.Url&&hasher.setHash(e.Url)};let ki=!1,Ti=navigator.serviceWorker;Ti?ServiceWorkerRegistration&&ServiceWorkerRegistration.prototype.showNotification?Ti.addEventListener("message",e=>{const t=JSON.parse(e.data);"notificationclick"===t?.action&&Ci(t.data)}):(console.log("ServiceWorkerRegistration.showNotification undefined"),Ti=null):console.log("ServiceWorker undefined");const Mi=new class{constructor(){Ce(this,{enabled:!1,allowed:!Ei()}),this.enabled.subscribe(e=>{ki=!!e,e&&vi&&!Ai()&&vi.requestPermission(()=>this.allowed(!Ei()))})}display(e,t,s,i){if(ki&&Ai()){const r={body:t,icon:i||ee("images/icon-message-notification.png"),data:s};if(s?.uid&&(r.tag=s.uid),Ti)Ti.register(ee("js/serviceworker.js"),{scope:"/"}).then(()=>Ti.ready.then(t=>t.showNotification(e,r).then(()=>t.getNotifications().then(()=>{t.active.postMessage("")})))).catch(e=>{console.error(e),Ti=null});else{const t=new vi(e,r);t.show?.(),t.onclick=s?()=>Ci(s):null,setTimeout(()=>t.close(),7e3)}}}},Fi=e=>e.checked(),Li=e=>e.isDeleted(),xi=e=>{rl.route.off(),hasher.replaceHash(e),rl.route.on()},Ii=ko.observable(!1).extend({falseTimeout:500}),Pi=ko.observableArray().extend({debounce:0});let Oi;Ce(Pi,{count:0,listSearch:"",listLimited:0,threadUid:0,page:1,pageBeforeThread:1,error:"",endHash:"",endThreadUid:0,loading:!1,isIncomplete:!1,selectedMessage:null,focusedMessage:null}),ke(Pi,{isLoading:()=>{const e=Pi.loading()|Pi.isIncomplete();return C.toggle("list-loading",e),e},isArchiveFolder:()=>Tt.archiveFolder()===Pi().folder,isDraftFolder:()=>Tt.draftsFolder()===Pi().folder,isSentFolder:()=>Tt.sentFolder()===Pi().folder,isSpamFolder:()=>Tt.spamFolder()===Pi().folder,isTrashFolder:()=>Tt.trashFolder()===Pi().folder,archiveAllowed:()=>![gt,Pi().folder].includes(Tt.archiveFolder())&&!Pi.isDraftFolder(),canMarkAsSpam:()=>!(gt===Tt.spamFolder()|Pi.isSentFolder()|Pi.isDraftFolder()|Pi.isSpamFolder()),pageCount:()=>Math.max(1,Math.ceil(Pi.count()/Mt.messagesPerPage())),mainSearch:{read:Pi.listSearch,write:e=>hasher.setHash(se(Tt.currentFolderFullNameHash(),1,e.toString().trim(),Pi.threadUid()))},listCheckedOrSelected:()=>{const e=Pi.selectedMessage(),t=Pi.filter(e=>Fi(e));return t.length?t:e?[e]:[]},listCheckedOrSelectedUidsWithSubMails:()=>{let e=new Set;return Pi.listCheckedOrSelected().forEach(t=>{e.add(t.uid),e.folder=t.folder,1<t.threadsLen()&&t.threads().forEach(e.add,e)}),e}}),Pi.listChecked=Ae(()=>Pi.filter(Fi)).extend({rateLimit:0}),Pi.hasChecked=Ae(()=>!!Pi.find(Fi)).extend({rateLimit:0}),Pi.hasCheckedOrSelected=Ae(()=>!!Pi.selectedMessage()|!!Pi.find(Fi)).extend({rateLimit:50}),Pi.hasCheckedOrSelectedAndDeleted=Ae(()=>!!Pi.listCheckedOrSelected().find(Li)).extend({rateLimit:50}),Pi.hasCheckedOrSelectedAndUndeleted=Ae(()=>!!Pi.listCheckedOrSelected().find(e=>!e?.isDeleted())).extend({rateLimit:50}),Pi.notifyNewMessages=(e,t)=>{if(St()===e&&h(t)){ys.playNotification();const e=t.length;3<e?Mi.display(Si.email(),de("MESSAGE_LIST/NEW_MESSAGE_NOTIFICATION",{COUNT:e}),{Url:se(t[0].folder)}):t.forEach(e=>{Mi.display(EmailCollectionModel.reviveFromJson(e.from).toString(),e.subject,{folder:e.folder,uid:e.uid})})}},Pi.canSelect=()=>!Ii()&&Mt.usePreviewPane(),Pi.reload=(e=!1,t=!1)=>{let s=(Pi.page()-1)*Mt.messagesPerPage(),i=Tt.currentFolderFullName();t&&wt(i,""),e&&(Pi.page(1),Pi.pageBeforeThread(1),s=0,xi(se(Tt.currentFolderFullNameHash(),Pi.page(),Pi.listSearch(),Pi.threadUid()))),Oi!=i&&(Oi=i,Pi([])),Pi.loading(!0);let r="",a=Et(i),o=a?.etag||"",n={folder:i,offset:s,limit:Mt.messagesPerPage(),uidNext:a?.uidNext||0,sort:Tt.sortMode(),search:Pi.listSearch()};Os.threadsAllowed()&&Mt.useThreads()?(n.useThreads=1,n.threadAlgorithm=Mt.threadAlgorithm(),n.threadUid=Pi.threadUid()):n.threadUid=0,o&&(n.hash=o+"-"+F("accountHash"),r="MessageList/&q[]=/"+S(n),n={}),qs.abort("MessageList","reload").request("MessageList",(e,t,s)=>{let i="";if(e)"reload"!=t?.name&&(i=fe(e),Pi.loading(!1));else{const e=MessageCollectionModel.reviveFromJson(t.Result,s);if(e){const t=e.folder,i=Et(t.name);if(e.folder=t.name,i&&!s){i.expires=Date.now(),i.uidNext=t.uidNext,i.etag=t.etag,null!=t.totalEmails&&i.totalEmails(t.totalEmails),null!=t.unreadEmails&&i.unreadEmails(t.unreadEmails);let s=t.permanentFlags||[];if(s.includes("\\*")){let e=6;for(;--e;)s.includes("$label"+e)||s.push("$label"+e)}i.permanentFlags(s.sort(we().compare)),Pi.notifyNewMessages(i.fullName,e.newMessages)}Pi.count(e.totalEmails),Pi.listSearch(p(e.search)),Pi.listLimited(!!e.limited),Pi.page(Math.ceil(e.offset/Mt.messagesPerPage()+1)),Pi.threadUid(e.threadUid),Pi.endHash(t.name+"|"+e.search+"|"+Pi.threadUid()+"|"+Pi.page()),Pi.endThreadUid(e.threadUid);const r=bi.message();if(r&&t.name!==r.folder&&bi.message(null),Ii(!0),e.threadUid){let t={};e.forEach(e=>{e.level=0,e.inReplyTo&&t[e.inReplyTo]&&(e.level=1+t[e.inReplyTo].level),t[e.messageId]=e})}Pi(e),Pi.isIncomplete(!1)}else Pi.count(0),Pi([]),i=fe(c.CantGetMessageList);Pi.loading(!1)}Pi.error(i)},n,6e4,r)},Pi.setAction=(e,t,s)=>{s=s||Pi.listChecked();let i,r,a=[];if(t==rt?s.forEach(e=>{e.isUnseen()&&a.push(e.uid)&&(e.flags.push("\\seen"),e.threads().length>0&&e.threadUnseen().includes(e.uid)&&e.threadUnseen.remove(e.uid))}):t==at?s.forEach(e=>{!e.isUnseen()&&a.push(e.uid)&&(e.flags.remove("\\seen"),e.threads().length>0&&!e.threadUnseen().includes(e.uid)&&e.threadUnseen.push(e.uid))}):t==ot?s.forEach(e=>!e.isFlagged()&&a.push(e.uid)&&e.flags.push("\\flagged")):t==nt?s.forEach(e=>e.isFlagged()&&a.push(e.uid)&&e.flags.remove("\\flagged")):t==lt?s.forEach(e=>!e.isDeleted()&&a.push(e.uid)&&e.flags.push("\\deleted")):t==ct&&s.forEach(e=>e.isDeleted()&&a.push(e.uid)&&e.flags.remove("\\deleted")),a=a.validUnique(),r=a.length,e&&r)switch(t){case rt:r=-r;case at:i=Et(e),i&&i.unreadEmails(Math.max(0,i.unreadEmails()+r)),qs.request("MessageSetSeen",null,{folder:e,uids:a.join(","),setAction:t==rt?1:0});break;case ot:case nt:qs.request("MessageSetFlagged",null,{folder:e,uids:a.join(","),setAction:t==ot?1:0});break;case lt:case ct:qs.request("MessageSetDeleted",null,{folder:e,uids:a.join(","),setAction:t==lt?1:0})}},Pi.moveMessages=(e,t,s="",i=!1)=>{const r=Et(e);if(!r||!t?.size)return;let a=0,o=0,n=bi.message();const l=s?Et(s):null,c=Tt.trashFolder(),d=Tt.spamFolder(),u=Pi.page(),p=Tt.currentFolderFullName()===e?Pi.filter(e=>e&&t.has(e.uid)):[],m=(e,s)=>{e?(wt(Tt.currentFolderFullName(),""),alert(fe(e))):Tt.currentFolder()&&(2===h(s.Result)?wt(s.Result[0],s.Result[1]):wt(Tt.currentFolderFullName(),""),Pi.count(Pi.count()-t.size),u>Pi.pageCount()&&(o=Pi.pageCount()),o&&(Pi.page(o),xi(se(Tt.currentFolderFullNameHash(),o,Pi.listSearch(),Pi.threadUid()))),Pi.reload(!Pi.count()))};if(p.forEach(e=>e?.isUnseen()&&++a),i||(r.etag="",r.totalEmails(Math.max(0,r.totalEmails()-t.size)),r.unreadEmails(Math.max(0,r.unreadEmails()-a))),l&&(l.etag="",l.totalEmails(l.totalEmails()+t.size),c!==l.fullName&&d!==l.fullName&&l.unreadEmails(l.unreadEmails()+a),l.actionBlink(!0)),p.length)if(Ii(!0),i)p.forEach(e=>e.checked(!1));else{if(Pi.isIncomplete(!0),n&&1==p.length&&Mt.showNextMessage()){let e=Pi.indexOf(n)+1;0<e&&(e=Pi()[e])&&(n=null,R("mailbox.message.show",{folder:e.folder,uid:e.uid}))}p.forEach(e=>{n&&n.hash===e.hash&&(n=null,bi.message(null)),Pi.remove(e)})}if(s){if(l&&e!=s){const r={fromFolder:e,toFolder:s,uids:[...t].join(",")};if(i)qs.request("MessageCopy",null,r);else{const t=d===s,i=!t&&d===e&&St()===s;r.markAsRead=t||Tt.trashFolder()===s?1:0,r.learning=t?"SPAM":i?"HAM":"",qs.abort("MessageList","reload").request("MessageMove",m,r)}}}else qs.abort("MessageList","reload").request("MessageDelete",m,{folder:e,uids:[...t].join(",")})};let Ni,Di=9e5;const Ri=e=>{Di=6e4*Math.max(1,f(F("minRefreshInterval")),f(e)),clearInterval(Ni),Ni=setInterval(()=>{const e=Tt.currentFolderFullName(),t=St();_i(t),t===e||_i(e),qi()},Di)},Vi=e=>{try{let t=we(!0);e.sort((e,s)=>e.isInbox()?-1:s.isInbox()?1:t.compare(e.fullName,s.fullName))}catch(e){console.error(e)}},Ui=(e,t,s,i)=>{const r=[],a=!s||!Mt.hideUnsubscribed(),o=i||(t=>!t.selectable()||e.includes(t.fullName)),n=e=>{e.forEach(e=>{(a||e.hasSubscriptions()||!e.exists)&&r.push({id:e.fullName,name:"   ".repeat(e.deep)+s(e),system:!1,disabled:o(e)}),n(e.subFolders())})};return i=i||(()=>!1),s=s||(e=>e.name()),d(e)||(e=[]),d(t)&&t.forEach(e=>r.push({id:e[0],name:e[1],system:!1,disabled:!1})),n(Tt.folderList()),r},_i=(e,t)=>{if(e?.trim()){let s=1;const i=[];h(t)&&(t.forEach(e=>{i.push(e.uid),e.threads.forEach(e=>i.push(e))}),s=i.length),s&&qs.request("FolderInformation",(e,t)=>{if(!e&&t.Result){const e=t.Result,s=Et(e.name);if(s){const t=s.etag,i=s.unreadEmails()!==e.unreadEmails;s.expires=Date.now(),s.uidNext=e.uidNext,s.etag=e.etag,s.totalEmails(e.totalEmails),s.unreadEmails(e.unreadEmails),Pi.notifyNewMessages(s.fullName,e.newMessages),t&&!i&&e.etag===t||s.fullName===Tt.currentFolderFullName()&&Pi.reload()}}},{folder:e,flagsUids:i,uidNext:Et(e)?.uidNext||0})}},qi=(e=!1)=>{const t=Tt.getNextFolderNames(Di);h(t)&&qs.request("FolderInformationMultiply",(t,s)=>{if(!t&&h(s.Result)){const t=Date.now();s.Result.forEach(e=>{const s=Et(e.name);if(s){const i=s.etag,r=s.unreadEmails()!==e.unreadEmails;s.expires=t,s.etag=e.etag,s.totalEmails(e.totalEmails),s.unreadEmails(e.unreadEmails),i&&e.etag===i?r&&s.fullName===Tt.currentFolderFullName()&&Pi.length&&_i(s.fullName,Pi()):s.fullName===Tt.currentFolderFullName()&&Pi.reload()}}),e&&setTimeout(()=>qi(!0),2e3)}},{folders:t})},Bi=(e,t)=>{let s=t.length;for(const i of t)if(Ie===i.type){let t=new FormData;t.append("folder",e),t.append("appendFile",i),qs.request("FolderAppend",(t,i)=>{t&&console.error(i.message),0==--s&&Tt.currentFolderFullName()==e&&Pi.reload(!0,!0)},t)}else--s},Ki=window,Hi="rlcsc",Gi="localStorage",$i=()=>{try{const e=localStorage.getItem(Hi);return e?JSON.parse(e):null}catch(e){return null}};try{Ki[Gi].setItem(Gi,""),Ki[Gi].getItem(Gi),Ki[Gi].removeItem(Gi)}catch(e){console.error(e);let t=document.cookie.match(/(^|;) ?localStorage=([^;]+)/);t=t?decodeURIComponent(t[2]):null,t=t?JSON.parse(t):{},Ki[Gi]={getItem:e=>t[e]??null,setItem:(e,s)=>{t[e]=""+s,document.cookie=Gi+"="+encodeURIComponent(JSON.stringify(t))+";expires="+new Date(Date.now()+31536e6).toGMTString()+";path=/;samesite=strict"}}}function ji(e,t){const s=$i()||{};s["p"+e]=t;try{return localStorage.setItem(Hi,JSON.stringify(s)),!0}catch(e){return!1}}function Wi(e){try{return($i()||{})["p"+e]}catch(e){return null}}class FolderACLPopupView extends AbstractViewPopup{constructor(){super("FolderACL"),Ce(this,{create:!1,mine:!1,folderName:"",identifier:""}),this.rights=ko.observableArray()}submitForm(){if(!this.mine()){const e=this.rights();qs.request("FolderSetACL",(t,s)=>{if(!t&&s.Result){const t=this.acl;t.identifier||this.folder.ACL.push(t),t.rights=e}},{folder:this.folderName(),identifier:this.identifier(),rights:e.join("")})}this.close()}beforeShow(e,t){this.folder=e,this.create(!t.identifier()),this.mine(t.mine()),this.acl=t,this.folderName(e.fullName),this.identifier(t.identifier()),this.rights(t.rights())}}class FolderACLModel extends AbstractCollectionModel{static reviveFromJson(e){return super.reviveFromJson(e,e=>FolderACLRightsModel.reviveFromJson(e))}}class FolderACLRightsModel extends AbstractModel{constructor(){super(),Ce(this,{identifier:"",mine:!1}),this.rights=ko.observableArray()}static reviveFromJson(e){return e.rights=e.rights.split(""),super.reviveFromJson(e)}}class FolderPopupView extends AbstractViewPopup{constructor(){super("Folder"),Ce(this,{folder:null,parentFolder:"",name:"",editing:!1,adminACL:!1}),this.ACLAllowed=Tt.hasCapability("ACL"),this.parentFolderSelectList=Ae(()=>Ui([],[["",""]],e=>e?e.detailedName():"",e=>!e.subFolders.allow||Tt.namespace&&!e.fullName.startsWith(Tt.namespace))),this.displaySpecSetting=Tt.displaySpecSetting,this.showKolab=Tt.allowKolab(),this.kolabTypeOptions=ko.observableArray();let e=e=>de("SETTINGS_FOLDERS/TYPE_"+e);ge(()=>{this.kolabTypeOptions([{id:"",name:""},{id:"event",name:e("CALENDAR")},{id:"contact",name:e("CONTACTS")},{id:"task",name:e("TASKS")},{id:"note",name:e("NOTES")},{id:"file",name:e("FILES")},{id:"journal",name:e("JOURNAL")},{id:"configuration",name:e("CONFIGURATION")}])}),this.defaultOptionsAfterRender=y,this.editACL=this.editACL.bind(this),this.deleteACL=this.deleteACL.bind(this)}afterHide(){this.editing(!1)}submitForm(){const e=this.folder(),t=this.name().trim(),s=this.parentFolder(),i=Et(e.parentName),r=Et(s),a=Tt.folderList,o=r?r.subFolders:a,n=(r||e).delimiter,l=e.fullName,d=(r?s+n:"")+t;t&&d!=l?qs.abort("Folders").post("FolderRename",Tt.foldersRenaming,{oldName:l,newName:d,subscribe:e.isSubscribed()?1:0,checkable:e.checkable()?1:0,kolab:{type:tt,value:e.kolabType()}}).then(()=>{const s=(e,t)=>{At(e.fullName),e.parentName=t?t.fullName:"",e.fullName=(t?t.fullName+n:"")+e.name(),e.delimiter=n,e.deep=(t?t.deep:-1)+1,vt(e)},l=e=>{e.subFolders.forEach(t=>{s(t,e),l(t)})};e.name(t),s(e,r),(e.subFolders.length||r!=i)&&l(e),(i?i.subFolders:a).remove(e),o.push(e),Vi(o)}).catch(e=>{console.error(e),Tt.error(fe(e.code,"",c.CantRenameFolder)+".\n"+e.message)}):qs.request("FolderSettings",null,{folder:e.fullName,subscribe:e.isSubscribed()?1:0,checkable:e.checkable()?1:0,kolab:{type:tt,value:e.kolabType()}}),this.close()}createACL(){Ls(FolderACLPopupView,[this.folder(),new FolderACLRightsModel])}editACL(e){Ls(FolderACLPopupView,[this.folder(),e])}deleteACL(e){qs.request("FolderDeleteACL",(t,s)=>!t&&s.Result&&this.folder().ACL.remove(e),{folder:this.folder().fullName,identifier:e.identifier})}beforeShow(e){e.ACL||(e.ACL=ko.observableArray()),this.adminACL(!1),this.ACLAllowed&&qs.request("FolderACL",(t,s)=>{!t&&s.Result&&(e.ACL(FolderACLModel.reviveFromJson(s.Result)),this.adminACL(e.ACL()[0].rights.includes("a")))},{folder:e.fullName}),this.editing(!e.type()&&e.exists&&e.selectable()),this.name(e.name()),this.parentFolder(e.parentName),this.folder(e)}}const Ji=e=>""===e||gt===e||null!==Et(e)?e:"",zi={Inbox:0,Sent:0,Drafts:0,Junk:0,Trash:0,Archive:0},Yi={configuration:"CONFIGURATION",event:"CALENDAR",contact:"CONTACTS",task:"TASKS",note:"NOTES",file:"FILES",journal:"JOURNAL"},Zi=(e,t)=>{switch(e){case et.Inbox:case et.Sent:case et.Drafts:case et.Trash:case et.Archive:return de("FOLDER_LIST/"+v(et,e).toUpperCase()+"_NAME");case et.Junk:return de("GLOBAL/SPAM")}return t},Xi=(e,t)=>{let s=Wi(3);s=new Set(d(s)?s:[]),t?s.add(e):s.delete(e),ji(3,[...s])},Qi=ko.observable(""),er=e=>{qs.abort("Folders").post("Folders",Tt.foldersLoading).then(t=>{ft.clear(),yt.clear(),FolderCollectionModel.reviveFromJson(t.Result)?.storeIt(),e?.(!0)}).catch(t=>e&&setTimeout(e,1,!1,t))};class FolderCollectionModel extends AbstractCollectionModel{static reviveFromJson(e){const t=Wi(3);g(zi,(e,t)=>t||(zi[e]=F(e+"Folder")));const s=super.reviveFromJson(e,e=>{let s=Et(e.fullName);if(s)e.etag&&(s.etag=e.etag),null!=e.totalEmails&&s.totalEmails(e.totalEmails),null!=e.unreadEmails&&s.unreadEmails(e.unreadEmails);else{if(s=FolderModel.reviveFromJson(e),!s)return null;vt(s)}let i=e.role;return i&&(i=i[0].toUpperCase()+i.slice(1),zi[i]||(zi[i]=e.fullName)),s.type(et[v(zi,e.fullName)]||0),s.collapsed(!t||!d(t)||!t.includes(s.fullName)),s});var i;s.CountRec=s.length,i=zi.Inbox,bt=i;let r=s.length;if(r){Vi(s);try{for(;r--;){let e=s[r],t=Et(e.parentName);if(!t){let i=e.delimiter;if(i){let a=e.fullName.split(i);for(a.pop();a.length;){let e=a.join(i),t=a.pop(),o=Et(e);o||(console.log("Create nonexistent folder "+e),o=FolderModel.reviveFromJson({"@Object":"Object/Folder",name:t,fullName:e,delimiter:i,attributes:["\\nonexistent"]}),vt(o),s.splice(r,0,o),++r)}t=Et(e.parentName)}}t&&(t.subFolders.unshift(e),s.splice(r,1))}}catch(e){console.error(e)}}return s}visible(){return this.filter(e=>e.visible())}storeIt(){Tt.displaySpecSetting(M.app("folderSpecLimit")<this.CountRec),F("SentFolder")+F("DraftsFolder")+F("JunkFolder")+F("TrashFolder")+F("ArchiveFolder")||Tt.saveSystemFolders(zi),Tt.folderList(this),Tt.namespace=this.namespace,Os.threadsAllowed(!!this.capabilities.some(e=>e.startsWith("THREAD="))),Tt.quotaUsage(this.quotaUsage),Tt.quotaLimit(this.quotaLimit),Tt.capabilities(this.capabilities),Tt.sentFolder(Ji(zi.Sent)),Tt.draftsFolder(Ji(zi.Drafts)),Tt.spamFolder(Ji(zi.Junk)),Tt.trashFolder(Ji(zi.Trash)),Tt.archiveFolder(Ji(zi.Archive))}}class FolderModel extends AbstractModel{constructor(){super(),this.fullName="",this.parentName="",this.delimiter="",this.deep=0,this.expires=0,this.metadata={},this.exists=!0,this.etag="",this.id=0,this.uidNext=0,this.size=0,Ce(this,{name:"",type:0,role:null,selectable:!1,focused:!1,selected:!1,isSubscribed:!0,checkable:!1,askDelete:!1,errorMsg:"",totalEmails:0,unreadEmails:0,kolabType:null,collapsed:!0,tagsAllowed:!1}),this.attributes=ko.observableArray(),this.permanentFlags=ko.observableArray(),this.addSubscribables({kolabType:e=>this.metadata[tt]=e,permanentFlags:e=>this.tagsAllowed(e.includes("\\*")),unreadEmails:e=>et.Inbox===this.type()&&R("mailbox.inbox-unread-count",e)}),this.subFolders=ko.observableArray(new FolderCollectionModel),this.actionBlink=ko.observable(!1).extend({falseTimeout:1e3}),this.addComputables({isInbox:()=>et.Inbox===this.type(),isFlagged:()=>Tt.currentFolder()===this&&Pi.listSearch().includes("flagged"),hasVisibleSubfolders:()=>!!this.subFolders().find(e=>e.visible()),visibleSubfolders:()=>this.subFolders().visible(),hasSubscriptions:()=>this.isSubscribed()|!!this.subFolders().find(e=>{const t=e.hasSubscriptions();return!e.isSystemFolder()&&t}),isSystemFolder:()=>this.type()|(Tt.allowKolab()&&!!this.kolabType()&!Mt.unhideKolabFolders()),canBeSelected:()=>this.selectable()&&!this.isSystemFolder(),canBeDeleted:()=>this.canBeSelected()&&this.exists,canBeSubscribed:()=>this.selectable()&&!(this.isSystemFolder()|!Mt.hideUnsubscribed()),optionalTags:()=>this.permanentFlags.filter(kt),visible:()=>{const e=this.canBeSelected(),t=this.name(),s=Qi(),i=this.isSubscribed()|!Mt.hideUnsubscribed()&&e&&(!s||t.toLowerCase().includes(s.toLowerCase()));return this.hasVisibleSubfolders()|i},unreadCount:()=>this.unreadEmails()||null,localName:()=>{let e=this.name();return this.isSystemFolder()&&(le(),e=Zi(this.type(),e)),e},nameInfo:()=>{if(this.isSystemFolder()){le();let t=Zi(this.type(),(e=this.kolabType(),Yi[e]?"Kolab "+de("SETTINGS_FOLDERS/TYPE_"+Yi[e]):""));if(this.name()!==t&&"inbox"!==t.toLowerCase())return t}var e;return""},friendlySize:()=>Qe.friendlySize(this.size),detailedName:()=>this.localName(),icon:()=>{switch(this.type()){case 1:return"📥";case 2:return"📧";case 3:return"🗎";case 4:return"⚠";case 5:return"🗑";case 6:return"🗄"}return null},hasUnreadInSub:()=>this.subFolders().some(e=>e.unreadEmails()|e.hasUnreadInSub()),href:()=>this.canBeSelected()&&se(this.fullNameHash)})}edit(){Ls(FolderPopupView,[this])}get fullNameHash(){return this.fullName.replace(/[^a-z0-9._-]+/giu,S)}static reviveFromJson(e){const t=super.reviveFromJson(e);if(t){const e=t.fullName.split(t.delimiter),s=e=>t.attributes.includes(e),i=(t.metadata[tt]||t.metadata[st]||"").split(".")[0];t.deep=e.length-1,e.pop(),t.parentName=e.join(t.delimiter),t.isSubscribed(s("\\subscribed")),t.exists=!s("\\nonexistent"),t.subFolders.allow=!s("\\noinferiors"),t.selectable(t.exists&&!s("\\noselect")),i&&"mail"!=i&&t.kolabType(i)}return t}collapsedCss(){return"e-collapsed-sign "+(this.hasVisibleSubfolders()?this.collapsed()?"icon-right-mini":"icon-down-mini":"icon-none")}}const tr=()=>"messages"===lr?.action,sr=()=>"sortable"===lr?.action,ir=(e,t,s,i,r)=>{lr={action:t,data:i},e.dataTransfer.setData("text/plain","snappymail/action/"+t),e.dataTransfer.setDragImage(r,0,0),e.dataTransfer.effectAllowed=s},rr={id:0},ar=(e,t)=>{e.preventDefault(),t?.classList.remove("droppableHover"),rr.node==t&&(rr.node=null,clearTimeout(rr.id))},or=(e,t)=>pe(e,ko.unwrap(t()));let nr,lr;Object.assign(ko.bindingHandlers,{editor:{init:(e,t)=>{let s=null;const i=t(),r=()=>i.__editor?.setHtmlOrPlain(i()),a=()=>i.__editor&&i(i.__editor.getDataWithHtmlMark()),o=()=>{i.__editor=s,r()};ko.isObservable(i)&&(s=new HtmlEditor(e,o,a,a),i.__fetchEditorValue=a,i.subscribe(r))}},time:{init:or,update:or},emailsTags:{init:(e,t,s)=>{const i=t(),r=i.focused;e.addresses=new EmailAddressesComponent(e,{focusCallback:e=>r?.(!!e),autoCompleteSource:s.get("autoCompleteSource"),onChange:e=>i(e)}),r?.subscribe(t=>e.addresses[t?"focus":"blur"]())},update:(e,t)=>{e.addresses.value=ko.unwrap(t())}},dragmessages:{init:e=>{e.addEventListener("dragstart",e=>{if(nr||(nr=k("messagesDragImage")),nr&&!ut.isMobile()){ko.dataFor(A.elementFromPoint(e.clientX,e.clientY))?.checked?.(!0);const t=Pi.listCheckedOrSelectedUidsWithSubMails();nr.querySelector(".text").textContent=t.size,nr.style.left=e.clientX+"px",nr.style.top=e.clientY+"px",nr.style.right="auto",ir(e,"messages","copyMove",t,nr),nr.style.cssText="",O(!1)}else e.preventDefault()},!1),e.addEventListener("dragend",()=>lr=null)}},dropmessages:{init:(e,t)=>{const s=t();s&&K(e,{dragenter:t=>((e,t,s)=>{let i=!1;for(const t of e.dataTransfer.items)i|="file"===t.kind&&Ie===t.type;(i||tr())&&(e.stopPropagation(),ar(e,rr.node),e.dataTransfer.dropEffect=i||e.ctrlKey?"copy":"move",t.classList.add("droppableHover"),s.collapsed()&&(rr.node=t,rr.id=setTimeout(()=>{s.collapsed(!1),Xi(s.fullName,!0)},500)))})(t,e,s),dragover:e=>e.preventDefault(),dragleave:t=>ar(t,e),drop:t=>((e,t,s,i)=>{ar(e,t),tr()&&"copyMove"==e.dataTransfer.effectAllowed?Pi.moveMessages(Tt.currentFolderFullName(),i.data,s.fullName,e.ctrlKey):e.dataTransfer.types.includes("Files")&&Bi(s.fullName,e.dataTransfer.files)})(t,e,s,lr)})}},sortableItem:{init:(e,t)=>{let s=ko.unwrap(t())||{},i=e.parentNode,r=e=>{if(sr()){e.preventDefault();let t=(e.target.closest?e.target:e.target.parentNode).closest("[draggable]");if(t&&t!==lr.data&&i.contains(t)){let s=t.getBoundingClientRect();s.top+s.height/2<=e.clientY?t.nextElementSibling!==lr.data&&t.after(lr.data):t.previousElementSibling!==lr.data&&t.before(lr.data)}}};K(e,{dragstart:t=>{ir(t,"sortable","move",e,e),e.style.opacity=.25},dragend:()=>{if(e.style.opacity=null,sr()){lr.data.style.cssText="";let t=i.rows[s.list.indexOf(ko.dataFor(e))];t!=lr.data&&t.before(lr.data),lr=null}}}),i.sortable||(i.sortable=!0,K(i,{dragenter:r,dragover:r,drop:e=>{if(sr()){e.preventDefault();let t=ko.dataFor(lr.data),r=s.list.indexOf(t),a=[...i.children].indexOf(lr.data);if(r!=a){let e=s.list();e.splice(a,0,...e.splice(r,1)),s.list(e)}lr=null,s.afterMove?.()}}}))}},initDom:{init:(e,t)=>t()(e)},registerBootstrapDropdown:{init:e=>{I.push(e),e.ddBtn=new BSN.Dropdown(e.querySelector(".dropdown-toggle"))}}});class AccountModel extends AbstractModel{constructor(e,t,s=!0){super(),this.name=t,this.email=e,this.displayName=t?t+" <"+e+">":e,Ce(this,{unreadEmails:null,askDelete:!1,isAdditional:s}),Mt.showUnreadCount()&&s&&setTimeout(()=>this.fetchUnread(),3e3*Math.ceil(10*Math.random()))}label(){return this.name||IDN.toUnicode(this.email)}fetchUnread(){qs.request("AccountUnread",(e,t)=>{e||this.unreadEmails(t?.Result?.unreadEmails||null)},{email:this.email})}}class IdentityModel extends EmailModel{constructor(){super(),Ce(this,{id:"",label:"",replyTo:"",bcc:"",sentFolder:"",signature:"",signatureInsertBefore:!1,pgpSign:!1,pgpEncrypt:!1,smimeKey:"",smimeCertificate:"",askDelete:!1,exists:!1}),ke(this,{smimeKeyEncrypted:()=>this.smimeKey().includes("-----BEGIN ENCRYPTED PRIVATE KEY-----"),smimeKeyValid:()=>/^-----BEGIN (ENCRYPTED |RSA )?PRIVATE KEY-----/.test(this.smimeKey()),smimeCertificateValid:()=>/^-----BEGIN CERTIFICATE-----/.test(this.smimeCertificate())})}toString(){const e=this.name,t=this.email,s=this.label();return(e?`${e} `:"")+`<${t}>`+(s?` (${s})`:"")}}class IdentityPopupView extends AbstractViewPopup{constructor(){super("Identity"),Ce(this,{identity:null,edit:!1,labelFocused:!1,nameFocused:!1,submitRequest:!1,submitError:""}),this.folderSelectList=Ae(()=>Ui([],[["","("+de("GLOBAL/DEFAULT")+")"]])),this.defaultOptionsAfterRender=y,this.createSelfSigned=this.createSelfSigned.bind(this),this.setSMimeKeyPass=this.setSMimeKeyPass.bind(this)}createSelfSigned(){AskPopupView.password("","CRYPTO/CREATE_SELF_SIGNED").then(e=>{if(e){const t=this.identity();qs.request("SMimeCreateCertificate",(e,s)=>{s.Result.x509?(t.smimeKey(s.Result.pkey),t.smimeCertificate(s.Result.x509)):this.submitError(s.message)},{name:t.name,email:t.email,privateKey:t.smimeKey(),passphrase:e.password})}})}async setSMimeKeyPass(){const e=this.identity();let t=null;e.smimeKeyEncrypted()&&(t=await AskPopupView.password(de("CRYPTO/CURRENT_PASS"),"CRYPTO/DECRYPT"),!t)||AskPopupView.password(de("CRYPTO/NEW_PASS"),"GLOBAL/SAVE").then(s=>{s&&qs.request("SMimeExportPrivateKey",(t,s)=>{s.Result?e.smimeKey(s.Result):this.submitError(s.message)},{privateKey:e.smimeKey(),oldPassphrase:t?.password,newPassphrase:s.password})})}submitForm(e){if(!this.submitRequest()&&e.reportValidity()){let t=this.identity();t.signature?.__fetchEditorValue?.(),this.submitRequest(!0);const s=new FormData(e);s.set("Id",t.id()),s.set("Signature",t.signature()),qs.request("IdentityUpdate",e=>{this.submitRequest(!1),e?this.submitError(fe(e)):(rl.app.loadAccountsAndIdentities(),this.close())},s)}}onShow(e){this.submitRequest(!1),this.submitError(""),e?this.edit(!0):(this.edit(!1),(e=new IdentityModel).id(Jua.randomId())),this.identity(e)}afterShow(){this.identity().id()?this.labelFocused(!0):this.nameFocused(!0)}onClose(){this.close()}}const cr=ko.observable(0),dr=(()=>P(!!I.find(e=>e.classList.contains("show")))).debounce(50),hr=e=>Ls(IdentityPopupView,[e]),ur=()=>{Si.loading(!0),ci.loading(!0),qs.request("AccountsAndIdentities",(e,t)=>{if(Si.loading(!1),ci.loading(!1),!e){let e=t.Result.Accounts;Si(d(e)?e.map(e=>new AccountModel(e.email,e.name)):[]),Si.unshift(new AccountModel(F("mainEmail"),"",!1)),e=t.Result.Identities,ci(d(e)?e.map(e=>IdentityModel.reviveFromJson(e)):[]);const s=ci.main();s&&!s.exists()&&setTimeout(()=>hr(s),1e3)}})},pr=(e,t="")=>{if(console.log("download: "+e),ut.isMobile()||/firefox/i.test(navigator.userAgent))open(e,"_blank"),focus();else{const s=D("a",{href:e,target:"_blank",download:t});A.body.appendChild(s).click(),s.remove()}},mr=(e,t,s,i,r)=>{if(t.length){let a={target:"zip",filename:e,hashes:t};s||(s=()=>alert("Download failed")),r&&(a.folder=r),qs.post("AttachmentsActions",i||null,a).then(e=>{let t=e?.Result?.fileHash;t?pr(Z(t),t+".zip"):s()}).catch(s)}},gr=(e,t)=>()=>{const s=e(),i=t(),r=[],a=A.documentElement.lang,o=(e,t=!0,i="")=>{const o=e.toLocaleString(a),n={current:e===s,name:i||o,title:i?o:"",value:e};t?r.push(n):r.unshift(n)};let n=0,l=0,c=2;if(1<i){for(i<s?(o(i),n=i,l=i):((3>=s||i-2<=s)&&(c+=2),o(s),n=s,l=s);0<c;)if(--n,++l,0<n&&(o(n,!1),--c),i>=l)o(l,!0),--c;else if(0>=n)break;3===n?o(2,!1):3<n&&o(Math.round((n-1)/2),!1,"…"),i-2===l?o(i-1,!0):i-2>l&&o(Math.round((i+l)/2),!0,"…"),1<n&&o(1,!1),i>l&&o(i,!0)}return r},fr=e=>{if("mailto:"===e?.slice(0,7).toLowerCase()){e=e.slice(7).split("?");const t=decodeURIComponent(e[0]),s=new URLSearchParams(e[1]),i=s.get("to"),r=e=>EmailCollectionModel.fromString(e);return yr([it.Empty,null,r(i?t+","+i:t),r(s.get("cc")),r(s.get("bcc")),s.get("subject"),Xt(s.get("body")||"")]),!0}return!1},yr=(e=[])=>{rl.app.showMessageComposer(e)},br=(e,t,s)=>{if(e.layoutResizer&&e.layoutResizer.mode!=s&&e.removeAttribute("style"),e.observer?.disconnect(),s){const i=Wi(t+s)||F("Resizer"+t+s);if(i&&(e.style[s.toLowerCase()]=i+"px"),!e.layoutResizer){const t=D("div",{class:"resizer"}),s=(e=>qs.saveSettings(0,e)).debounce(500),i={},r=()=>{const i="Width"==t.mode?e.offsetWidth:e.offsetHeight,r=t.key+t.mode;i==Wi(r)||ji(r,i),i==F("Resizer"+r)||s({["Resizer"+r]:i})},a=s=>{let i=getComputedStyle(e,null)[s].replace("px","");return i.includes("%")&&(i=e.parentElement["offset"+t.mode]*i.replace("%","")/100),parseFloat(i)};e.layoutResizer=t,e.append(t),t.addEventListener("mousedown",{handleEvent:function(s){if("mousedown"==s.type){const e=t.mode.toLowerCase();s.preventDefault(),i.pos="width"==e?s.pageX:s.pageY,i.min=a("min-"+e),i.max=a("max-"+e),i.org=a(e),addEventListener("mousemove",this),addEventListener("mouseup",this)}else if("mousemove"==s.type){const a=t.mode.toLowerCase(),o=i.org+(("width"==a?s.pageX:s.pageY)-i.pos);o>=i.min&&o<=i.max&&(e.style[a]=o+"px",e.observer||r())}else"mouseup"==s.type&&(removeEventListener("mousemove",this),removeEventListener("mouseup",this))}}),e.observer=window.ResizeObserver?new ResizeObserver(r):null}e.layoutResizer.mode=s,e.layoutResizer.key=t,e.observer?.observe(e,{box:"border-box"})}},Sr=(e,t)=>{if(t)e.popupMessage();else{bi.error("");let t="rl-msg-"+e.hash,s=e.body||k(t);s||(s=D("div",{id:t,hidden:"",class:"b-text-part"+(e.pgpSigned()?" openpgp-signed":"")+(e.pgpEncrypted()?" openpgp-encrypted":"")+(e.smimeSigned()?" smime-signed":"")+(e.smimeEncrypted()?" smime-encrypted":"")}),bi.purgeCache()),s.message=e,e.body=s,Mt.viewHTML()&&e.viewHtml()||e.viewPlain(),bi.bodiesDom().append(s),bi.loading(!1),e.body.hidden=!1,e.isUnseen()&&Mt.messageReadAuto()&&(bi.MessageSeenTimer=setTimeout(()=>Pi.setAction(e.folder,rt,[e]),1e3*Mt.messageReadDelay()))}},vr=(e,t)=>{e&&(t||bi.message(e),e.body?Sr(e,t):(t||bi.loading(!0),qs.message((s,i)=>{if(s)c.RequestAborted===s||t||(bi.message(null),bi.error(fe(s)));else{let s=i?.Result;s&&(e.hash&&e.hash===s.hash||!e.hash&&e.folder===s.folder&&e.uid==s.uid)&&e.revivePropertiesFromJson(s)&&Sr(e,t)}t||bi.loading(!1)},e.folder,e.uid)))};O.subscribe(e=>e&&cr(0)),cr.subscribe(e=>e&&O(!1));const wr=xe();wr.loading=ko.observable(!1).extend({debounce:200}),wr.importing=ko.observable(!1).extend({debounce:200}),wr.syncing=ko.observable(!1).extend({debounce:200}),Ce(wr,{allowSync:!1,syncMode:0,syncUrl:"",syncUser:"",syncPass:""}),wr.hasChecked=Ae(()=>!!wr.find(e=>e.checked())),wr.sync=e=>{!wr.syncMode()||wr.importing()||wr.syncing()||(wr.syncing(!0),qs.streamPerLine(t=>{try{"ContactsSync"===(t=JSON.parse(t)).Action&&(wr.syncing(!1),e?.(t.code,t))}catch(t){wr.syncing(!1),console.error(t),e?.(c.UnknownError)}},"ContactsSync"))},wr.init=()=>{let e=F("ContactsSync");wr.allowSync(!!e),e&&(wr.syncMode(e.Mode),wr.syncUrl(e.Url),wr.syncUser(e.User),wr.syncPass(e.Password),setTimeout(wr.sync,1e4),setInterval(wr.sync,6e4*e.Interval+5e3))};const Er=xe();Ce(Er,{loading:!1}),Er.loadCertificates=()=>{Er([]),Er.loading(!0),qs.request("SMimeGetCertificates",(e,t)=>{Er.loading(!1);const s=we();e||Er(t.Result.sort((e,t)=>s.compare(e.emailAddress,t.emailAddress)||t.validTo_time_t-e.validTo_time_t))})};class AbstractScreen{constructor(e,t=[]){this.__cross=null,this.screenName=e,this.viewModels=d(t)?t:[]}routes(){return null}onStart(){const e=this.routes();if(h(e)){let t=new Crossroads,s=(this.onRoute||(()=>0)).bind(this);e.forEach(e=>e&&(t.addRoute(e[0],s).rules=e[1])),this.__cross=t}}}class LanguagesPopupView extends AbstractViewPopup{constructor(){super("Languages"),this.fLang=null,this.languages=ko.observableArray()}onShow(e,t,s){this.fLang=e,this.languages(t.map(t=>({key:t,user:s===t,selected:e?.()===t,fullName:ve(t),title:ve(t,!0)})))}changeLanguage(e){this.fLang?.(e),this.close()}}class LoginUserView extends AbstractViewLogin{constructor(){super(),Ce(this,{loadingDesc:F("loadingDescription"),email:F("DevEmail"),password:F("DevPassword"),signMe:!1,emailError:!1,passwordError:!1,submitRequest:!1,submitError:"",submitErrorAdditional:"",langRequest:!1,signMeType:2}),this.allowLanguagesOnLogin=!!F("allowLanguagesOnLogin"),this.language=ie.language,this.languages=ie.languages,this.bSendLanguage=!1,ke(this,{languageFullName:()=>ve(this.language()),signMeVisibility:()=>2!==this.signMeType()}),Te(this,{email:()=>this.emailError(!1),password:()=>this.passwordError(!1),submitError:e=>e||this.submitErrorAdditional(""),signMeType:e=>this.signMe(1===e),language:e=>{this.langRequest(!0),Se(e).then(()=>{this.langRequest(!1),this.bSendLanguage=!0},()=>this.langRequest(!1))}}),F("AdditionalLoginError")&&!this.submitError()&&this.submitError(F("AdditionalLoginError")),Ps(this,{submitCommand:e=>!e.submitRequest()})}hideError(){this.submitError("")}submitCommand(e,t){const s=this.email().trim();this.email(s);let i=t.target.form,r=new FormData(i),a=i.reportValidity()&&R("sm-user-login",r,1);return this.emailError(!s),this.passwordError(!this.password()),this.formError(!a),a&&(this.submitRequest(!0),r.set("language",this.bSendLanguage?this.language():""),r.set("signMe",this.signMe()?1:0),qs.request("Login",(e,t)=>{R("sm-user-login-response",{error:e,data:t}),e?(this.submitRequest(!1),c.InvalidInputArgument==e&&(e=c.AuthError),this.submitError(fe(e,t?.message,c.UnknownError)),this.submitErrorAdditional(t?.messageAdditional||t?.message)):rl.setData(t.Result)},r),ji(7,this.signMe()?"-1-":"-0-")),a}onBuild(e){super.onBuild(e);let t=F("signMe");switch(t){case 0:case 1:switch(Wi(7)){case"-1-":t=1;break;case"-0-":t=0}this.signMeType(t);break;default:this.signMeType(2)}}selectLanguage(){Ls(LanguagesPopupView,[this.language,this.languages(),ie.userLanguage()])}}class LoginUserScreen extends AbstractScreen{constructor(){super("login",[LoginUserView])}onShow(){rl.setTitle()}}class KeyboardShortcutsHelpPopupView extends AbstractViewPopup{constructor(){super("KeyboardShortcutsHelp"),this.metaKey=shortcuts.getMetaKey()}onBuild(e){const t=e.querySelectorAll(".tabs input"),s=t.length-1;_("tab,arrowleft,arrowright","","KeyboardShortcutsHelp",e=>{let i=0;return t.forEach((t,r)=>{t.matches(":checked")&&(i=["Tab","ArrowRight"].includes(e.key)?r<s?r+1:0:r?r-1:s)}),t[i].checked=!0,!1})}}class AccountPopupView extends AbstractViewPopup{constructor(){super("Account"),Ce(this,{isNew:!0,name:"",email:"",password:"",submitRequest:!1,submitError:"",submitErrorAdditional:""})}hideError(){this.submitError("")}submitForm(e){if(!this.submitRequest()&&e.reportValidity()){const t=new FormData(e);t.set("new",this.isNew()?1:0),this.submitRequest(!0),qs.request("AccountSetup",(e,t)=>{this.submitRequest(!1),e?(this.submitError(fe(e)),this.submitErrorAdditional(t?.messageAdditional)):(ur(),this.close())},t)}}onHide(){this.password(""),this.submitRequest(!1),this.submitError(""),this.submitErrorAdditional("")}onShow(e){let t=e?.isAdditional();this.isNew(!t),this.name(t?e.name:""),this.email(t?e.email:"")}}let Ar;class Selector{constructor(e,t,s,i,r){s=(s||ko.observable(null)).extend({toggleSubscribeProperty:[this,"focused"]}),t=(t||ko.observable(null)).extend({toggleSubscribeProperty:[null,"selected"]}),this.list=e,this.listChecked=Ae(()=>e.filter(e=>e.checked())).extend({rateLimit:0}),this.focusedItem=s,this.selectedItem=t,this.iSelectNextHelper=0,this.iFocusedNextHelper=0,this.sItemSelector=i,this.sItemCheckedSelector=r,this.sItemFocusedSelector=i+".focused",this.sLastUid="",this.oCallbacks={};const a=t=>{e.hasChecked()?t||this.oCallbacks.ItemSelect?.(null):t&&this.oCallbacks.ItemSelect?.(t)},o=(e=>a(e)).debounce(300);this.listChecked.subscribe(e=>{e.length?t()?t(null):t.valueHasMutated?.():this.autoSelect()});let n=!0;t.subscribe(e=>{e?n&&o(e):n&&a()}),s.subscribe(e=>e&&(this.sLastUid=this.getItemUid(e)));let l=[],c=null,h=null;e.subscribe(e=>{d(e)&&e.forEach(e=>{const t=this.getItemUid(e);t&&(e.checked()&&l.push(t),!c&&e.focused()&&(c=t),!h&&e.selected()&&(h=t))})},this,"beforeChange"),e.subscribe(e=>{if(n=!1,this.unselect(),d(e)){let i,r,a=this.iFocusedNextHelper||this.iSelectNextHelper;e.forEach(e=>{const i=this.getItemUid(e);i&&(c===i&&(s(e),c=null),l.includes(i)&&(e.checked(!0),r=!0),r||h!==i||(t(e),h=null))}),n=!0,a&&e.length&&!s()&&(i=e[-1===a?e.length-1:0],i&&(this.iSelectNextHelper&&t(i),s(i),this.scrollToFocused(),setTimeout(this.scrollToFocused,100)),this.iSelectNextHelper=0,this.iFocusedNextHelper=0),!r&&!t()&&this.autoSelect()}l=[],c=null,h=null,n=!0})}unselect(){this.selectedItem(null),this.focusedItem(null)}init(e,t="all"){if(this.oContentScrollable=e,e){let s=t=>{let s=event.target.closestWithin(t,e);return s?ko.dataFor(s):null};K(e,{click:t=>{const i=t.target.closestWithin(this.sItemSelector,e);let r=i&&ko.dataFor(i);i&&(this.oCallbacks.click||(()=>1))(t,r)&&this.actionClick(r,t),r=s(this.sItemCheckedSelector),r&&(t.shiftKey?this.actionClick(r,t):(this.focusedItem(r),r.checked(!r.checked())))},auxclick:e=>{if(1==e.button){const e=s(this.sItemSelector);e&&(this.focusedItem(e),this.oCallbacks.MiddleClick?.(e))}}}),q("enter,open","",t,()=>{const e=this.focusedItem();if(e&&!e.selected())return this.actionClick(e),!1}),_("arrowup,arrowdown","meta",t,()=>!1),_("arrowup,arrowdown","shift",t,e=>(this.newSelectPosition(e.key,!0),!1)),q("arrowup,arrowdown,home,end,pageup,pagedown,space","",t,e=>(this.newSelectPosition(e.key,!1),!1))}}autoSelect(e){(e||(this.oCallbacks.canSelect||(()=>1))())&&this.focusedItem()&&this.selectedItem(this.focusedItem())}getItemUid(e){return e&&this.oCallbacks.ItemGetUid?.(e)?.toString()||""}newSelectPosition(e,t,s){let i;const r="ArrowUp"===e,a=r||"ArrowDown"===e,o=this.list(),n=o.length,l=this.focusedItem();if(t||(Ar=-1)," "===e)l?.checked(!l.checked());else if(n){if(l){if(a){let e=o.indexOf(l);t&&(Ar=-1<Ar?Ar:e,Ar==e?l.checked(!0):(r?Ar<e:Ar>e)&&l.checked(!1)),r?e>0&&(i=o[--e]):++e<n&&(i=o[e]),t&&i?.checked(!0),i||this.oCallbacks.UpOrDown?.(r)}else if("Home"===e)i=o[0];else if("End"===e)i=o[o.length-1];else if("PageDown"===e){let e=o.indexOf(l);e<n-1&&(i=o[Math.min(e+10,n-1)])}else if("PageUp"===e){let e=o.indexOf(l);e>0&&(i=o[Math.max(0,e-10)])}}else"Home"==e||"PageUp"==e?i=o[0]:"End"!==e&&"PageDown"!==e||(i=o[o.length-1]);i&&(this.focusedItem(i),!this.list.hasChecked()&&this.autoSelect(s),this.scrollToFocused())}}scrollToFocused(){const e=this.oContentScrollable;if(e){let t=e.querySelector(this.sItemFocusedSelector);if(t){const s=t.getBoundingClientRect(),i=e.getBoundingClientRect();s.top<i.top?t.scrollIntoView(!0):s.bottom>i.bottom&&t.scrollIntoView(!1)}else e.scrollTop=0}}scrollToTop(){this.oContentScrollable&&(this.oContentScrollable.scrollTop=0)}actionClick(e,t){if(e){let s=!0;if(t&&!t.altKey){if(t.shiftKey&&!t.ctrlKey&&!t.metaKey){const t=this.getItemUid(e);if(t&&this.sLastUid&&t!==this.sLastUid){let s=!1,i=!1,r=!e.checked(),a="";this.list().forEach(e=>{a=this.getItemUid(e),s=a===this.sLastUid||a===t,(i||s)&&(s&&(i=!i),e.checked(r))})}return this.sLastUid=t,void this.focusedItem(e)}if(!t.shiftKey&&(t.ctrlKey||t.metaKey)){s=!1,this.focusedItem(e);const t=this.selectedItem();t&&e!==t&&t.checked(!0)}}s?this.selectMessageItem(e):e.checked(!e.checked())}}on(e,t){this.oCallbacks[e]=t}selectMessageItem(e){this.focusedItem(e),this.selectedItem(e),this.scrollToFocused()}}class VCardProperty{constructor(e,t,s,i="text"){if(this.field="",this.value="",this.type="",this.params={},void 0!==t&&"string"==typeof e)this.field=e,this.value=t,this.params=s||{},this.type=i;else{if(void 0!==t||void 0!==s||"object"!=typeof e)throw Error("invalid Property constructor");this.parseFromJCardProperty(e)}}parseFromJCardProperty(e){e=JSON.parse(JSON.stringify(e)),this.field=e[0].toLowerCase(),this.params=e[1],this.type=e[2],this.value=e[3]}addParam(e,t){Array.isArray(this.params[e])?this.params[e].push(t):null!=this.params[e]?this.params[e]=[this.params[e],t]:this.params[e]=t}getValue(){return""+this.value}pref(){return this.params.pref||100}tags(){return this.params.type||[]}isEmpty(){return!(null!=this.value&&/[^;]+/.test(this.value)||Object.keys(this.params).length)}notEmpty(){return!this.isEmpty()}getField(){return""+this.field}toString(){return JSON.stringify(this)}toJSON(){return[this.field,this.params,this.type||"text",this.value]}}class JCard{constructor(e){if(this.props=new Map,this.version="4.0",e){if("object"!=typeof e)throw Error("error reading vcard");this.parseFromJCard(e)}}parseFromJCard(e){if(e=JSON.parse(JSON.stringify(e)),!/vcard/i.test(e[0]))throw new SyntaxError("Incorrect jCard format");e[1].forEach(e=>this.add(new VCardProperty(e)))}get(e,t){if(t){let s=this.props.get(e);return s?s.filter(e=>{let s=e.type;return(Array.isArray(s)?s:[s]).includes(t)}):[]}return this.props.get(e)||[]}getOne(e,t){return this.get(e,t||"pref")[0]||this.get(e)[0]}set(e,t,s,i){if("string"==typeof e&&(e=new VCardProperty(String(e),t,s,i)),!(e instanceof VCardProperty))throw Error("invalid argument of VCard.set(), expects string arguments or a VCardProperty");let r=e.getField();return this.props.set(r,[e]),e}add(e,t,s,i){if("string"==typeof e&&(e=new VCardProperty(String(e),t,s,i)),!(e instanceof VCardProperty))throw Error("invalid argument of VCard.add(), expects string arguments or a VCardProperty");let r=e.getField();return this.props.get(r)?this.props.get(r)?.push(e):this.props.set(r,[e]),e}remove(e){if("string"==typeof e)this.props.delete(e);else{if(!(e instanceof VCardProperty))throw Error("invalid argument of VCard.remove(), expects string and optional param filter or a VCardProperty");{let t=this.props.get(e.getField());if(!t?.includes(e))throw Error("Attempted to remove VCardProperty VCard does not have: ".concat(e));t.splice(t.indexOf(e),1),0===t.length&&this.props.delete(e.getField())}}}has(e){return!!this.props.get(e)&&this.props.get(e).length>0}toString(){return JSON.stringify(this)}toJSON(){let e=[["version",{},"text","4.0"]];for(const[t,s]of this.props.entries())if("version"!==t)for(const t of s)t.isEmpty()||e.push(t.toJSON());return["vcard",e]}parseFullName(e){let t=this.getOne("n");if(void 0===t)throw Error("'fn' VCardProperty not present in card, cannot parse full name");let s="";[3,1,2,0,4].forEach(e=>{let i=t.value[e];i&&(s+=" "+i.replace(","," "))}),s=s.trim();let i=new VCardProperty("fn",s);return e?.set&&(e.append?this.add(i):this.set(i)),i}}const Cr=["surName","givenName","middleName","namePrefix","nameSuffix"];class ContactModel extends AbstractModel{constructor(){super(),this.jCard=["vcard",[]],Ce(this,{focused:!1,selected:!1,checked:!1,sendToAll:!0,deleted:!1,readOnly:!1,id:0,givenName:"",surName:"",middleName:"",namePrefix:"",nameSuffix:"",nickname:null,note:null,org:"",department:"",title:"",encryptpref:"",signpref:""}),this.email=ko.observableArray(),this.tel=ko.observableArray(),this.url=ko.observableArray(),this.adr=ko.observableArray(),ke(this,{fullName:()=>[this.namePrefix(),this.givenName(),this.middleName(),this.surName()].join(" ").trim(),display:()=>{let e=this.fullName(),t=this.email()[0]?.value(),s=this.nickname();return e||t||s}})}static reviveFromJson(e){const t=super.reviveFromJson(e);if(t){let s=new JCard(e.jCard),i=s.getOne("n")?.value;i&&i.forEach((e,s)=>e&&t[Cr[s]](e)),["nickname","note","title"].forEach(e=>{i=s.getOne(e),i&&t[e](i.value)}),(i=s.getOne("org")?.value)&&(t.org(i[0]),t.department(i[1]||"")),["email","tel","url"].forEach(e=>{i=s.get(e),i&&i.forEach(s=>{t[e].push({value:ko.observable(s.value)})})}),i=s.get("adr"),i&&i.forEach(e=>{t.adr.push({street:ko.observable(e.value[2]),street_ext:ko.observable(e.value[1]),locality:ko.observable(e.value[3]),region:ko.observable(e.value[4]),postcode:ko.observable(e.value[5]),pobox:ko.observable(e.value[0]),country:ko.observable(e.value[6]),preferred:ko.observable(e.params.pref),type:ko.observable(e.params.type)})}),i=s.getOne("x-crypto"),t.signpref(i?.params.signpref||"Ask"),t.encryptpref(i?.params.encryptpref||"Ask"),t.jCard=e.jCard}return t}addEmail(){this.email.push({value:ko.observable("")}),this.sendToAllDisplayStatus()&&(document.getElementById("send-to-all").style.display="block")}addTel(){this.tel.push({value:ko.observable("")})}addUrl(){this.url.push({value:ko.observable("")})}addNickname(){this.nickname()||this.nickname("")}addNote(){this.note()||this.note("")}hasChanges(){return this.email().filter(e=>e.length).length&&this.toJSON().jCard!=JSON.stringify(this.jCard)}toJSON(){let e=new JCard(this.jCard);if(e.set("n",[this.surName(),this.givenName(),this.middleName(),this.namePrefix(),this.nameSuffix()]),e.parseFullName({set:!0}),["nickname","note","title"].forEach(t=>this[t]()?e.set(t,this[t]()):e.remove(t)),this.org()){let t=[this.org()];this.department()&&t.push(this.department());let s=e.getOne("org");s?s.value=t:e.set("org",t)}else e.remove("");return["email","tel","url"].forEach(t=>{let s=this[t].map(e=>e.value());e.get(t).forEach(t=>{let i=s.indexOf(t.value);0>i||!t.value?e.remove(t):s.splice(i,1)}),s.forEach(s=>s&&e.add(t,s))}),e.set("x-crypto","",{allowed:"PGP/INLINE,PGP/MIME,S/MIME,S/MIMEOpaque",signpref:this.signpref(),encryptpref:this.encryptpref()},"x-crypto"),{uid:this.id,jCard:JSON.stringify(e)}}lineAsCss(){return(this.selected()?"selected":"")+(this.deleted()?" deleted":"")+(this.checked()?" checked":"")+(this.focused()?" focused":"")}sendToAllDisplayStatus(){return this.email.length>1}}const kr="Contacts";let Tr,Mr=!1,Fr="";class ContactsPopupView extends AbstractViewPopup{constructor(){super("Contacts"),Ce(this,{search:"",contactsCount:0,selectorContact:null,importButton:null,contactsPage:1,isSaving:!1,contact:null}),this.contacts=wr,this.useCheckboxesInList=Mt.useCheckboxesInList,this.selector=new Selector(wr,this.selectorContact,null,".e-contact-item",".e-contact-item .checkboxItem"),this.selector.on("ItemSelect",e=>this.populateViewContact(e)),this.selector.on("ItemGetUid",e=>e?e.id():""),ke(this,{contactsPaginator:gr(this.contactsPage,()=>Math.max(1,Math.ceil(this.contactsCount()/50))),contactsCheckedOrSelected:()=>{const e=wr.filter(e=>e.checked()),t=this.selectorContact();return e.length?e:t?[t]:[]},contactsSyncEnabled:()=>wr.allowSync()&&wr.syncMode(),isBusy:()=>wr.syncing()|wr.importing()|wr.loading()|this.isSaving()}),this.search.subscribe(()=>this.reloadContactList()),this.saveCommand=this.saveCommand.bind(this),Ps(this,{deleteCommand:e=>!e.isBusy()&&0<e.contactsCheckedOrSelected().length,newMessageCommand:e=>!e.isBusy()&&0<e.contactsCheckedOrSelected().length,saveCommand:e=>!e.isBusy(),syncCommand:e=>!e.isBusy()})}newContact(){this.populateViewContact(new ContactModel),this.selectorContact(null)}deleteCommand(){const e=this.contactsCheckedOrSelected();if(e.length){let t=this.selectorContact(),s=[],i=0;e.forEach(e=>{s.push(e.id()),t&&t.id()===e.id()&&this.selectorContact(t=null),e.deleted(!0),++i}),qs.request("ContactsDelete",(e,t)=>{if(e)alert(t?.message||fe(e));else{const e=this.contactsPage();e>Math.max(1,Math.ceil((this.contactsCount()-i)/50))&&this.contactsPage(e-1)}this.reloadContactList()},{uids:s.join(",")})}}newMessageCommand(){let e=[],t={to:null,cc:null,bcc:null};this.contactsCheckedOrSelected().forEach(t=>{if(t){let s,i=(t.givenName()+" "+t.surName()).trim(),r=t.email();t.sendToAll()||(r=r.slice(0,1)),r.forEach(t=>{s=new EmailModel(t.value(),i),s.valid()&&e.push(s)})}}),h(e)&&(Mr=!1,this.close(),t[Fr]=e,yr([it.Empty,null,t.to,t.cc,t.bcc]))}clearSearch(){this.search("")}saveCommand(){this.saveContact(this.contact())}saveContact(e){const t=e.toJSON();t.jCard!=JSON.stringify(e.jCard)&&(this.isSaving(!0),qs.request("ContactSave",(s,i)=>{s?alert(i?.message||fe(s)):i.Result.ResultID&&(e.id()?(e.id(i.Result.ResultID),e.jCard=JSON.parse(t.jCard)):this.reloadContactList()),this.isSaving(!1)},t))}syncCommand(){wr.sync(e=>{e&&alert(fe(e)),this.reloadContactList(!0)})}exportVcf(){pr(Y("ContactsVcf"),"contacts.vcf")}exportCsv(){pr(Y("ContactsCsv"),"contacts.csv")}populateViewContact(e){const t=this.contact(),s=()=>this.contact(e);t?.hasChanges()?AskPopupView.showModal([de("GLOBAL/SAVE_CHANGES"),()=>this.saveContact(t)|s(),s]):s()}reloadContactList(e=!1){let t=50*(this.contactsPage()-1);e&&(this.contactsPage(1),t=0),wr.loading(!0),qs.abort("Contacts").request("Contacts",(e,t)=>{let s=0,i=[];e?alert(t?.message||fe(e)):h(t.Result.List)&&(t.Result.List.forEach(e=>{(e=ContactModel.reviveFromJson(e))&&i.push(e)}),s=f(t.Result.Count)),this.contactsCount(0<s?s:0),wr(i),wr.loading(!1)},{Offset:t,Limit:50,Search:this.search()})}onBuild(e){this.selector.init(e.querySelector(".b-list-content"),kr),q("delete","",kr,()=>(this.deleteCommand(),!1)),q("c,w","",kr,()=>(this.newMessageCommand(),!1));const t=this;if(e.addEventListener("click",s=>{let i=s.target.closestWithin(".e-paginator a",e);i&&(i=f(ko.dataFor(i)?.value))&&(t.contactsPage(i),t.reloadContactList())}),this.importButton()){const e=new Jua({action:Q("UploadContacts"),limit:1,clickElement:this.importButton()});e&&e.on("onStart",()=>{wr.importing(!0)}).on("onComplete",(e,t,s)=>{wr.importing(!1),this.reloadContactList(),e&&t&&s&&s.Result||alert(de("CONTACTS/ERROR_IMPORT_FILE"))})}}onClose(){const e=this.contact();if(AskPopupView.hidden()&&e?.hasChanges())return AskPopupView.showModal([de("GLOBAL/SAVE_CHANGES"),()=>this.close()|this.saveContact(e),()=>this.close()]),!1}onShow(e,t){Mr=!!e,Fr=["to","cc","bcc"].includes(t)?t:"to",this.reloadContactList(!0)}onHide(){this.contact(null),this.selectorContact(null),this.search(""),this.contactsCount(0),wr([]),Mr&&yr()}}class SystemDropDownUserView extends AbstractViewRight{constructor(){super(),this.allowAccounts=x("AdditionalAccounts"),this.accountEmail=Si.email,this.accounts=Si,this.accountsLoading=Si.loading,Ce(this,{currentAudio:"",accountMenu:null}),this.allowContacts=Os.allowContacts(),addEventListener("audio.stop",()=>this.currentAudio("")),addEventListener("audio.start",e=>this.currentAudio(e.detail))}stopPlay(){R("audio.api.stop")}accountClick(e,t){let s=e?.email;return s&&0===t.button&&Si.email()!=s&&(Si.loading(!0),V(t),qs.request("AccountSwitch",t=>{t?(Si.loading(!1),alert("Account error: "+fe(t).replace("%EMAIL%",s)),e.isAdditional()&&Ls(AccountPopupView,[e])):rl.route.reload()},{Email:s})),!0}accountName(){const e=Si.email();return Si.find(t=>t.email==e)?.label()||IDN.toUnicode(e)}settingsClick(){hasher.setHash(te())}settingsHelp(){Ls(KeyboardShortcutsHelpPopupView)}addAccountClick(){this.allowAccounts&&Ls(AccountPopupView)}contactsClick(){this.allowContacts&&Ls(ContactsPopupView)}logoutClick(){rl.app.logout()}onBuild(){q("m","",[e,s,i],()=>{if(!this.viewModelDom.hidden)return this.accountMenu().ddBtn.toggle(),!1}),q("?,f1,help","",[e,s,i],()=>{if(!this.viewModelDom.hidden)return Ls(KeyboardShortcutsHelpPopupView),!1})}}class FolderCreatePopupView extends AbstractViewPopup{constructor(){super("FolderCreate"),Ce(this,{name:"",subscribe:!0,parentFolder:""}),this.parentFolderSelectList=Ae(()=>Ui([],[["",""]],e=>e?e.detailedName():"",e=>!e.subFolders.allow||Tt.namespace&&!e.fullName.startsWith(Tt.namespace))),this.defaultOptionsAfterRender=y}submitForm(e){if(e.reportValidity()){const t=new FormData(e);let s=this.parentFolder();!s&&1<Tt.namespace.length&&t.set("parent",Tt.namespace.slice(0,Tt.namespace.length-1)),qs.abort("Folders").post("FolderCreate",Tt.foldersCreating,t).then(e=>{const t=Et(s),i=FolderModel.reviveFromJson(e.Result),r=t?t.subFolders:Tt.folderList;vt(i),r.push(i),Vi(r)},e=>{Tt.error(fe(e.code,"",c.CantCreateFolder)+".\n"+e.message)}),this.close()}}onShow(){this.name(""),this.subscribe(!0),this.parentFolder("")}}class ComposeAttachmentModel extends AbstractModel{constructor(e,t,s=null,i=!1,r=!1,a="",o=""){super(),this.id=e,this.isInline=!!i,this.isLinked=!!r,this.cId=a,this.contentLocation=o,this.fromMessage=!1,Ce(this,{fileName:t,size:s,tempName:"",type:"",progress:0,error:"",waiting:!0,uploading:!1,enabled:!0,complete:!1}),ke(this,{progressText:()=>{const e=this.progress();return 1>e?"":(100<e?100:e)+"%"},progressStyle:()=>{const e=this.progress();return 1>e?"":"width:"+(100<e?100:e)+"%"},title:()=>this.error()||this.fileName(),friendlySize:()=>{const e=this.size();return null===e?"":Qe.friendlySize(e)},mimeType:()=>this.type()||Qe.getContentType(this.fileName()),fileExt:()=>Qe.getExtension(this.fileName()),iconClass:()=>Qe.getIconClass(this.fileExt(),this.mimeType())})}}class MimeHeaderAutocryptModel{constructor(e){this.addr="",this.prefer_encrypt="nopreference",this.keydata="",e&&(e.split(";").forEach(e=>{const t=e=>(e||"").trim().replace(/^["']|["']+$/g,"");this[t((e=e.match(/^([^=]+)=(.*)$/))[1]).replace("-","_")]=t(e[2])}),this.keydata=this.keydata.replace(/\s+/g,"\n"))}toString(){let e=`addr=${this.addr}; `;return"mutual"===this.prefer_encrypt&&(e+="prefer-encrypt=mutual; "),e+"keydata="+this.keydata.replace(/\n/g,"\n ")}pem(){return"-----BEGIN PGP PUBLIC KEY BLOCK-----\n\n"+this.keydata+"\n-----END PGP PUBLIC KEY BLOCK-----"}}class FolderSystemPopupView extends AbstractViewPopup{constructor(){super("FolderSystem"),this.notification=ko.observable(""),this.folderSelectList=Ae(()=>Ui(Tt.systemFoldersNames(),[["",de("POPUPS_SYSTEM_FOLDERS/SELECT_CHOOSE_ONE")],[gt,de("POPUPS_SYSTEM_FOLDERS/SELECT_UNUSE_NAME")]])),this.sentFolder=Tt.sentFolder,this.draftsFolder=Tt.draftsFolder,this.spamFolder=Tt.spamFolder,this.trashFolder=Tt.trashFolder,this.archiveFolder=Tt.archiveFolder;const e=(()=>Tt.saveSystemFolders()).debounce(1e3);Te(Tt,{sentFolder:e,draftsFolder:e,spamFolder:e,trashFolder:e,archiveFolder:e}),this.defaultOptionsAfterRender=y}onShow(e=0){let t="",s="POPUPS_SYSTEM_FOLDERS/NOTIFICATION_";switch(e){case et.Sent:t=de(s+"SENT");break;case et.Drafts:t=de(s+"DRAFTS");break;case et.Junk:t=de(s+"SPAM");break;case et.Trash:t=de(s+"TRASH");break;case et.Archive:t=de(s+"ARCHIVE")}this.notification(t)}}const Lr="Compose",xr=D("template"),Ir=e=>e?b(e).match(/.{1,76}/g).join("\r\n"):"",Pr=e=>as(e)[0]?.email||!1,Or=(e,t)=>e.filter(e=>e.email).map(e=>e.toLine(t)).join(", "),Nr=()=>{const e=Tt.draftsFolder();e&&gt!==e&&(wt(e,""),Tt.currentFolderFullName()===e?Pi.reload(!0):_i(e))},Dr=e=>(e=e.map(e=>e.email),ci.find(t=>e.includes(t.email))),Rr=(e,t)=>{if(h(t)){const s=e().trim();e(s+(s?", ":"")+t.map(e=>e?e.toLine():null).validUnique().join(", ").trim())}},Vr=()=>"Plain"===Mt.editorDefaultType(),Ur=(e,t)=>{e=e.toUpperCase().trim(),t=t.replace(/\s+/g," ").trim();let s=!1,i="RE"===e,r="FWD"===e;const a=[],o=!r;return t&&t.split(":").forEach(e=>{const t=e.trim();s||!/^(RE|FWD)$/i.test(t)&&!/^(RE|FWD)[[(][\d]+[\])]$/i.test(t)?(a.push(e),s=!0):(i||(i=!!/^RE/i.test(t)),r||(r=!!/^FWD/i.test(t)))}),o?i=!1:r=!1,((o?"Re: ":"Fwd: ")+(i?"Re: ":"")+(r?"Fwd: ":"")+a.join(":").trim()).trim()};ko.extenders.toggleSubscribe=(e,t)=>(e.subscribe(t[1],t[0],"beforeChange"),e.subscribe(t[2],t[0]),e);class MimePart{constructor(){this.headers={},this.body="",this.boundary="",this.children=[]}toString(){const e=this.children.length,t=this.boundary||(this.boundary="part"+Jua.randomId()),s=this.headers;e&&!s["Content-Type"].includes(t)&&(s["Content-Type"]+=`; boundary="${t}"`);let i=Object.entries(s).map(([e,t])=>`${e}: ${t}`).join("\r\n")+"\r\n";return this.body&&(i+="\r\n"+this.body.replace(/\r?\n/g,"\r\n")),e&&(this.children.forEach(e=>i+="\r\n--"+t+"\r\n"+e),i+="\r\n--"+t+"--\r\n"),i}}class ComposePopupView extends AbstractViewPopup{constructor(){super("Compose");const e=(e,t,s,i)=>{const r=e&&t?.[s]();if(r&&(i||e[s]())){let t=e[s]().trim().split(",");t=t.filter(e=>(e=e.trim())&&r.trim()!==e),i&&t.push(r),e[s](t.join(","))}};this.oEditor=null,this.sLastFocusedField="to",this.allowContacts=Os.allowContacts(),this.allowIdentities=x("Identities"),this.allowSpellcheck=Mt.allowSpellcheck,Ce(this,{identitiesMenu:null,from:"",to:"",cc:"",bcc:"",replyTo:"",subject:"",isHtml:!1,requestDsn:!1,requestReadReceipt:!1,requireTLS:!1,markAsImportant:!1,sendError:!1,sendSuccessButSaveError:!1,savedError:!1,sendErrorDesc:"",savedErrorDesc:"",savedTime:0,emptyToError:!1,attachmentsInProcessError:!1,attachmentsInErrorError:!1,showCc:!1,showBcc:!1,showReplyTo:!1,doSign:!1,doEncrypt:!1,draftsFolder:"",draftUid:0,sending:!1,saving:!1,viewArea:"body",attacheMultipleAllowed:!1,addAttachmentEnabled:!1,editorArea:null,currentIdentity:ci()[0]}),["to","cc","bcc"].forEach(e=>{this[e].focused=ko.observable(!1),this[e].focused.subscribe(t=>t&&(this.sLastFocusedField=e))}),this.attachments=xe(),this.encryptOptions=xe(),this.signOptions=xe(),this.dragAndDropOver=ko.observable(!1).extend({debounce:1}),this.dragAndDropVisible=ko.observable(!1).extend({debounce:1}),this.currentIdentity.extend({toggleSubscribe:[this,t=>{e(this,t,"bcc"),e(this,t,"replyTo")},t=>{e(this,t,"bcc",!0),e(this,t,"replyTo",!0)}]}),this.doClose=this.doClose.debounce(200),this.iTimer=0,ke(this,{sendButtonSuccess:()=>!this.sendError()&&!this.sendSuccessButSaveError(),savedTimeText:()=>this.savedTime()?de("COMPOSE/SAVED_TIME",{TIME:this.savedTime().format("LT")}):"",emptyToErrorTooltip:()=>this.emptyToError()?de("COMPOSE/EMPTY_TO_ERROR_DESC"):"",attachmentsErrorTooltip:()=>{let e="";switch(!0){case this.attachmentsInProcessError():e=de("COMPOSE/ATTACHMENTS_UPLOAD_ERROR_DESC");break;case this.attachmentsInErrorError():e=de("COMPOSE/ATTACHMENTS_ERROR_DESC")}return e},attachmentsInProcess:()=>this.attachments.filter(e=>e&&!e.complete()),attachmentsInError:()=>this.attachments.filter(e=>e?.error()),attachmentsCount:()=>this.attachments().length,attachmentsInErrorCount:()=>this.attachmentsInError.length,attachmentsInProcessCount:()=>this.attachmentsInProcess.length,isDraft:()=>this.draftsFolder()&&this.draftUid(),canEncrypt:()=>this.encryptOptions().length,canMailvelope:()=>this.encryptOptions.includes("Mailvelope"),canSign:()=>this.signOptions().length,encryptOptionsText:()=>this.encryptOptions().join(", "),signOptionsText:()=>this.signOptions().map(e=>e[0]).join(", "),identitiesOptions:()=>ci.map(e=>({item:e,optValue:e.id(),optText:e})),canBeSentOrSaved:()=>!this.sending()&&!this.saving()}),Te(this,{sendError:e=>!e&&this.sendErrorDesc(""),savedError:e=>!e&&this.savedErrorDesc(""),sendSuccessButSaveError:e=>!e&&this.savedErrorDesc(""),currentIdentity:e=>{e&&(this.from(e.toString()),this.doEncrypt(e.pgpEncrypt()||Mt.pgpEncrypt()),this.doSign(e.pgpSign()||Mt.pgpSign()))},from:()=>{this.initSign(),this.initEncrypt()},cc:e=>{!1===this.showCc()&&e.length&&this.showCc(!0),this.initEncrypt()},bcc:e=>{!1===this.showBcc()&&e.length&&this.showBcc(!0),this.initEncrypt()},replyTo:e=>{!1===this.showReplyTo()&&e.length&&this.showReplyTo(!0)},attachmentsInErrorCount:e=>{0===e&&this.attachmentsInErrorError(!1)},to:e=>{this.emptyToError()&&e.length&&this.emptyToError(!1),this.initEncrypt()},attachmentsInProcess:e=>{this.attachmentsInProcessError()&&h(e)&&this.attachmentsInProcessError(!1)},viewArea:e=>{if(!this.mailvelope&&"mailvelope"==e){let e=Tr&&Tr.body.classList.contains("mailvelope")?Tr.plain():this.oEditor.getData(),t=this.isDraft(),s=ni.isEncrypted(e),i=F("phpUploadSizes").post_max_size,r=f(i);switch(i.slice(-1)){case"G":r*=1024;case"M":r*=1024;case"K":r*=1024}mailvelope.createEditorContainer("#mailvelope-editor",ni.mailvelopeKeyring,{quota:Math.max(2048,r/1024)-48,armoredDraft:s&&t?e:"",predefinedText:s?"":this.oEditor.isHtml()?Yt(e):e,quotedMail:s&&!t?e:""}).then(e=>this.mailvelope=e)}}}),Ps(this,{sendCommand:e=>e.canBeSentOrSaved(),saveCommand:e=>e.canBeSentOrSaved(),deleteCommand:e=>e.isDraft(),skipCommand:e=>e.canBeSentOrSaved(),contactsCommand:e=>e.allowContacts}),this.from(ci()[0].toString())}sentFolder(){let e=this.currentIdentity()?.sentFolder?.()||Tt.sentFolder();return Mt.replySameFolder()&&3===h(this.aDraftInfo)&&this.aDraftInfo[2]?.length&&(e=this.aDraftInfo[2]),gt===e?null:e}sendCommand(){if(this.attachmentsInProcessError(!1),this.attachmentsInErrorError(!1),this.emptyToError(!1),this.attachmentsInProcess().length?(this.attachmentsInProcessError(!0),this.attachmentsArea()):this.attachmentsInError().length&&(this.attachmentsInErrorError(!0),this.attachmentsArea()),this.to().trim()||this.cc().trim()||this.bcc().trim()||this.emptyToError(!0),!this.emptyToError()&&!this.attachmentsInErrorError()&&!this.attachmentsInProcessError()){const e=this.sentFolder();if(""===e)Ls(FolderSystemPopupView,[et.Sent]);else{const t=e=>{console.error(e),this.sendError(!0),this.sendErrorDesc(e),this.sending(!1)},s=(e,t)=>{this.sendError(!0),this.sendErrorDesc(fe(e,t?.message,c.CantSendMessage)+"\n"+(t?.messageAdditional||t?.message))};try{this.sendError(!1),this.sending(!0);const i=e=>{qs.request("SendMessage",(t,i)=>{if(this.sending(!1),t)if(c.CantSaveMessage===t){this.sendSuccessButSaveError(!0);let e=de("COMPOSE/SAVED_ERROR_ON_SEND");i?.messageAdditional&&(e=e+"\n"+i?.messageAdditional),this.savedErrorDesc(e)}else{this.sendError(!0),s(t,i);let r="S/MIME"===e.sign?this.currentIdentity():null;e.signFingerprint&&this.signOptions.forEach(e=>"GnuPG"===e[0]&&(r=e[1])),r&&Ks.delete(r)}else{if(h(this.aDraftInfo)>0){const e={reply:"\\answered",forward:"$forwarded"}[this.aDraftInfo[0]];if(e){const t=Tr.flags();-1===t.indexOf(e)&&(t.push(e),Tr.flags(t))}}this.close()}wt(this.draftsFolder(),""),wt(e.saveFolder,""),3===h(this.aDraftInfo)&&wt(this.aDraftInfo[2],""),Nr()},e,3e4)};this.getMessageRequestParams(e).then(i).catch(t)}catch(e){t(e)}}}}saveCommand(){this.saving()||this.sending()||(Tt.draftsFolderNotEnabled()?Ls(FolderSystemPopupView,[et.Drafts]):(this.savedError(!1),this.saving(!0),this.autosaveStart(),this.getMessageRequestParams(Tt.draftsFolder(),1).then(e=>{qs.request("SaveMessage",(e,t)=>{let s=!1;if(this.saving(!1),!e&&t.Result.folder&&t.Result.uid){if(s=!0,this.bFromDraft){const e=bi.message();e&&this.draftsFolder()===e.folder&&this.draftUid()==e.uid&&bi.message(null)}this.draftsFolder(t.Result.folder),this.draftUid(t.Result.uid),this.savedTime(new Date),this.bFromDraft&&wt(this.draftsFolder(),""),wt(Tt.draftsFolder(),"")}s||(this.savedError(!0),this.savedErrorDesc(fe(c.CantSaveMessage))),Nr()},e,2e5)}).catch(e=>{this.saving(!1),this.savedError(!0),this.savedErrorDesc(fe(c.CantSaveMessage)+": "+e)})))}deleteCommand(){AskPopupView.hidden()&&Ls(AskPopupView,[de("POPUPS_ASK/DESC_WANT_DELETE_MESSAGES"),()=>{const e=this.draftsFolder(),t=new Set([this.draftUid()]);Pi.moveMessages(e,t),this.close()}])}onClose(){return this.skipCommand(),!1}skipCommand(){ComposePopupView.inEdit(!0),!Tt.draftsFolderNotEnabled()&&Mt.allowDraftAutosave()&&this.saveCommand(),this.doClose()}contactsCommand(){this.allowContacts&&setTimeout(()=>{Ls(ContactsPopupView,[!0,this.sLastFocusedField])},200)}autosaveStart(){clearTimeout(this.iTimer),this.iTimer=setTimeout(()=>{!this.modalVisible()||Tt.draftsFolderNotEnabled()||!Mt.allowDraftAutosave()||this.isEmptyForm(!1)||this.savedError()||this.saveCommand(),this.autosaveStart()},6e4)}emailsSource(e,t){qs.abort("Suggestions").request("Suggestions",(e,s)=>{!e&&d(s.Result)?t(s.Result.map(e=>e?.[0]?new EmailModel(e[0],e[1]).toLine():null).filter(e=>e)):c.RequestAborted!==e&&t([])},{Query:e})}selectIdentity(e){e=e?.item,e&&(this.currentIdentity(e),this.setSignature(e))}onHide(){clearTimeout(this.iTimer),ComposePopupView.inEdit()||this.reset(),this.to.focused(!1)}dropMailvelope(){this.mailvelope&&(k("mailvelope-editor").textContent="",this.mailvelope=null)}editor(e){e&&this.editorArea()&&(this.oEditor?e(this.oEditor):this.oEditor=new HtmlEditor(this.editorArea(),()=>e(this.oEditor),e=>this.isHtml(!!e)))}setSignature(e,t){e&&it.Draft!==t&&it.EditAsNew!==t&&this.editor(t=>{let s=e.signature()||"",i=s.startsWith(":HTML:"),r=Tr?Or(Tr.from,!0):"";r&&(s=s.replace(/{{FROM-FULL}}/g,r),!r.includes(" ")&&0<r.indexOf("@")&&(r=r.replace(/@\S+/,"")),s=s.replace(/{{FROM}}/g,r)),s=(i?s.slice(6):s).replace(/\r/g,"").replace(/\s{1,2}?{{FROM}}/g,"").replace(/\s{1,2}?{{FROM-FULL}}/g,"").replace(/{{DATE}}/g,(new Date).format({dateStyle:"full",timeStyle:"short"})).replace(/{{TIME}}/g,(new Date).format("LT")).replace(/{{MOMENT:[^}]+}}/g,""),s.length&&t.setSignature(s,i,!!e.signatureInsertBefore())})}onShow(e,t,s,i,r,a,o){this.autosaveStart(),this.viewModelDom.dataset.wysiwyg=Mt.editorDefaultType();let n={mode:e||it.Empty,to:s,cc:i,bcc:r,subject:a,text:o};1<h(t)?n.messages=t:n.message=d(t)?t[0]:t,ComposePopupView.inEdit()?it.Empty!==n.mode?Ls(AskPopupView,[de("COMPOSE/DISCARD_UNSAVED_DATA"),()=>this.initOnShow(n),null,!1]):(Rr(this.to,s),Rr(this.cc,i),Rr(this.bcc,r),a&&!this.subject()&&this.subject(a)):this.initOnShow(n),ComposePopupView.inEdit(!1)}initOnShow(e){const t={},s=Si.email();Tr=e.message,s&&(t[s]=!0),this.reset();let i=null;if(Tr)switch(e.mode){case it.Reply:case it.ReplyAll:case it.Forward:case it.ForwardAsAttachment:i=Dr(Tr.to.concat(Tr.cc,Tr.bcc))||Dr(Tr.from);break;case it.Draft:i=Dr(Tr.from.concat(Tr.replyTo))}if(i||!Tr||it.Reply!==e.mode&&it.ReplyAll!==e.mode||1!==Tr.to.length||(i=new IdentityModel,i.name=Tr.to[0].name,i.email=Tr.to[0].email),i=i||ci()[0],i&&(t[i.email]=!0),h(e.to)&&this.to(Or(e.to)),h(e.cc)&&this.cc(Or(e.cc)),h(e.bcc)&&this.bcc(Or(e.bcc)),e.mode&&Tr){let s,r="",a=ue(Tr.dateTimestamp(),"FULL"),o=Tr.subject(),n="",l=Tr.draftInfo;switch(e.mode){case it.Reply:case it.ReplyAll:if(it.Reply===e.mode)this.to(Or(Tr.replyEmails(t)));else{let e=Tr.replyAllEmails(t);this.to(Or(e[0])),this.cc(Or(e[1]))}this.subject(Ur("Re",o)),this.prepareMessageAttachments(Tr,e.mode),this.aDraftInfo=["reply",Tr.uid,Tr.folder],this.sInReplyTo=Tr.messageId,this.sReferences=(Tr.references+" "+Tr.messageId).trim(),Tr.headers().valuesByName("autocrypt").forEach(e=>{let t=new MimeHeaderAutocryptModel(e);t.addr&&t.keydata&&(ni.hasPublicKeyForEmails([t.addr])||ni.importKey(t.pem(),!0,!0))});break;case it.Forward:case it.ForwardAsAttachment:this.subject(Ur("Fwd",o)),this.prepareMessageAttachments(Tr,e.mode),this.aDraftInfo=["forward",Tr.uid,Tr.folder],this.sInReplyTo=Tr.messageId,this.sReferences=(Tr.references+" "+Tr.messageId).trim();break;case it.Draft:this.bFromDraft=!0,this.draftsFolder(Tr.folder),this.draftUid(Tr.uid);case it.EditAsNew:this.to(Or(Tr.to)),this.cc(Or(Tr.cc)),this.bcc(Or(Tr.bcc)),this.replyTo(Or(Tr.replyTo)),this.subject(o),this.prepareMessageAttachments(Tr,e.mode),this.aDraftInfo=3===h(l)?l:null,this.sInReplyTo=Tr.inReplyTo,this.sReferences=Tr.references}switch(xr.innerHTML=Tr.bodyAsHTML(),xr.content.querySelectorAll("img").forEach(e=>{e.src||e.dataset.xSrc||e.replaceWith(e.alt||e.title)}),n=xr.innerHTML.trim(),e.mode){case it.Reply:case it.ReplyAll:n="<br><br><p>"+de("COMPOSE/REPLY_MESSAGE_TITLE",{DATETIME:a,EMAIL:Tr.from.toString(!1,!0)})+":</p><blockquote>"+n.trim()+"</blockquote>";break;case it.Forward:r=Tr.cc.toString(!1,!0),n="<br><br><p>"+de("COMPOSE/FORWARD_MESSAGE_TOP_TITLE")+"</p><div>"+de("GLOBAL/FROM")+": "+Tr.from.toString(!1,!0)+"<br>"+de("GLOBAL/TO")+": "+Tr.to.toString(!1,!0)+(r.length?"<br>"+de("GLOBAL/CC")+": "+r:"")+"<br>"+de("COMPOSE/FORWARD_MESSAGE_TOP_SENT")+": "+Jt(a)+"<br>"+de("GLOBAL/SUBJECT")+": "+Jt(o)+"<br><br>"+n.trim()+"</div>";break;case it.ForwardAsAttachment:n="";break;default:s=ni.isEncrypted(n)||Vr()||!Tr.isHtml(),s&&(n=Tr.plain())}this.editor(t=>{s?(t.modePlain(),t.setPlain(n)):t.setHtml(n),this.setSignature(i,e.mode),this.setFocusInPopup()})}else it.Empty===e.mode?(this.subject(null!=e.subject?""+e.subject:""),this.editor(t=>{t.setHtml(e.text?""+e.text:""),Vr()&&t.modePlain(),this.setSignature(i),this.setFocusInPopup()})):e.messages?(e.messages.forEach(e=>this.addMessageAsAttachment(e)),this.editor(t=>{Vr()?t.setPlain(""):t.setHtml(""),this.setSignature(i,e.mode),this.setFocusInPopup()})):this.setFocusInPopup();const a=this.attachments.filter(e=>e&&!e.tempName()).map(e=>e.id);h(a)&&qs.request("MessageUploadAttachments",(e,t)=>{const s=t?.Result;a.forEach((t,i)=>{const a=this.getAttachmentById(t);a&&(a.waiting(!1).uploading(!1).complete(!0),e||!s?.[i]?a.error(be(r.NoFileUploaded)):(a.tempName(s[i].tempName),a.type(s[i].mimeType)))})},{attachments:a},999e3),this.currentIdentity(i)}setFocusInPopup(){setTimeout(()=>{this.to()?this.subject()?this.oEditor?.focus():this.viewModelDom.querySelector('input[name="subject"]').focus():this.to.focused(!0)},100)}doClose(){AskPopupView.hidden()&&(ComposePopupView.inEdit()||this.isEmptyForm()&&!this.draftUid()?this.close():Ls(AskPopupView,[de("POPUPS_ASK/DESC_WANT_CLOSE_THIS_WINDOW"),()=>this.close()]))}onBuild(e){const t=new Jua({action:Q("Upload"),clickElement:e.querySelector("#composeUploadButton"),dragAndDropElement:e.querySelector(".b-attachment-place")}),s=f(F("attachmentLimit"));t.on("onDragEnter",()=>{this.dragAndDropOver(!0)}).on("onDragLeave",()=>{this.dragAndDropOver(!1)}).on("onBodyDragEnter",()=>{this.attachmentsArea(),this.dragAndDropVisible(!0)}).on("onBodyDragLeave",()=>{this.dragAndDropVisible(!1)}).on("onProgress",(e,t,s)=>{let i=this.getAttachmentById(e);i&&i.progress(Math.floor(t/s*100))}).on("onSelect",(e,i)=>{this.dragAndDropOver(!1);const r=f(i.size,null),a=new ComposeAttachmentModel(e,i.fileName?i.fileName.toString():"",r);return this.addAttachment(a,1,t),!(0<r&&0<s&&s<r)||(a.waiting(!1).uploading(!0).complete(!0).error(de("UPLOAD/ERROR_FILE_IS_TOO_BIG")),!1)}).on("onStart",e=>{let t=this.getAttachmentById(e);t&&t.waiting(!1).uploading(!0).complete(!1)}).on("onComplete",(e,t,s)=>{const i=this.getAttachmentById(e),r=s?.Result||{},a=r.code,o=t&&r.Attachment;let n="";null!=a?n=be(a):o||(n=de("UPLOAD/ERROR_UNKNOWN")),i&&(n?i.waiting(!1).uploading(!1).complete(!0).error(n+"\n"+r.message):o&&(i.waiting(!1).uploading(!1).complete(!0),i.fileName(o.name),i.size(o.size?f(o.size):0),i.tempName(o.tempName?o.tempName:""),i.isInline=!1,i.type(o.mimeType)))}),this.addAttachmentEnabled(!0),_("q","meta",Lr,()=>!1),_("w","meta",Lr,()=>!1),_("m","meta",Lr,()=>(this.identitiesMenu().ddBtn.toggle(),!1)),_("arrowdown","meta",Lr,()=>(this.skipCommand(),!1)),_("s","meta",Lr,()=>(this.saveCommand(),!1)),_("save","",Lr,()=>(this.saveCommand(),!1)),_("enter","meta",Lr,()=>(this.sendCommand(),!1)),_("mailsend","",Lr,()=>(this.sendCommand(),!1)),_("escape,close","shift",Lr,()=>(this.doClose(),!1)),this.editor(e=>e[Vr()?"modePlain":"modeWysiwyg"]())}getAttachmentById(e){return this.attachments.find(t=>t&&e===t.id)}addMessageAsAttachment(e){if(e){const t=new ComposeAttachmentModel(e.requestHash,e.subject()+".eml",e.size);t.fromMessage=!0,t.complete(!0),this.addAttachment(t)}}addAttachment(e,t,s){s||e.waiting(!1).uploading(!0),e.cancel=()=>{this.attachments.remove(e),s?.cancel(e.id)},this.attachments.push(e),t&&this.attachmentsArea()}addAttachmentHelper(e,t,s){const i=new ComposeAttachmentModel(e,t,s);return this.addAttachment(i,1),i}prepareMessageAttachments(e,t){if(e){let s=[it.Reply,it.ReplyAll].includes(t);s||[it.Forward,it.Draft,it.EditAsNew].includes(t)?e.attachments.forEach(e=>{if(!s||e.isLinked()){const t=new ComposeAttachmentModel(e.download,e.fileName,e.estimatedSize,e.isInline(),e.isLinked(),e.cId,e.contentLocation);t.fromMessage=!0,t.type(e.mimeType),this.addAttachment(t)}}):it.ForwardAsAttachment===t&&this.addMessageAsAttachment(e)}}isEmptyForm(e=!0){const t=e?!this.attachments.length:!this.attachments.some(e=>e?.complete());return!this.to.length&&!this.cc.length&&!this.bcc.length&&!this.replyTo.length&&!this.subject.length&&t&&(!this.oEditor||!this.oEditor.getData())}reset(){this.to(""),this.cc(""),this.bcc(""),this.replyTo(""),this.subject(""),this.requestDsn(Mt.requestDsn()),this.requestReadReceipt(Mt.requestReadReceipt()),this.requireTLS(Mt.requireTLS()),this.markAsImportant(!1),this.bodyArea(),this.aDraftInfo=null,this.sInReplyTo="",this.bFromDraft=!1,this.sReferences="",this.sendError(!1),this.sendSuccessButSaveError(!1),this.savedError(!1),this.savedTime(0),this.emptyToError(!1),this.attachmentsInProcessError(!1),this.showCc(!1),this.showBcc(!1),this.showReplyTo(!1),this.doSign(Mt.pgpSign()),this.doEncrypt(Mt.pgpEncrypt()),this.attachments([]),this.dragAndDropOver(!1),this.dragAndDropVisible(!1),this.draftsFolder(""),this.draftUid(0),this.sending(!1),this.saving(!1),this.oEditor?.clear(),this.dropMailvelope()}attachmentsArea(){this.viewArea("attachments")}bodyArea(){this.viewArea("body")}allRecipients(){return[this.from(),this.to(),this.cc(),this.bcc()].join(",").split(",").map(e=>Pr(e.trim())).validUnique()}initSign(){let e=[],t=this.currentIdentity(),s=Pr(this.from()),i=ii.getPrivateKeyFor(s,1);i&&e.push(["OpenPGP",i]),i=$s.getPrivateKeyFor(s,1),i&&e.push(["GnuPG",i]),t.smimeKeyValid()&&t.smimeCertificateValid()&&t.email===s&&e.push(["S/MIME"]),console.dir({signOptions:e}),this.signOptions(e)}async initEncrypt(){const e=this.allRecipients(),t=[];if(e.length){$s.hasPublicKeyForEmails(e)&&t.push("GnuPG"),ii.hasPublicKeyForEmails(e)&&t.push("OpenPGP");const s=e.length,i=this.currentIdentity(),r=i.smimeKey()&&i.smimeCertificate()?i.email:null;s&&s===e.filter(e=>e==r||Er.find(t=>e==t.emailAddress&&t.smimeencrypt)).length&&t.push("S/MIME"),await ai.hasPublicKeyForEmails(e)?t.push("Mailvelope"):"mailvelope"===this.viewArea()&&this.bodyArea()}console.dir({encryptOptions:t}),this.encryptOptions(t)}async getMessageRequestParams(e,t){let s,i=this.oEditor.getData().trim(),r=0;const a={};this.attachments.forEach(e=>{e?.complete()&&e?.tempName()&&e?.enabled()&&(++r,a[e.tempName()]={name:e.fileName(),inline:e.isInline,cId:e.cId,location:e.contentLocation,type:e.mimeType()})});const o=this.currentIdentity(),n={identityID:o.id(),messageFolder:this.draftsFolder(),messageUid:this.draftUid(),saveFolder:e,from:this.from(),to:this.to(),cc:this.cc(),bcc:this.bcc(),replyTo:this.replyTo(),subject:this.subject(),draftInfo:this.aDraftInfo,inReplyTo:this.sInReplyTo,references:this.sReferences,markAsImportant:this.markAsImportant()?1:0,attachments:a,dsn:this.requestDsn()?1:0,requireTLS:this.requireTLS()?1:0,readReceiptRequest:this.requestReadReceipt()?1:0,autocrypt:[],linkedData:[]},l=t?[o.email]:this.allRecipients(),c=!t&&this.doSign()&&this.signOptions(),d=this.doEncrypt()&&this.encryptOptions(),h=this.oEditor.isHtml();if(h){xr.innerHTML=i,xr.content.querySelectorAll("img").forEach(e=>{e.dataset.xSrc&&(e.src=e.dataset.xSrc,e.removeAttribute("data-x-src"))}),i=xr.innerHTML.trim();do{s=i.length,i=i.replace(/(<[^>]+[;"'])\s*mso-[a-z-]+\s*:[^;"']+/gi,"$1").replace(/(<[^>]+)\s+data-hs-[a-z-]+=("[^"]+"|'[^']+')/gi,"$1")}while(s!=i.length);n.html=i,n.plain=Yt(i)}else n.plain=i;if(this.mailvelope&&"mailvelope"===this.viewArea())n.encrypted=t?await this.mailvelope.createDraft():await this.mailvelope.encrypt(l);else if(c.length||d.length){if(!t&&!r&&!i.length)throw de("COMPOSE/ERROR_EMPTY_BODY");let e=new MimePart;if(e.headers["Content-Type"]="text/"+(h?"html":"plain")+'; charset="utf-8"',e.headers["Content-Transfer-Encoding"]="base64",e.body=Ir(i),h){const t=new MimePart,s=new MimePart;t.headers["Content-Type"]="multipart/alternative",s.headers["Content-Type"]='text/plain; charset="utf-8"',s.headers["Content-Transfer-Encoding"]="base64",s.body=Ir(n.plain),t.children.push(s),t.children.push(e),e=t}let s=!1;for(let t=0;t<c.length;++t)if("OpenPGP"==c[t][0])try{let i=new MimePart;i.headers["Content-Type"]='multipart/signed; micalg="pgp-sha256"; protocol="application/pgp-signature"',i.headers["Content-Transfer-Encoding"]="7Bit",i.children.push(e);let r=new MimePart;r.headers["Content-Type"]='application/pgp-signature; name="signature.asc"',r.headers["Content-Transfer-Encoding"]="7Bit",r.body=await ii.sign(e.toString(),c[t][1],1),i.children.push(r),s=!0,n.html=n.plain="",n.signed=i.toString(),n.boundary=i.boundary,e=i;break}catch(e){console.error(e)}else if("GnuPG"==c[t][0]){let e=await $s.sign(c[t][1]);if(null!=e){n.signFingerprint=c[t][1].fingerprint,n.signPassphrase=e,s=!0;break}}else if("S/MIME"==c[t][0]&&(n.sign="S/MIME",o.smimeKeyEncrypted())){const e=await Ks.ask(o,de("SMIME/PRIVATE_KEY_OF",{EMAIL:o.email}),"CRYPTO/SIGN");null!=e&&(n.signPassphrase=e.password,e.remember&&Ks.handle(o,e.password),s=!0)}if(c.length&&!s)throw"Signing failed";if(d.length){const t=()=>Object.entries(ni.getPublicKeyOfEmails(l)||{}).forEach(([e,t])=>n.autocrypt.push({addr:e,keydata:t.replace(/-----(BEGIN|END) PGP PUBLIC KEY BLOCK-----/g,"").trim()}));for(let s=0;s<d.length;++s){if("OpenPGP"==d[s]){n.encrypted=await ii.encrypt(e.toString(),l),n.signed="",t();break}if("GnuPG"==d[s]){n.encryptFingerprints=JSON.stringify($s.getPublicKeyFingerprints(l)),t();break}if("S/MIME"==d[s]){n.encryptCertificates=[o.smimeCertificate()],Er.forEach(e=>{e.emailAddress!=o.email&&l.includes(e.emailAddress)&&n.encryptCertificates.push(e.id)});break}}}}return n}}ComposePopupView.inEdit=ko.observable(!1);class MailFolderList extends AbstractViewLeft{constructor(){super(),this.composeInEdit=ComposePopupView.inEdit,this.systemFolders=Tt.systemFolders,this.moveAction=cr,this.allowContacts=Os.allowContacts(),this.foldersFilter=Qi,this.filterUnseen=ko.observable(!1),this.accountEmail=Si.email,this.accounts=Si,ke(this,{foldersFilterVisible:()=>20<Tt.folderList().CountRec,folderListVisible:()=>{let e=Tt.folderList().visible();return 1===e.length&&e[0].isInbox()?e[0].visibleSubfolders():e}})}accountName(){const e=Si.email();return Si.find(t=>t.email==e)?.label()||IDN.toUnicode(e)}logoutClick(){rl.app.logout()}accountClick(e,t){let s=e?.email;return s&&0===t.button&&Si.email()!=s&&(Si.loading(!0),V(t),qs.request("AccountSwitch",t=>{t?(Si.loading(!1),alert("Account error: "+fe(t).replace("%EMAIL%",s)),e.isAdditional()&&Ls(AccountPopupView,[e])):rl.route.reload()},{Email:s})),!0}onBuild(s){document.querySelector(".rl-wrapper").classList.add("active");const i=e=>s.querySelector(e),r=(e,t)=>e.target.closestWithin(t,s);this.oContentScrollable=i(".b-content"),s.addEventListener("click",t=>{let s=r(t,".e-collapsed-sign");if(s){const e=ko.dataFor(s);if(e){const s=e.collapsed();return Xi(e.fullName,s),e.collapsed(!s),void V(t)}}if(s=r(t,"a"),s?.matches(".selectable")){t.preventDefault();const i=ko.dataFor(s);if(i){if(cr()){const e=t.ctrlKey||2===cr(),s=Pi.listCheckedOrSelectedUidsWithSubMails();cr(0),s.size&&Pi.moveMessages(s.folder,s,i.fullName,e)}else{Mt.usePreviewPane()||bi.message(null);let e="";t.target.matches(".flag-icon")&&!i.isFlagged()?e="flagged":i.unreadCount()&&t.clientX>s.getBoundingClientRect().right-25&&(e="unseen"),hasher.setHash(se(i.fullNameHash,1,e)),ut.isMobile()&&O(!0)}Os.focusedState(e)}}}),_("arrowup,arrowdown","",t,e=>{let t=[],i=0;return s.querySelectorAll("li a").forEach(e=>{(e.offsetHeight||e.getClientRects().length)&&(t.push(e),e.matches(".focused")&&(e.classList.remove("focused"),i=t.length-1))}),t.length&&("ArrowUp"===e.key?i&&--i:i<t.length-1&&++i,t[i].classList.add("focused"),this.scrollToFocused()),!1}),_("enter,open","",t,()=>{const t=i("li a.focused");return t&&(Os.focusedState(e),t.click()),!1}),_("space","",t,()=>{const e=i("li a.focused"),t=e&&ko.dataFor(e);if(t){const e=t.collapsed();Xi(t.fullName,e),t.collapsed(!e)}return!1}),_("escape,tab,arrowright","",t,()=>(Os.focusedState(e),cr(0),!1));const a=document.querySelector(".menu-accounts"),o=document.querySelector(".menu-accounts .menu-inner");a&&o&&(a.addEventListener("click",()=>{o.classList.toggle("active")}),document.addEventListener("click",e=>{!a.contains(e.target)&&o.classList.contains("active")&&o.classList.remove("active")}));const n=document.querySelector(".menu-profile"),l=document.querySelector(".menu-profile .menu-inner");n&&l&&(n.addEventListener("click",()=>{l.classList.toggle("active")}),document.addEventListener("click",e=>{!n.contains(e.target)&&l.classList.contains("active")&&l.classList.remove("active")}));const c=document.querySelector(".user-control__header .name__user");c&&(c.textContent=this.accountEmail())}scrollToFocused(){const e=this.oContentScrollable;if(e){let t,s=e.querySelector("li a.focused");if(s){const i=s.getBoundingClientRect(),r=e.getBoundingClientRect();i.top<r.top?t="start":i.bottom>r.bottom&&(t="end"),t&&s.scrollIntoView("start"===t)}}}composeClick(){yr()}clearFolderSearch(){Qi("")}createFolder(){Ls(FolderCreatePopupView)}configureFolders(){hasher.setHash(te("folders"))}contactsClick(){this.allowContacts&&Ls(ContactsPopupView)}}class FolderClearPopupView extends AbstractViewPopup{constructor(){super("FolderClear"),Ce(this,{folder:null,clearing:!1}),ke(this,{dangerDescHtml:()=>de("POPUPS_CLEAR_FOLDER/DANGER_DESC_HTML_1",{FOLDER:this.folder()?.localName()})}),Ps(this,{clearCommand:e=>!e.clearing()})}clearCommand(){const e=this.folder();e&&(this.clearing(!0),qs.request("FolderClear",t=>{e.totalEmails(0),e.unreadEmails(0),bi.message(null),Pi.reload(!0,!0),this.clearing(!1),t?alert(fe(t)):this.close()},{folder:e.fullName}))}onShow(e){this.clearing(!1),this.folder(e)}}class AdvancedSearchPopupView extends AbstractViewPopup{constructor(){super("AdvancedSearch"),Ce(this,{from:"",to:"",subject:"",text:"",keyword:"",repliedValue:-1,selectedDateValue:0,selectedTreeValue:"",hasAttachment:!1,starred:!1,unseen:!1}),ke(this,{showMultisearch:()=>Tt.hasCapability("MULTISEARCH"),keywords:()=>{const e=[{value:"",label:""}];return Tt.currentFolder().optionalTags().forEach(t=>{let s=t.toLowerCase();e.push({value:t,label:de("MESSAGE_TAGS/"+s,0,s)})}),e},showKeywords:()=>Tt.currentFolder().permanentFlags().some(kt),repliedOptions:()=>(le(),[{id:-1,name:""},{id:1,name:de("GLOBAL/YES")},{id:0,name:de("GLOBAL/NO")}]),selectedDates:()=>{le();let e="SEARCH/SINCE_",t="SEARCH/BEFORE_";return[{id:0,name:de("SEARCH/DATE_ALL")},{id:3,name:de(e+"3_DAYS")},{id:7,name:de(e+"7_DAYS")},{id:30,name:de(e+"MONTH")},{id:90,name:de(e+"3_MONTHS")},{id:180,name:de(e+"6_MONTHS")},{id:365,name:de(e+"YEAR")},{id:-3,name:de(t+"3_DAYS")},{id:-7,name:de(t+"7_DAYS")},{id:-30,name:de(t+"MONTH")},{id:-90,name:de(t+"3_MONTHS")},{id:-180,name:de(t+"6_MONTHS")},{id:-365,name:de(t+"YEAR")}]},selectedTree:()=>{le();let e="SEARCH/SUBFOLDERS_";return[{id:"",name:de(e+"NONE")},{id:"subtree-one",name:de(e+"SUBTREE_ONE")},{id:"subtree",name:de(e+"SUBTREE")}]}})}submitForm(){const e=this.buildSearchString();e&&Pi.mainSearch(e),this.close()}buildSearchString(){const e=this,t=new FormData,s=(e,s)=>s.length&&t.append(e,s);if(s("from",e.from().trim()),s("to",e.to().trim()),s("subject",e.subject().trim()),s("text",e.text().trim()),s("keyword",e.keyword()),s("in",e.selectedTreeValue()),0<e.selectedDateValue()){let t=new Date;t.setDate(t.getDate()-e.selectedDateValue()),s("since",t.toISOString().split("T")[0])}else if(-1>e.selectedDateValue()){let t=new Date;t.setDate(t.getDate()+e.selectedDateValue()),s("before",t.toISOString().split("T")[0])}let i=decodeURIComponent(new URLSearchParams(t).toString());return e.hasAttachment()&&(i+="&attachment"),e.unseen()&&(i+="&unseen"),e.starred()&&(i+="&flagged"),1==e.repliedValue()&&(i+="&answered"),0==e.repliedValue()&&(i+="&unanswered"),i.replace(/^&+/,"")}onShow(e){const t=this,s=new URLSearchParams("?"+e);t.from(p(s.get("from"))),t.to(p(s.get("to"))),t.subject(p(s.get("subject"))),t.text(p(s.get("text"))),t.keyword(p(s.get("keyword"))),t.selectedTreeValue(p(s.get("in"))),t.selectedDateValue(0),t.hasAttachment(s.has("attachment")),t.starred(s.has("flagged")),t.unseen(s.has("unseen")),s.has("answered")?t.repliedValue(1):s.has("unanswered")&&t.repliedValue(0)}}const _r=()=>Pi.hasCheckedOrSelected(),qr=(...e)=>Pi.setAction(...e),Br=(e,t)=>{let s=Pi.listCheckedOrSelectedUidsWithSubMails();s.size&&rl.app.moveMessagesToFolderType(e,s.folder,s,t)},Kr=e=>10>e?"0"+e:""+e,Hr=e=>e.getFullYear()+Kr(1+e.getMonth())+Kr(e.getDate()),Gr=e=>{vr(e)};let $r="";class MailMessageList extends AbstractViewRight{constructor(){super(),this.allowDangerousActions=x("DangerousActions"),this.messageList=Pi,this.archiveAllowed=Pi.archiveAllowed,this.canMarkAsSpam=Pi.canMarkAsSpam,this.isSpamFolder=Pi.isSpamFolder,this.composeInEdit=ComposePopupView.inEdit,this.isMobile=ut.isMobile,this.popupVisibility=xs,this.useCheckboxesInList=Mt.useCheckboxesInList,this.userUsageProc=Tt.quotaPercentage,this.hideDeleted=Mt.hideDeleted,Ce(this,{focusSearch:!1}),this.dragOver=ko.observable(!1).extend({throttle:1}),this.dragOverEnter=ko.observable(!1).extend({throttle:1});const e=M.app("attachmentsActions");this.attachmentsActions=ko.observableArray(h(e)?e:[]),ke(this,{sortSupported:()=>Tt.hasCapability("SORT")&&!Pi.threadUid(),messageListSearchDesc:()=>{const e=Pi().search;return e?de("MESSAGE_LIST/SEARCH_RESULT_FOR",{SEARCH:e}):""},messageListPaginator:gr(Pi.page,Pi.pageCount),checkAll:{read:()=>Pi.hasChecked(),write:e=>{e=!!e,Pi.forEach(t=>t.checked(e))}},inputSearch:{read:Pi.mainSearch,write:e=>$r=e},isIncompleteChecked:()=>{const e=Pi.listChecked().length;return e&&Pi().length>e},listGrouped:()=>{let e=Pi.threadUid(),t=Tt.sortMode()||"DATE";return Mt.listGrouped()&&(t.includes("DATE")||t.includes("FROM"))&&!e},timeFormat:()=>(Tt.sortMode()||"").includes("FROM")?"AUTO":"LT",groupedList:()=>{let e,t=[],s=Tt.sortMode()||"DATE";if(s.includes("FROM"))Pi.forEach(s=>{let i=s.from[0]?.email;e&&i==e.id||(e={id:i,label:s.from[0]?.toLine(),search:"from="+i,messages:[]},t.push(e)),e.messages.push(s)});else if(s.includes("DATE")){let s=Hr(new Date),i=Intl.RelativeTimeFormat?new Intl.RelativeTimeFormat(A.documentElement.lang,{numeric:"auto"}):0;Pi.forEach(r=>{let a,o=new Date(1e3*r.dateTimestamp()),n=Hr(o);e&&n==e.id||(a=i&&s==n?i.format(0,"day"):i&&s-1==n?i.format(-1,"day"):o.format({dateStyle:"full"},0,ie.hourCycle()),e={id:n,label:a,search:"on="+o.getFullYear()+"-"+Kr(1+o.getMonth())+"-"+Kr(o.getDate()),messages:[]},t.push(e)),e.messages.push(r)})}return t},sortText:()=>{let e=Tt.sortMode(),t=t=>e.includes(t),s=""===e||t("REVERSE");return e=e.split(/\s+/),t("FROM")?"@"+(s?"⬆":"⬇"):t("SUBJECT")?"𝐒"+(s?"⬆":"⬇"):t("SIZE")?"✉"+(s?"⬇":"⬆"):(t("ARRIVAL")?"📨":"📅")+(s?"⬇":"⬆")},downloadAsZipAllowed:()=>this.attachmentsActions.includes("zip")}),this.selector=new Selector(Pi,Pi.selectedMessage,Pi.focusedMessage,".messageListItem",".messageListItem .messageCheckbox"),this.selector.on("ItemSelect",e=>{e?Gr(e):bi.message(null)}),this.selector.on("MiddleClick",e=>vr(e,!0)),this.selector.on("ItemGetUid",e=>e?e.folder+"/"+e.uid:""),this.selector.on("canSelect",()=>Pi.canSelect()),this.selector.on("click",(e,t)=>{const s=e.target;if(s.closest(".flagParent")){if(t){const e=Pi.listCheckedOrSelected();qr(t.folder,t.isFlagged()?nt:ot,e.find(e=>e.uid==t.uid)?e:[t])}}else{if(!s.closest(".threads-len"))return 1;this.gotoThread(t)}}),this.selector.on("UpOrDown",e=>{if(!Pi.hasChecked()){e=e?-1:1;const t=Pi.page()+e;t>0&&t<=Pi.pageCount()&&(Mt.usePreviewPane()||bi.message()?this.selector.iSelectNextHelper=e:this.selector.iFocusedNextHelper=e,this.selector.unselect(),this.gotoPage(t))}}),addEventListener("mailbox.message-list.selector.go-down",e=>this.selector.newSelectPosition("ArrowDown",!1,e.detail)),addEventListener("mailbox.message-list.selector.go-up",e=>this.selector.newSelectPosition("ArrowUp",!1,e.detail)),addEventListener("mailbox.message.show",e=>{const t=e.detail.folder,s=e.detail.uid,i=Pi.find(e=>t===e?.folder&&s==e?.uid);if("INBOX"===t&&hasher.setHash(se(t)),i)this.selector.selectMessageItem(i);else if("INBOX"!==t&&hasher.setHash(se(t)),t&&s){let e=new MessageModel;e.folder=t,e.uid=s,Gr(e)}else bi.message(null)}),Pi.endHash.subscribe((()=>this.selector.scrollToFocused()).throttle(50)),Ps(this,{downloadAttachCommand:_r,downloadZipCommand:_r,forwardCommand:_r,deleteWithoutMoveCommand:_r,deleteCommand:()=>Pi.hasCheckedOrSelectedAndUndeleted(),undeleteCommand:()=>Pi.hasCheckedOrSelectedAndDeleted(),archiveCommand:_r,spamCommand:_r,notSpamCommand:_r,moveCommand:_r,copyCommand:_r})}changeSort(e,t){Tt.sortMode(t.target.closest("li").dataset.sort),this.reload()}clearListIsVisible(){return!this.messageListSearchDesc()&&!Pi.error()&&!Pi.endThreadUid()&&Pi().length&&(Pi.isSpamFolder()||Pi.isTrashFolder())&&x("DangerousActions")}clear(){x("DangerousActions")&&Ls(FolderClearPopupView,[Tt.currentFolder()])}reload(){Pi.isLoading()||Pi.reload(!1,!0)}forwardCommand(){yr([it.ForwardAsAttachment,Pi.listCheckedOrSelected()])}downloadZipCommand(){let e=[];Pi.forEach(t=>t.checked()&&e.push(t.requestHash)),mr(null,e,null,null,Pi().folder)}downloadAttachCommand(){let e=[];Pi.forEach(t=>{t.checked()&&t.attachments.forEach(t=>{!t.isLinked()&&t.download&&e.push(t.download)})}),mr(null,e)}deleteWithoutMoveCommand(){x("DangerousActions")&&Br(et.Trash,!0)}deleteCommand(){gt===Tt.trashFolder()?qr(Tt.currentFolderFullName(),lt,Pi.listCheckedOrSelected()):Br(et.Trash)}undeleteCommand(){qr(Tt.currentFolderFullName(),ct,Pi.listCheckedOrSelected())}archiveCommand(){Br(et.Archive)}spamCommand(){Br(et.Junk)}notSpamCommand(){Br(et.Inbox)}moveOrCopy(s,i,r){if(_r()){s&&i?.preventDefault&&V(i);let a=cr();Os.focusedState(a?e:t),cr(a?0:r)}}moveCommand(e,t){this.moveOrCopy(e,t,1)}copyCommand(e,t){this.moveOrCopy(e,t,2)}composeClick(){yr()}cancelSearch(){Pi.mainSearch(""),this.focusSearch(!1)}cancelThreadUid(){hasher.setHash(se(Tt.currentFolderFullNameHash(),Pi.pageBeforeThread(),Pi.listSearch()))}listSetSeen(){qr(Tt.currentFolderFullName(),rt,Pi.listCheckedOrSelected())}listSetAllSeen(){let e=Tt.currentFolderFullName(),t=Pi.endThreadUid();if(e){let s=0;const i=[];let r=Et(e);r&&(Pi.forEach(e=>{e.isUnseen()&&++s,e.flags.push("\\seen"),t&&i.push(e.uid)}),t?r.unreadEmails(Math.max(0,r.unreadEmails()-s)):r.unreadEmails(0),qs.request("MessageSetSeenToAll",null,{folder:e,setAction:1,threadUids:i.join(",")}))}}listUnsetSeen(){qr(Tt.currentFolderFullName(),at,Pi.listCheckedOrSelected())}listSetFlags(){qr(Tt.currentFolderFullName(),ot,Pi.listCheckedOrSelected())}listUnsetFlags(){qr(Tt.currentFolderFullName(),nt,Pi.listCheckedOrSelected())}seenMessagesFast(e){const t=Pi.listCheckedOrSelected();t.length&&qr(t[0].folder,e?rt:at,t)}gotoPage(e){e&&hasher.setHash(se(Tt.currentFolderFullNameHash(),e,Pi.listSearch(),Pi.threadUid()))}gotoThread(e){e?.threadsLen()&&(Pi.pageBeforeThread(Pi.page()),hasher.setHash(se(Tt.currentFolderFullNameHash(),1,Pi.listSearch(),e.uid)))}listEmptyMessage(){return this.dragOver()||Pi().length||Pi.isLoading()||Pi.error()?"":de("MESSAGE_LIST/EMPTY_"+(Pi.listSearch()?"SEARCH_":"")+"LIST")}onBuild(i){document.querySelector(".rl-wrapper").classList.add("active");const r=i.querySelector(".b-content"),a=(e,t)=>e.target.closestWithin(t,i);if(setTimeout(()=>{const e=i.querySelector(".messageList"),t=()=>{let t=Mt.usePreviewPane();br(e,5,t?1===t?"Width":"Height":0)};e&&(t(),addEventListener("rl-layout",t))},1),this.selector.init(r,e),K(i,{click:t=>{if(a(t,".toggleLeft"))N();else{ut.isMobile()&&O(!0),a(t,".messageList")&&s===Os.focusedState()&&Os.focusedState(e);let i=a(t,".e-paginator a");i&&this.gotoPage(ko.dataFor(i)?.value),a(t,".checkboxCheckAll")&&this.checkAll(!this.checkAll())}},dblclick:e=>{let t=ko.dataFor(a(e,".messageListItem"));t&&(t.threadsLen()?this.gotoThread(t):yi())}}),M.app("allowAppendMessage")){const e=i.querySelector(".listDragOver"),t=e=>{for(const t of e.dataTransfer.items)if("file"===t.kind&&Ie===t.type)return!0};K(e,{dragover:e=>{t(e)&&(e.dataTransfer.dropEffect="copy",e.preventDefault())}}),K(r,{dragenter:s=>{t(s)&&(r.contains(s.target)&&this.dragOver(!0),s.target==e&&(s.dataTransfer.dropEffect="copy",this.dragOverEnter(!0)))},dragleave:t=>{t.target==e&&this.dragOverEnter(!1);let s=t.relatedTarget;s&&r.contains(s)||this.dragOver(!1)},drop:s=>{s.preventDefault(),s.target==e&&t(s)&&(Pi.loading(!0),Bi(Tt.currentFolderFullName(),s.dataTransfer.files)),this.dragOverEnter(!1),this.dragOver(!1)}})}_("enter,open","",e,()=>U()?(Pi.mainSearch($r),!1):bi.message()&&Pi.canSelect()?(fi()||yi(),!1):void 0),q("z","",[e,s],()=>(this.archiveCommand(),!1)),q("delete","shift",e,()=>(Pi.listCheckedOrSelected().length&&this.deleteWithoutMoveCommand(),!1)),q("delete","",e,()=>(Pi.listCheckedOrSelected().length&&this.deleteCommand(),!1)),_("r","meta",[t,e,s],()=>(this.reload(),!1)),q("a","meta",e,()=>(this.checkAll(!(this.checkAll()&&!this.isIncompleteChecked())),!1)),q("w,c,new","",[e,s],()=>(yr(),!1)),q("i","",[e,s],()=>{const e=Pi.listCheckedOrSelected();return e.length&&qr(e[0].folder,e.every(e=>e.isFlagged())?nt:ot,e),!1}),q("t","",[e],()=>{let e=Pi.selectedMessage()||Pi.focusedMessage();return 0<e?.threadsLen()&&this.gotoThread(e),!1}),q("insert","",e,()=>(this.moveCommand(),!1)),q("q","",[e,s],()=>(this.seenMessagesFast(!0),!1)),q("u","",[e,s],()=>(this.seenMessagesFast(!1),!1)),q("f,mailforward","shift",[e,s],()=>(this.forwardCommand(),!1)),x("Search")&&_("/","",[e,s],()=>(this.focusSearch(!0),!1)),_("escape","",e,()=>this.messageListSearchDesc()?(this.cancelSearch(),!1):Pi.endThreadUid()?(this.cancelThreadUid(),!1):void 0),_("tab","shift",e,()=>(Os.focusedState(t),!1)),_("arrowleft","",e,()=>(Os.focusedState(t),!1)),_("tab,arrowright","",e,()=>{if(bi.message())return Os.focusedState(s),!1}),_("arrowleft","meta",s,()=>!1),_("arrowright","meta",s,()=>!1),_("f","meta",e,this.advancedSearchClick)}advancedSearchClick(){Ls(AdvancedSearchPopupView,[Pi.mainSearch()])}groupSearch(e){e.search&&Pi.mainSearch(e.search)}groupCheck(e){e.messages.forEach(e=>e.checked(!e.checked()))}quotaTooltip(){return de("MESSAGE_LIST/QUOTA_SIZE",{SIZE:Qe.friendlySize(Tt.quotaUsage()),PROC:Tt.quotaPercentage(),LIMIT:Qe.friendlySize(Tt.quotaLimit())}).replace(/<[^>]+>/g,"")}}class OpenPgpImportPopupView extends AbstractViewPopup{constructor(){super("OpenPgpImport"),Ce(this,{search:"",key:"",keyError:!1,keyErrorMessage:"",saveGnuPG:!0,saveServer:!0}),this.canGnuPG=$s.isSupported(),this.key.subscribe(()=>{this.keyError(!1),this.keyErrorMessage("")})}searchPGP(){this.key(de("SUGGESTIONS/SEARCHING_DESC"));const e=()=>qs.request("PgpSearchKey",(e,t)=>{e?this.key(t.message):this.key(t.Result)},{query:this.search()});fetch(`https://keys.openpgp.org/pks/lookup?op=get&options=mr&search=${this.search()}`,{method:"GET",mode:"cors",cache:"no-cache",redirect:"error",referrerPolicy:"no-referrer",credentials:"omit"}).then(t=>{"application/pgp-keys"==t.headers.get("Content-Type")?t.text().then(e=>this.key(e)):e()}).catch(t=>{throw this.key("keys.openpgp.org: "+t?.message+"\nTrying local..."),e(),t})}submitForm(){let e=this.key().trim();if(/\n/.test(e)&&(e=e.replace(/\r+/g,"").replace(/\n{2,}/g,"\n\n")),this.keyError(!e),this.keyErrorMessage(""),e){let t=null,s=30,i=!1;const r=this.saveGnuPG()&&$s.isSupported(),a=this.saveServer(),o=/[-]{3,6}BEGIN[\s]PGP[\s](PRIVATE|PUBLIC)[\s]KEY[\s]BLOCK[-]{3,6}[\s\S]+?[-]{3,6}END[\s]PGP[\s](PRIVATE|PUBLIC)[\s]KEY[\s]BLOCK[-]{3,6}/gi;do{t=o.exec(e),t&&0<s?(t[0]&&t[1]&&t[2]&&t[1]===t[2]&&ni.importKey(this.key(),r,a),--s,i=!1):i=!0}while(!i);this.close()}}onShow(e){this.key(e||""),this.keyError(!1),this.keyErrorMessage("")}}const jr=()=>k("messageItem")||{},Wr=bi.message,Jr=e=>{const t=Wr();t&&Pi.setAction(t.folder,e,[t])},zr=e=>rl.fetch(e).then(e=>e.ok&&e.text());let Yr=null;const Zr=async()=>{try{const e=window.location.origin,t=await fetch(`${e}/index.php/csrftoken`);if(console.debug("SnappyMail: fetchNextcloudRequestToken - Получен ответ:",t),!t.ok)return console.error("SnappyMail: fetchNextcloudRequestToken - Не удалось получить CSRF токен. HTTP статус:",t.status),null;const s=await t.json();return s&&s.token?(Yr=s.token,console.log("SnappyMail: fetchNextcloudRequestToken - CSRF токен Nextcloud успешно получен."),Xr(s.token),s.token):(console.error("SnappyMail: fetchNextcloudRequestToken - CSRF токен не найден в данных ответа.",s),null)}catch(e){return console.error("SnappyMail: fetchNextcloudRequestToken - Ошибка при получении CSRF токена Nextcloud:",e),null}},Xr=e=>{const t=document.getElementById("logout"),s=encodeURIComponent(e);t?(t.href=`/logout?requesttoken=${s}`,console.log("SnappyMail: updateLogoutLink - Ссылка выхода обновлена новым токеном.")):console.warn("SnappyMail: updateLogoutLink - Элемент ссылки выхода не найден.")};Zr().then(e=>{e&&(Yr=e,console.log("SnappyMail: Глобальная переменная nextcloudRequestToken обновлена полученным токеном."))});class MailMessageView extends AbstractViewRight{constructor(){super();const e=(e,t)=>{let s=()=>(t()&&e.call(null),!1);return s.canExecute=t,s},t=t=>e(()=>this.replyOrforward(t),this.canBeRepliedOrForwarded),s=(t,s)=>e(()=>{const e=Wr();e&&(Wr(null),rl.app.moveMessagesToFolderType(t,e.folder,new Set([e.uid]),s))},this.messageVisible);this.msgDefaultAction=Mt.msgDefaultAction,this.simpleAttachmentsList=Mt.simpleAttachmentsList,Ce(this,{showAttachmentControls:!!Wi(10),downloadAsZipLoading:!1,showFullInfo:"1"===Wi(9),actionsMenu:null,viewFromShort:"",dkimData:["none","",""],spfData:["none","",""],dmarcData:["none","",""],nowTracking:!1}),this.moveAction=cr;const i=M.app("attachmentsActions");this.attachmentsActions=ko.observableArray(h(i)?i:[]),this.hasCheckedMessages=Pi.hasChecked,this.archiveAllowed=Pi.archiveAllowed,this.canMarkAsSpam=Pi.canMarkAsSpam,this.isDraftFolder=Pi.isDraftFolder,this.isSpamFolder=Pi.isSpamFolder,this.message=Wr,this.messageLoadingThrottle=bi.loading,this.messageError=bi.error,this.fullScreenMode=fi,this.toggleFullScreen=yi,this.downloadAsZipError=ko.observable(!1).extend({falseTimeout:7e3}),this.messageDomFocused=ko.observable(!1).extend({rateLimit:0}),this.viewHash="",ke(this,{allowAttachmentControls:()=>h(i)&&x("AttachmentsActions"),downloadAsZipAllowed:()=>this.attachmentsActions.includes("zip")&&(Wr()?.attachments||[]).filter(e=>e?.checked()&&e?.download).length,tagsAllowed:()=>Tt.currentFolder()?.tagsAllowed(),messageVisible:()=>!bi.loading()&&!!Wr(),tagsToHTML:()=>Wr()?.flags().map(e=>kt(e)?'<span class="focused msgflag-'+e+'">'+de("MESSAGE_TAGS/"+e,0,e)+"</span>":"").join(" "),askReadReceipt:()=>Wr()?.readReceipt&&!(Pi.isDraftFolder()||Pi.isSentFolder())&&!Wr()?.flags().includes("$mdnsent")&&!Wr()?.flags().includes("\\answered"),listAttachments:()=>Wr()?.attachments().filter(e=>Mt.listInlineAttachments()||!e.isLinked()),hasAttachments:()=>Wr()?.attachments().some(e=>Mt.listInlineAttachments()||!e.isLinked()),canBeRepliedOrForwarded:()=>!Pi.isDraftFolder()&&this.messageVisible(),dkimIcon:()=>{switch(this.dkimData()[0]){case"none":return"🚫︎";case"pass":return"✔";default:return"✖"}},dkimIconClass:()=>"pass"===this.dkimData()[0]?"iconcolor-green":"iconcolor-red",dkimTitle:()=>{const e=this.dkimData();return e[0]?e[2]||"DKIM: "+e[0]:""},spfIcon:()=>{switch(this.spfData()[0]){case"none":return"🚫︎";case"pass":return"✔";default:return"✖"}},spfIconClass:()=>"pass"===this.spfData()[0]?"iconcolor-green":"iconcolor-red",spfTitle:()=>{const e=this.spfData();return e[0]?e[2]||"SPF: "+e[0]:""},dmarcIcon:()=>{switch(this.dmarcData()[0]){case"none":return"🚫︎";case"pass":return"✔";default:return"✖"}},dmarcIconClass:()=>"pass"===this.dmarcData()[0]?"iconcolor-green":"iconcolor-red",dmarcTitle:()=>{const e=this.dmarcData();return e[0]?e[2]||"DMARC: "+e[0]:""},showWhitelistOptions:()=>"match"===Mt.viewImages(),firstUnsubsribeLink:()=>Wr()?.unsubsribeLinks()[0]||"",pgpSupported:()=>Wr()&&ni.isSupported(),canBeUndeleted:()=>Wr()?.isDeleted(),messageListOrViewLoading:()=>Pi.isLoading()|bi.loading()}),Te(this,{message:e=>{e?(this.viewHash!==e.hash&&this.scrollMessageToTop(),this.viewHash=e.hash,this.viewFromShort(e.from.toString(!1,!0)),this.dkimData(e.dkim[0]||["none","",""]),this.spfData(e.spf[0]||["none","",""]),this.dmarcData(e.dmarc[0]||["none","",""]),this.nowTracking(!1)):(Pi.selectedMessage(null),this.viewHash="",this.scrollMessageToTop())},showFullInfo:e=>ji(9,e?"1":"0")}),this.replyCommand=t(it.Reply),this.replyAllCommand=t(it.ReplyAll),this.forwardCommand=t(it.Forward),this.forwardAsAttachmentCommand=t(it.ForwardAsAttachment),this.editAsNewCommand=t(it.EditAsNew),this.deleteCommand=(()=>e(()=>{if(gt===Tt.trashFolder())Jr(lt);else{const e=Wr();e&&(Wr(null),rl.app.moveMessagesToFolderType(et.Trash,e.folder,new Set([e.uid])))}},this.messageVisible))(),this.undeleteCommand=(t=>e(()=>Jr(t),this.messageVisible))(ct),this.deleteWithoutMoveCommand=s(et.Trash,!0),this.archiveCommand=s(et.Archive),this.spamCommand=s(et.Junk),this.notSpamCommand=s(et.Inbox),Ps(this,{editCommand:e=>e.messageVisible(),moveCommand:e=>e.messageVisible(),copyCommand:e=>e.messageVisible(),goUpCommand:e=>!e.messageListOrViewLoading(),goDownCommand:e=>!e.messageListOrViewLoading()}),this.showOnlyOfficeModal=ko.observable(!1),this.isOnlyOfficeLoading=ko.observable(!1),this.onlyOfficeIframeSrc=ko.observable(""),this.currentAttachmentFileName=ko.observable(""),this.currentAttachmentSrc=ko.observable(""),this.currentAttachmentMimeType=ko.observable(""),this.currentTempFileInfo=ko.observable(null),this.isImageViewerVisible=ko.observable(!1),this.isPdfTxtViewerVisible=ko.observable(!1),this.isUnsupportedViewerVisible=ko.observable(!1),this.officeMimeTypes=["application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/msword","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.presentationml.presentation","application/vnd.ms-powerpoint","text/rtf","text/plain","application/rtf","application/vnd.oasis.opendocument.text","application/vnd.oasis.opendocument.spreadsheet","application/vnd.oasis.opendocument.presentation","application/pdf"]}async getCurrentNextcloudUser(){try{console.log("SnappyMail: getCurrentNextcloudUser - Запрос на получение текущего пользователя Nextcloud.");const e=window.location.origin,t=await Zr();if(!t)return console.error("SnappyMail: getCurrentNextcloudUser - Не удалось получить токен Nextcloud для API-запроса."),null;const s=`${e}/ocs/v2.php/cloud/user?format=json`;console.log("SnappyMail: getCurrentNextcloudUser - Выполнение API-запроса к:",s);const i=await fetch(s,{method:"GET",headers:{"OCS-APIRequest":"true",requesttoken:t,"Content-Type":"application/json"},credentials:"include"});if(!i.ok){const e=await i.text();return console.error(`SnappyMail: getCurrentNextcloudUser - API-запрос не удался: ${i.status} - ${e}`),null}const r=await i.json();if(console.log("SnappyMail: getCurrentNextcloudUser - Ответ API:",r),r&&r.ocs&&r.ocs.data&&r.ocs.data.id){const e=r.ocs.data.id,t=r.ocs.data.displayname||e;return console.log(`SnappyMail: getCurrentNextcloudUser - Получен ID: "${e}", DisplayName: "${t}"`),{id:e,displayname:t}}return console.error("SnappyMail: getCurrentNextcloudUser - API-ответ не содержит ожидаемых данных пользователя (id)."),null}catch(e){return console.error("SnappyMail: getCurrentNextcloudUser - Ошибка при выполнении API-запроса:",e),null}}async ensureTempDirectoryExists(e){const t=await this.getCurrentNextcloudUser();if(!t||!t.id)throw console.error("SnappyMail: ensureTempDirectoryExists - Не удалось получить ID текущего пользователя Nextcloud. Отмена создания каталога."),new Error("Nextcloud user ID not found.");const s=t.id;if(!Yr)throw console.error("SnappyMail: ensureTempDirectoryExists - Nextcloud request token is not available. Отмена создания каталога."),new Error("Nextcloud request token not found.");const i=`${`/remote.php/dav/files/${s}/`}${e}`;console.log("SnappyMail: ensureTempDirectoryExists - Проверка существования каталога:",i);try{const e=await fetch(i,{method:"PROPFIND",headers:{"X-Requested-With":"XMLHttpRequest",requesttoken:Yr},credentials:"include"});if(console.log("SnappyMail: ensureTempDirectoryExists - PROPFIND response status:",e.status),207===e.status)return void console.log("SnappyMail: ensureTempDirectoryExists - Каталог уже существует.");if(404!==e.status){const t=await e.text();throw console.error("SnappyMail: ensureTempDirectoryExists - Неожиданный статус PROPFIND при проверке каталога:",e.status,t),new Error(`PROPFIND failed with status ${e.status}`)}console.log("SnappyMail: ensureTempDirectoryExists - Каталог не найден, попытка создать.")}catch(e){throw console.error("SnappyMail: ensureTempDirectoryExists - Ошибка PROPFIND при проверке каталога:",e),e}try{console.log("SnappyMail: ensureTempDirectoryExists - Попытка создать каталог:",i);const e=await fetch(i,{method:"MKCOL",headers:{"X-Requested-With":"XMLHttpRequest",requesttoken:Yr},credentials:"include"});if(console.log("SnappyMail: ensureTempDirectoryExists - MKCOL response status:",e.status),201===e.status)console.log("SnappyMail: ensureTempDirectoryExists - Каталог успешно создан.");else{if(405!==e.status){const t=await e.text();throw console.error("SnappyMail: ensureTempDirectoryExists - Неизвестный статус при создании каталога:",e.status,t),new Error("Не удалось создать временный каталог.")}console.log("SnappyMail: ensureTempDirectoryExists - Каталог уже существует (получен 405 при MKCOL).")}}catch(e){throw console.error("SnappyMail: ensureTempDirectoryExists - Ошибка при создании временного каталога:",e),e}}async getOnlyOfficeFrameUrl(e){console.log("SnappyMail: getOnlyOfficeFrameUrl - Начало процесса загрузки и получения fileId для:",e.fileName);const t=e.linkDownload(),s=e.fileName,i=e.mimeType;if(!Yr)return console.error("SnappyMail: getOnlyOfficeFrameUrl - Не удалось получить токен Отмена операции."),null;const r=await this.getCurrentNextcloudUser();if(!r||!r.id)return console.error("SnappyMail: getOnlyOfficeFrameUrl - Не удалось получить ID текущего пользователя Nextcloud. Отмена операции."),null;const a=r.id,o="Temp";try{console.debug("SnappyMail: getOnlyOfficeFrameUrl - Шаг 1/5 - Загрузка файла вложения как Blob из:",t);const e=await fetch(t,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest",requesttoken:Yr},credentials:"include"});if(!e.ok){const t=await e.text();throw new Error(`Failed to download attachment: ${e.status} - ${t}`)}const r=await e.blob();console.log("SnappyMail: getOnlyOfficeFrameUrl - Шаг 1/5 - Файл вложения успешно загружен в Blob. Размер:",r.size,"байт.");const n=`${o}/${`snappymail_${Date.now()}_${s.replace(/[^a-zA-Z0-9.\-_]/g,"_")}`}`;console.debug("SnappyMail: getOnlyOfficeFrameUrl - Шаг 2/5 - Сформировано временное имя файла и путь:",n),await this.ensureTempDirectoryExists(o);const l=`/remote.php/dav/files/${a}/${n}`;console.debug("SnappyMail: getOnlyOfficeFrameUrl - Шаг 3/5 - Загрузка файла в Nextcloud по PUT запросу на URL:",l);const c=await fetch(l,{method:"PUT",headers:{"Content-Type":i,"X-Requested-With":"XMLHttpRequest",requesttoken:Yr},body:r,credentials:"include"});if(!c.ok){const e=await c.text();throw new Error(`Failed to upload file to Nextcloud: ${c.status} - ${e}`)}console.log("SnappyMail: getOnlyOfficeFrameUrl - Шаг 3/5 - Файл успешно загружен во временную папку Nextcloud.");const d=`/remote.php/dav/files/${a}/${n}`;console.debug("SnappyMail: getOnlyOfficeFrameUrl - Шаг 4/5 - Получение fileId через PROPFIND запрос к:",d);const h=await fetch(d,{method:"PROPFIND",headers:{"Content-Type":"application/xml","X-Requested-With":"XMLHttpRequest",requesttoken:Yr},body:'<?xml version="1.0"?>\n                        <d:propfind xmlns:d="DAV:">\n                            <d:prop>\n                                <oc:fileid xmlns:oc="http://owncloud.org/ns"/>\n                            </d:prop>\n                        </d:propfind>'});if(!h.ok){const e=await h.text();throw new Error(`Failed PROPFIND for fileId: ${h.status} - ${e}`)}const u=await h.text();console.log("SnappyMail: getOnlyOfficeFrameUrl - Шаг 4/5 - PROPFIND запрос выполнен. Статус:",h.status,"Ответ:",u);const p=new DOMParser,m=p.parseFromString(u,"text/xml").getElementsByTagName("oc:fileid")[0],g=m?m.textContent:null;if(!g)throw console.error("SnappyMail: getOnlyOfficeFrameUrl - Шаг 5/5 - ОШИБКА: Не удалось получить file ID из ответа PROPFIND. Ответ:",u),new Error("Could not get file ID from server response");console.debug("SnappyMail: getOnlyOfficeFrameUrl - Шаг 5/5 - fileId успешно получен:",g),this.currentTempFileInfo({id:g,path:n}),console.log("SnappyMail: getOnlyOfficeFrameUrl - Сохранена информация о временном файле:",this.currentTempFileInfo());const f=`/apps/onlyoffice/${g}?inframe=true&filePath=`+this.currentTempFileInfo().path;return console.log("SnappyMail: getOnlyOfficeFrameUrl - Успех! Сформирован конечный URL Nextcloud Files Viewer:",f),f}catch(e){return console.error("SnappyMail: getOnlyOfficeFrameUrl - Общая ошибка в процессе интеграции OnlyOffice:",e),e.response?console.error("SnappyMail: getOnlyOfficeFrameUrl - Ошибка ответа сервера (возможно, из-за axios, который удален):",e.response.status,e.response.data):e.request?console.error("SnappyMail: getOnlyOfficeFrameUrl - Нет ответа от сервера (возможно, из-за axios, который удален):",e.request):console.error("SnappyMail: getOnlyOfficeFrameUrl - Ошибка при настройке запроса или выполнении fetch:",e.message),this.isUnsupportedViewerVisible(!0),this.isOnlyOfficeLoading(!1),null}}async openAttachmentInViewer(e){console.trace("SnappyMail: openAttachmentInViewer - Вызов openAttachmentInViewer"),console.log("SnappyMail: openAttachmentInViewer - Клик по вложению для предпросмотра ~"),console.log("SnappyMail: openAttachmentInViewer - Вызов openAttachmentInViewer. Имя файла:",e.fileName,"MIME-тип:",e.mimeType),this.currentAttachmentFileName(e.fileName),this.currentAttachmentSrc(e.linkDownload()),this.currentAttachmentMimeType(e.mimeType),this.isOnlyOfficeLoading(!0),this.showOnlyOfficeModal(!0),this.isImageViewerVisible(!1),this.isPdfTxtViewerVisible(!1),this.isUnsupportedViewerVisible(!1),this.onlyOfficeIframeSrc("");const t=e.fileName.toLowerCase().split(".").pop(),s=e.mimeType.toLowerCase();if(console.log("SnappyMail: openAttachmentInViewer - Проверка условий OnlyOffice/Nextcloud Files."),console.log("SnappyMail: openAttachmentInViewer - officeMimeTypes:",this.officeMimeTypes),console.log("SnappyMail: openAttachmentInViewer - current MIME-type:",s),["jpg","jpeg","png","gif","bmp","webp","svg"].includes(t)||s.startsWith("image/"))console.log("SnappyMail: openAttachmentInViewer - Открытие встроенного предпросмотра изображения для:",e.fileName),this.isImageViewerVisible(!0),this.isOnlyOfficeLoading(!1);else if(["pdf","txt"].includes(t)||s.includes("pdf")||s.includes("text/plain"))console.log("SnappyMail: openAttachmentInViewer - Открытие встроенного предпросмотра PDF/текста для:",e.fileName),this.isPdfTxtViewerVisible(!0),this.onlyOfficeIframeSrc(e.linkPreviewMain()),this.isOnlyOfficeLoading(!1);else if(this.officeMimeTypes.includes(s)){console.log("SnappyMail: openAttachmentInViewer - Офисный документ обнаружен для просмотра через Nextcloud Files. MIME-тип:",s);try{const t=await this.getOnlyOfficeFrameUrl(e);t?(console.log("SnappyMail: openAttachmentInViewer - Получен URL для просмотра Nextcloud Files:",t),this.onlyOfficeIframeSrc(t),this.isOnlyOfficeLoading(!1)):(console.warn("SnappyMail: openAttachmentInViewer - Не удалось получить URL для просмотра через Nextcloud Files. Будет показано сообщение о неподдерживаемом файле."),this.isUnsupportedViewerVisible(!0),this.isOnlyOfficeLoading(!1))}catch(e){console.error("SnappyMail: openAttachmentInViewer - Ошибка при генерации или использовании URL Nextcloud Files/OnlyOffice:",e),this.isUnsupportedViewerVisible(!0),this.isOnlyOfficeLoading(!1)}}else console.log("SnappyMail: openAttachmentInViewer - Предпросмотр не поддерживается для MIME-типа:",s),this.isUnsupportedViewerVisible(!0),this.isOnlyOfficeLoading(!1)}handleOnlyOfficeLoaded(){console.log("SnappyMail: handleOnlyOfficeLoaded - Nextcloud Files iframe (возможно, с OnlyOffice) загружен."),this.isOnlyOfficeLoading(!1)}async closeOnlyOfficeModal(){this.showOnlyOfficeModal(!1),this.isOnlyOfficeLoading(!1),this.onlyOfficeIframeSrc(""),this.isImageViewerVisible(!1),this.isPdfTxtViewerVisible(!1),this.isUnsupportedViewerVisible(!1),this.currentAttachmentFileName(""),this.currentAttachmentSrc(""),this.currentAttachmentMimeType("");const e=this.currentTempFileInfo();if(e&&e.path){const t=await this.getCurrentNextcloudUser();if(!t||!t.id)return void console.error("SnappyMail: closeOnlyOfficeModal - Не удалось получить ID текущего пользователя Nextcloud для удаления файла.");const s=t.id;if(!Yr)return void console.error("SnappyMail: closeOnlyOfficeModal - Nextcloud request token is not available для удаления файла.");console.log(`SnappyMail: closeOnlyOfficeModal - Попытка удалить временный файл: ${e.path} для пользователя ${s}`);try{const t=await fetch(`/remote.php/dav/files/${s}/${e.path}`,{method:"DELETE",headers:{"X-Requested-With":"XMLHttpRequest",requesttoken:Yr},credentials:"include"});if(!t.ok){const e=await t.text();throw new Error(`Failed to delete temporary file: ${t.status} - ${e}`)}console.log(`SnappyMail: closeOnlyOfficeModal - Временный файл ${e.path} \n\t\t\t\tуспешно удален из Nextcloud.`)}catch(e){console.error("SnappyMail: closeOnlyOfficeModal - Ошибка при удалении временного файла:",e)}finally{this.currentTempFileInfo(null)}}else console.log("SnappyMail: closeOnlyOfficeModal - Временный файл для удаления не найден или информация неполна.")}toggleFullInfo(){this.showFullInfo(!this.showFullInfo())}closeMessage(){Wr(null)}editCommand(){Wr()&&yr([it.Draft,Wr()])}moveOrCopy(e,s,i){e&&s?.preventDefault&&V(s),this.actionsMenu().ddBtn.hide(),Os.focusedState(t),cr(i)}moveCommand(e,t){this.moveOrCopy(e,t,1)}copyCommand(e,t){this.moveOrCopy(e,t,2)}setUnseen(){Jr(at),Wr(null)}goUpCommand(){R("mailbox.message-list.selector.go-up",!!Wr())}goDownCommand(){R("mailbox.message-list.selector.go-down",!!Wr())}replyOrforward(e){yr([e,Wr()])}onBuild(t){console.log("SnappyMail: onBuild - Метод onBuild вызван.");const i=document.querySelector(".rl-wrapper");i?(i.classList.add("active"),console.log('SnappyMail: onBuild - Класс "active" добавлен к .rl-wrapper.')):console.warn("SnappyMail: onBuild - Элемент .rl-wrapper не найден."),this.getCurrentNextcloudUser().then(e=>{const t=k("username-display");t?e&&e.displayname?(t.textContent=e.displayname,t.title=e.id,console.log(`SnappyMail: onBuild - DisplayName "${e.displayname}" установлено в #username-display, Title: "${e.id}".`)):e&&e.id?(t.textContent=e.id,t.title=e.id,console.warn(`SnappyMail: onBuild - DisplayName отсутствует, использован  логин "${e.id}" для #username-display и Title.`)):(t.textContent="Неизвестный пользователь",t.title="Неизвестный пользователь",console.warn('SnappyMail: onBuild - Имя пользователя не получено, установлено "Неизвестный пользователь".')):console.error("SnappyMail: onBuild - Элемент #username-display не найден в DOM.")}).catch(e=>{console.error("SnappyMail: onBuild - Ошибка при получении данных пользователя Nextcloud:",e);const t=k("username-display");t&&(t.textContent="Ошибка загрузки имени",t.title="Ошибка загрузки имени")});const r=(e,s)=>e.target.closestWithin(s,t);t.addEventListener("click",e=>{let t=r(e,"a");if(t&&0===e.button&&fr(t.href))V(e);else{if(t=r(e,".attachmentsPlace .showPreview"),t){const s=ko.dataFor(t),i=s?.linkDownload();return void(i&&Ie==s.mimeType&&(V(e),zr(i).then(e=>{const t=new MessageModel;li(e,t),t.popupMessage()})))}if(t=r(e,".attachmentsPlace .showPreplay"),t){V(e);const s=ko.dataFor(t);if(s&&ys.supported)switch(!0){case ys.supportedMp3&&s.isMp3():ys.playMp3(s.linkDownload(),s.fileName);break;case ys.supportedOgg&&s.isOgg():ys.playOgg(s.linkDownload(),s.fileName);break;case ys.supportedWav&&s.isWav():ys.playWav(s.linkDownload(),s.fileName)}return}if(t=r(e,".attachmentItem"),t){const e=ko.dataFor(t),s=e?.linkDownload();s&&"application/pgp-keys"==e.mimeType&&(ii.isSupported()||$s.isSupported())&&zr(s).then(e=>Ls(OpenPgpImportPopupView,[e]))}r(e,".messageItemHeader .subjectParent .flagParent")&&Jr(Wr()?.isFlagged()?nt:ot)}}),H.subscribe(e=>this.messageDomFocused(s===e)),_("escape","",s,()=>{if(!this.viewModelDom.hidden&&Wr()){const t=Mt.usePreviewPane();return fi()?(gi(),t&&Os.focusedState(e)):t?Os.focusedState(e):Wr(null),!1}}),_("enter,open","",s,()=>(fi()||yi(),!1)),q("r,mailreply","",[e,s],()=>!Wr()||(this.replyCommand(),!1)),q("a","",[e,s],()=>{if(Wr())return this.replyAllCommand(),!1}),q("mailreply","shift",[e,s],()=>{if(Wr())return this.replyAllCommand(),!1}),q("f,mailforward","",[e,s],()=>{if(Wr())return this.forwardCommand(),!1}),q("i","meta",[e,s],()=>(Wr()&&this.toggleFullInfo(),!1)),q("b","",[e,s],()=>{const e=Wr();if(e?.body)return e.body.querySelectorAll("details").forEach(e=>e.open=!e.open),!1}),_("b","shift",[e,s],()=>{if(!U())return Wr()?.swapColors?.(),!1}),_("arrowup,arrowleft","meta",[e,s],()=>(this.goUpCommand(),!1)),_("arrowdown,arrowright","meta",[e,s],()=>(this.goDownCommand(),!1)),_("delete","",s,()=>(this.deleteCommand(),!1)),_("delete","shift",s,()=>(this.deleteWithoutMoveCommand(),!1)),_("arrowleft","",s,()=>{if(!fi()&&Wr()&&Mt.usePreviewPane()&&!jr().scrollLeft)return Os.focusedState(e),!1}),_("tab","shift",s,()=>(!fi()&&Wr()&&Mt.usePreviewPane()&&Os.focusedState(e),!1)),bi.bodiesDom(t.querySelector(".bodyText"))}scrollMessageToTop(){jr().scrollTop=0}scrollMessageToLeft(){jr().scrollLeft=0}toggleAttachmentControls(){const e=!this.showAttachmentControls();this.showAttachmentControls(e),ji(10,e)}downloadAsZip(){const e=(Wr()?.attachments||[]).map(e=>e?.checked()?e.download:"").filter(e=>e);mr(Wr().subject(),e,()=>this.downloadAsZipError(!0),this.downloadAsZipLoading)}showImages(){Wr().showExternalImages()}showTracking(){const e=Wr(),t=e?.body;if(t&&e.hasTracking()){let e="data-x-href-tracking";t.querySelectorAll("a["+e+"]").forEach(t=>t.href=t.getAttribute(e)),this.nowTracking(!0)}}whitelistText(e){let t=(Mt.viewImagesWhitelist().trim()+"\n"+e).trim();Mt.viewImagesWhitelist(t),qs.saveSetting("ViewImagesWhitelist",t),Wr().showExternalImages(1)}printableCheckedMessageCount(){const e=Pi.listCheckedOrSelectedUidsWithSubMails().size;return 0<e?100>e?e:"99+":""}readReceipt(){let e=Wr();e.readReceipt&&(e.flags.push("$mdnsent"),qs.request("SendReadReceiptMessage",t=>t&&e.flags.remove("$mdnsent"),{messageFolder:e.folder,messageUid:e.uid,readReceipt:e.readReceipt,subject:de("READ_RECEIPT/SUBJECT",{SUBJECT:e.subject()}),plain:de("READ_RECEIPT/BODY",{"READ-RECEIPT":Si.email()})}))}newTag(){let e=Wr();if(e){let t=prompt(de("MESSAGE/NEW_TAG"),"")?.replace(/[\s\\]+/g,"");t.length&&kt(t)&&(e.toggleTag(t),Tt.currentFolder().permanentFlags.push(t))}}pgpDecrypt(){Wr().decrypt()}pgpVerify(){Wr().pgpVerify()}async smimeDecrypt(){Wr().decrypt()}smimeVerify(){Wr().smimeVerify()}}class MailBoxUserScreen extends AbstractScreen{constructor(){var e=D("style");A.head.appendChild(e),ge(()=>e.innerText='.subjectParent:empty::after,.subjectParent .subject:empty::after{content:"'+de("MESSAGE/EMPTY_SUBJECT_TEXT")+'"}'),super("mailbox",[SystemDropDownUserView,MailFolderList,MailMessageList,MailMessageView])}updateWindowTitle(){const e=M.app("listPermanentFiltered")?0:Tt.foldersInboxUnreadCount(),t=Si.email();rl.setTitle((t?(0<e?"("+e+") ":" ")+t+" - ":"")+de("TITLES/MAILBOX"))}onShow(){this.updateWindowTitle(),Os.focusedState("none"),Os.focusedState(e)}onRoute(e,t,s,i){const r=(a=e.replace(/~([\d]+)$/,""),Et(yt.get(a)));var a;if(r){if(Tt.currentFolder(r),Pi.page(1>t?1:t),Pi.listSearch(s),i){let t=new MessageModel;t.folder=e,t.uid=i,vr(t)}else{let t=e.replace(/^.+~(\d+)$/,"$1");Pi.threadUid(e===t?0:f(t))}Pi.reload()}}onStart(){super.onStart(),addEventListener("mailbox.inbox-unread-count",e=>{Tt.foldersInboxUnreadCount(e.detail),this.updateWindowTitle()})}onBuild(){A.addEventListener("click",e=>e.target.closest("#rl-right")&&cr(0))}routes(){const e=(e,t)=>e?p(t[0]):St(),t=(t,s)=>[e(t,s),t?f(s[1]):1,decodeURI(p(s[2]))];return[[/^([^/]*)$/,{normalize_:t}],[/^([a-zA-Z0-9.~_-]+)\/(.+)\/?$/,{normalize_:(t,s)=>[e(t,s),1,decodeURI(p(s[1]))]}],[/^([a-zA-Z0-9.~_-]+)\/m([1-9][0-9]*)(?:\/(.+))?$/,{normalize_:(t,s)=>[e(t,s),1,p(s[2]),p(s[1])]}],[/^([a-zA-Z0-9.~_-]+)\/p([1-9][0-9]*)(?:\/(.+))?$/,{normalize_:t}]]}}const Qr=[];class AbstractSettingsScreen extends AbstractScreen{constructor(e){super("settings",e),this.menu=ko.observableArray(),this.oCurrentSubScreen=null}onRoute(e){let t=null,s=null,i=Qr.find(t=>e===t.route);if(i){const e=this.viewModels[1].__vm.viewModelDom,r=i.vmc;r.__vm?(t=r.__vm,s=t.viewModelDom):e?(s=D("div",{id:"V-Settings-"+r.name.replace(/(User|Admin)Settings/,""),hidden:""}),e.append(s),t=new r,t.viewModelDom=s,t.viewModelTemplateID=i.template,r.__vm=t,R("rl-view-model.create",t),ko.applyBindingAccessorsToNode(s,{template:()=>({name:i.template})},t),t.onBuild?.(s),R("rl-view-model",t)):console.log("Cannot find sub settings view model position: SettingsSubScreen"),t&&setTimeout(()=>{this.onHide(),this.oCurrentSubScreen=t,t.beforeShow?.(),he(s),s.hidden=!1,t.onShow?.(),this.menu.forEach(e=>{e.selected(e.route===i.route)}),(e||{}).scrollTop=0},1)}else hasher.replaceHash(te())}onHide(){let e=this.oCurrentSubScreen;e&&(e.onHide?.(),e.viewModelDom.hidden=!0)}onBuild(){Qr.forEach(e=>this.menu.push(e))}routes(){const e=Qr.find(e=>e.isDefault),t=e?.route||"general",s={subname:/^(.*)$/,normalize_:(e,s)=>(s.subname=p(s.subname??t),[s.subname])};return[["{subname}/",s],["{subname}",s],["",s]]}}function ea(e,t,s,i,r=!1){let a=e.name.replace(/(User|Admin)Settings/,"");Qr.push({vmc:e,label:s||"SETTINGS_LABELS/"+a.toUpperCase(),route:i||a.toLowerCase(),selected:ko.observable(!1),template:t||e.name,isDefault:!!r})}const ta=[],sa=[];rl.pluginRemoteRequest=(e,t,s,i)=>{rl.app.Remote.request("Plugin"+t,e,s,i)},rl.addSettingsViewModel=(e,t,s,i)=>{ta.push([e,t,s,i])},rl.addSettingsViewModelForAdmin=(e,t,s,i)=>{sa.push([e,t,s,i])},rl.pluginSettingsGet=(e,t)=>F("Plugins")?.[e]?.[t],rl.pluginPopupView=AbstractViewPopup;class UserSettingsGeneral extends AbstractViewSettings{constructor(){super(),this.mailto=ko.observable(!!navigator.registerProtocolHandler),this.language=ie.language,this.languages=ie.languages,this.hourCycle=ie.hourCycle,this.soundNotification=ys.notifications,this.notificationSound=ko.observable(F("NotificationSound")),this.notificationSounds=ko.observableArray(F("newMailSounds")),this.minRefreshInterval=F("minRefreshInterval"),this.desktopNotifications=Mi.enabled,this.isDesktopNotificationAllowed=Mi.allowed;const e=e=>de("MESSAGE_LIST/SORT_"+e);this.sortSupported=Tt.hasCapability("SORT"),this.sortOptions=[{value:"",text:e("DATE_DESC")},{value:"DATE",text:e("DATE_ASC")},{value:"FROM",text:e("FROM_ASC")},{value:"REVERSE FROM",text:e("FROM_DESC")},{value:"REVERSE SIZE",text:e("SIZE_DESC")},{value:"SIZE",text:e("SIZE_ASC")},{value:"SUBJECT",text:e("SUBJECT_ASC")},{value:"REVERSE SUBJECT",text:e("SUBJECT_DESC")},{value:"REVERSE ARRIVAL",text:e("ARRIVAL_DESC")},{value:"ARRIVAL",text:e("ARRIVAL_ASC")}],this.threadsAllowed=Os.threadsAllowed,this.threadAlgorithms=ko.observableArray(),Tt.capabilities.forEach(e=>e.startsWith("THREAD=")&&this.threadAlgorithms.push(e.slice(7))),this.threadAlgorithms.sort((e,t)=>e.length-t.length),["defaultSort","useThreads","threadAlgorithm","layout","messageReadDelay","messagesPerPage","checkMailInterval","editorDefaultType","editorWysiwyg","msgDefaultAction","maxBlockquotesLevel","requestReadReceipt","requestDsn","requireTLS","pgpSign","pgpEncrypt","viewHTML","viewImages","viewImagesWhitelist","removeColors","allowStyles","allowDraftAutosave","hideDeleted","listInlineAttachments","simpleAttachmentsList","collapseBlockquotes","useCheckboxesInList","listGrouped","replySameFolder","allowSpellcheck","messageReadAuto","showNextMessage","messageNewWindow","markdown"].forEach(e=>this[e]=Mt[e]),this.allowLanguagesOnSettings=!!F("allowLanguagesOnSettings"),this.languageTrigger=ko.observable(o),this.identities=ci,this.wysiwygs=Ft,ke(this,{languageFullName:()=>ve(this.language()),identityMainDesc:()=>{const e=ci.main();return e?e.toString():"---"},editorDefaultTypes:()=>(le(),[{id:"Html",name:de("SETTINGS_GENERAL/EDITOR_HTML")},{id:"Plain",name:de("SETTINGS_GENERAL/EDITOR_PLAIN")}]),hasWysiwygs:()=>1<Ft().length,msgDefaultActions:()=>(le(),[{id:1,name:de("MESSAGE/BUTTON_REPLY")},{id:2,name:de("MESSAGE/BUTTON_REPLY_ALL")}]),layoutTypes:()=>(le(),[{id:0,name:de("SETTINGS_GENERAL/LAYOUT_NO_SPLIT")},{id:1,name:de("SETTINGS_GENERAL/LAYOUT_VERTICAL_SPLIT")},{id:2,name:de("SETTINGS_GENERAL/LAYOUT_HORIZONTAL_SPLIT")}])}),this.addSetting("EditorDefaultType"),this.addSetting("editorWysiwyg"),this.addSetting("MsgDefaultAction"),this.addSetting("MessageReadDelay"),this.addSetting("MessagesPerPage"),this.addSetting("CheckMailInterval"),this.addSetting("Layout"),this.addSetting("MaxBlockquotesLevel"),this.addSetting("defaultSort"),this.addSettings(["requestReadReceipt","requestDsn","requireTLS","pgpSign","pgpEncrypt","ViewHTML","ViewImages","ViewImagesWhitelist","RemoveColors","AllowStyles","AllowDraftAutosave","HideDeleted","ListInlineAttachments","simpleAttachmentsList","CollapseBlockquotes","UseCheckboxesInList","listGrouped","ReplySameFolder","allowSpellcheck","messageReadAuto","showNextMessage","messageNewWindow","markdown","DesktopNotifications","SoundNotification"]);const t=e=>()=>{this.languageTrigger(e),setTimeout(()=>this.languageTrigger(o),1e3)};Te(this,{language:e=>{this.languageTrigger(a),Se(e).then(t(n),t(l)).then(()=>qs.saveSetting("language",e))},hourCycle:e=>qs.saveSetting("hourCycle",e),notificationSound:e=>{qs.saveSetting("NotificationSound",e),M.set("NotificationSound",e)},useThreads:e=>{Pi([]),qs.saveSetting("UseThreads",e)},threadAlgorithm:e=>{Pi([]),qs.saveSetting("threadAlgorithm",e)},checkMailInterval:()=>{Ri(Mt.checkMailInterval())}})}editMainIdentity(){hr(ci.main())}testSoundNotification(){ys.playNotification(!0)}testSystemNotification(){Mi.display("SnappyMail","Test notification")}selectLanguage(){Ls(LanguagesPopupView,[this.language,this.languages(),ie.userLanguage()])}registerMailto(){console.log(`mailto = ${location.protocol}//${location.host}${location.pathname}?mailto`),navigator.registerProtocolHandler("mailto",`${location.protocol}//${location.host}${location.pathname}?mailto&to=%s`,F("title")||"SnappyMail"),alert(de("GLOBAL/DONE")),this.mailto(0)}onBuild(){const e=document.querySelector("#V-Settings-General .b-tab-content");if(e){const t=e.querySelector(".tabs"),s=t?t.querySelectorAll(".tab"):[],i=document.querySelectorAll(".tab-panel");s.forEach(e=>{e.addEventListener("click",function(){s.forEach(e=>e.classList.remove("active")),i.forEach(e=>e.style.display="none"),this.classList.add("active");const e=this.dataset.tab,t=document.getElementById(e);t&&(t.style.display="flex")})})}}}class UserSettingsContacts{constructor(){this.contactsAutosave=ko.observable(!!F("ContactsAutosave")),this.allowContactsSync=wr.allowSync,this.syncMode=wr.syncMode,this.syncUrl=wr.syncUrl,this.syncUser=wr.syncUser,this.syncPass=wr.syncPass,this.syncError=ko.observable(""),this.imgName="dddd",this.syncModeOptions=Ae(()=>(le(),[{id:0,name:de("GLOBAL/NO")},{id:1,name:de("GLOBAL/YES")},{id:2,name:de("SETTINGS_CONTACTS/SYNC_READ")}])),this.saveTrigger=Ae(()=>[wr.syncMode(),wr.syncUrl(),wr.syncUser(),wr.syncPass()].join("|")).extend({debounce:500}),this.contactsAutosave.subscribe(e=>qs.saveSettings(null,{ContactsAutosave:e})),this.saveTrigger.subscribe(()=>qs.request("SaveContactsSyncData",null,{Mode:wr.syncMode(),Url:wr.syncUrl(),User:wr.syncUser(),Password:wr.syncPass()}))}test(){this.syncError(""),qs.request("TestContactsSyncData",(e,t)=>{e&&this.syncError(t.messageAdditional||t.message||ye(e,t))},{Url:wr.syncUrl(),User:wr.syncUser(),Password:wr.syncPass()})}}class UserSettingsAccounts{constructor(){this.allowAdditionalAccount=x("AdditionalAccounts"),this.allowIdentities=x("Identities"),this.accounts=Si,this.loading=Si.loading,this.identities=ci,this.mainEmail=F("mainEmail"),this.accountForDeletion=ko.observable(null).askDeleteHelper(),this.identityForDeletion=ko.observable(null).askDeleteHelper(),this.showUnread=Mt.showUnreadCount,Mt.showUnreadCount.subscribe(e=>qs.saveSetting("ShowUnreadCount",e))}addNewAccount(){Ls(AccountPopupView)}editAccount(e){e?.isAdditional()&&Ls(AccountPopupView,[e])}addNewIdentity(){hr()}editIdentity(e){hr(e)}deleteAccount(e){e?.askDelete()&&(this.accountForDeletion(null),this.accounts.remove(t=>e===t),qs.request("AccountDelete",(e,t)=>{!e&&t.Reload?(rl.route.root(),setTimeout(()=>location.reload(),1)):ur()},{emailToDelete:e.email}))}deleteIdentity(e){e?.askDelete()&&(this.identityForDeletion(null),ci.remove(t=>e===t),qs.request("IdentityDelete",()=>rl.app.accountsAndIdentities(),{idToDelete:e.id()}))}accountsAndIdentitiesAfterMove(){qs.request("AccountsAndIdentitiesSortOrder",null,{Accounts:Si.filter(e=>e.isAdditional()).map(e=>e.email),Identities:ci.map(e=>e?e.id():"")})}onBuild(e){e.addEventListener("click",t=>{let s=t.target.closestWithin(".accounts-list .e-action",e);s&&ko.dataFor(s)&&this.editAccount(ko.dataFor(s)),s=t.target.closestWithin(".identities-list .e-action",e),s&&ko.dataFor(s)&&this.editIdentity(ko.dataFor(s))})}}class UserSettingsFilters{constructor(){this.scripts=ko.observableArray(),this.loading=ko.observable(!0).extend({debounce:200}),Ce(this,{serverError:!1,serverErrorDesc:""}),rl.loadScript(F("StaticLibsJs").replace("/libs.","/sieve.")).then(()=>{const e=window.Sieve;e.folderList=Tt.folderList,e.serverError.subscribe(e=>this.serverError(e)),e.serverErrorDesc.subscribe(e=>this.serverErrorDesc(e)),e.loading.subscribe(e=>this.loading(e)),e.scripts.subscribe(e=>this.scripts(e)),e.updateList()}).catch(e=>console.error(e)),this.hasActive=Ae(()=>this.scripts().filter(e=>e.active()).length),this.scriptForDeletion=ko.observable(null).askDeleteHelper()}addScript(){this.editScript()}editScript(e){window.Sieve.ScriptView.showModal(e?[e]:null)}deleteScript(e){window.Sieve.deleteScript(e)}disableScripts(){window.Sieve.setActiveScript("")}enableScript(e){window.Sieve.setActiveScript(e.name())}onBuild(e){e.addEventListener("click",t=>{const s=t.target.closestWithin(".script-item .script-name",e),i=s&&ko.dataFor(s);i&&this.editScript(i)})}onShow(){window.Sieve?.updateList()}}const ia=ko.observable(null).askDeleteHelper();class UserSettingsFolders{constructor(){this.showKolab=Tt.allowKolab(),this.defaultOptionsAfterRender=y,this.kolabTypeOptions=ko.observableArray();let e=e=>de("SETTINGS_FOLDERS/TYPE_"+e);ge(()=>{this.kolabTypeOptions([{id:"",name:""},{id:"event",name:e("CALENDAR")},{id:"contact",name:e("CONTACTS")},{id:"task",name:e("TASKS")},{id:"note",name:e("NOTES")},{id:"file",name:e("FILES")},{id:"journal",name:e("JOURNAL")},{id:"configuration",name:e("CONFIGURATION")}])}),this.displaySpecSetting=Tt.displaySpecSetting,this.folderList=Tt.folderList,this.folderListOptimized=Tt.optimized,this.folderListError=Tt.error,this.hideUnsubscribed=Mt.hideUnsubscribed,this.unhideKolabFolders=Mt.unhideKolabFolders,this.loading=Tt.foldersChanging,this.folderForDeletion=ia,Mt.hideUnsubscribed.subscribe(e=>qs.saveSetting("HideUnsubscribed",e)),Mt.unhideKolabFolders.subscribe(e=>qs.saveSetting("UnhideKolabFolders",e))}onShow(){Tt.error("")}createFolder(){Ls(FolderCreatePopupView)}systemFolder(){Ls(FolderSystemPopupView)}deleteFolder(e){e&&e.canBeDeleted()&&e.askDelete()&&(0<e.totalEmails()?e.errorMsg(fe(c.CantDeleteNonEmptyFolder)):(ia(null),e&&qs.abort("Folders").post("FolderDelete",Tt.foldersDeleting,{folder:e.fullName}).then(()=>{if(e.selectable(!1),!e.subFolders.length){At(e.fullName);const t=Et(e.parentName);(t?t.subFolders:Tt.folderList).remove(e)}},e=>{Tt.error(fe(e.code,"",c.CantDeleteFolder)+".\n"+e.message)})))}hideError(){Tt.error("")}toggleFolderKolabType(e,t){let s=t.target.value;qs.request("FolderSetMetadata",null,{folder:e.fullName,key:tt,value:s}),e.kolabType(s)}toggleFolderSubscription(e){let t=!e.isSubscribed();qs.request("FolderSubscribe",null,{folder:e.fullName,subscribe:t?1:0}),e.isSubscribed(t)}toggleFolderCheckable(e){let t=!e.checkable();qs.request("FolderCheckable",null,{folder:e.fullName,checkable:t?1:0}),e.checkable(t)}}class SettingsMenuUserView extends AbstractViewLeft{constructor(e){super(),this.menu=e.menu}link(e){return te(e)}backToInbox(){hasher.setHash(((e="INBOX")=>"#/mailbox/"+e)(St()))}onBuild(){document.querySelector(".rl-wrapper").classList.add("active")}}class SettingsPaneUserView extends AbstractViewRight{constructor(){super()}onShow(){bi.message(null)}onBuild(e){e.addEventListener("click",()=>{event.target.closestWithin(".toggleLeft",e)?N():ut.isMobile()&&O(!0);const t=document.querySelector('.search-wrapper-tab input[type="search"]#search_accounts'),s=document.querySelectorAll(".account-item");t&&s&&t.addEventListener("input",function(){const e=t.value.trim().toLowerCase();s.forEach(function(t){const s=t.querySelector(".account-name");if(s){const i=s.textContent.trim().toLowerCase();""===e||i.includes(e)?t.style.display="block":t.style.display="none"}else t.style.display="none"})});const i=document.querySelector('.search-wrapper-tab input[type="search"]#search_folders'),r=document.querySelectorAll(".b-tab-content table tr");i&&r&&i.addEventListener("input",function(){const e=i.value.trim().toLowerCase();r.forEach(function(t){const s=t.querySelector(".folder-name");if(s){const i=s.textContent.trim().toLowerCase();""===e||i.includes(e)?t.style.display="":t.style.display="none"}else t.style.display="none"})})})}}class SettingsUserScreen extends AbstractSettingsScreen{constructor(){super([SettingsMenuUserView,SettingsPaneUserView,SystemDropDownUserView]);const e=[UserSettingsGeneral];Os.allowContacts()&&e.push(UserSettingsContacts),(x("AdditionalAccounts")||x("Identities"))&&e.push(UserSettingsAccounts),e.push(UserSettingsFolders),x("Sieve")&&e.push(UserSettingsFilters),e.forEach((e,t)=>ea(e,e.name.replace("User",""),e!==UserSettingsAccounts||x("AdditionalAccounts")?0:"SETTINGS_ACCOUNTS/LEGEND_IDENTITIES",0,0===t)),(!1?sa:ta).forEach(e=>ea(...e)),ge(()=>this.sSettingsTitle=de("TITLES/SETTINGS"),()=>this.setSettingsTitle())}onShow(){this.setSettingsTitle(),G(i)}setSettingsTitle(){const e=Si.email();rl.setTitle((e?e+" - ":"")+this.sSettingsTitle)}}class SelectComponent{constructor(e){this.value=e.value,this.label=e.label,this.trigger=e.trigger?.subscribe?e.trigger:null,this.placeholder=e.placeholder,this.options=e.options,this.optionsText=e.optionsText,this.optionsValue=e.optionsValue;let t=0<e.size?"span"+e.size:"";if(this.trigger){const e=ko.observable(""),s=t=>{switch(t){case n:e("success");break;case l:e("error");break;default:e("")}};s(this.trigger()),this.className=Ae(()=>(t+" settings-save-trigger-input "+e()).trim()),this.disposables=[this.trigger.subscribe(s,this),this.className]}else this.className=t;this.defaultOptionsAfterRender=y}dispose(){this.disposables?.forEach(Me)}}class CheckboxComponent{constructor(e={}){this.name=e.name,this.value=ko.isObservable(e.value)?e.value:ko.observable(!!e.value),this.enable=ko.isObservable(e.enable)?e.enable:ko.observable(e.enable??1),this.label=e.label}click(){this.enable()&&this.value(!this.value())}}class AbstractApp{constructor(e){this.Remote=e}logoutReload(e){xs(!1),e=e||(W()?J():$),location.href!==e?setTimeout(()=>location.href=e,100):rl.route.reload()}bootstart(){const e=(e,t)=>ko.components.register(e,{template:{element:t.name},viewModel:{createViewModel:(e,s)=>(e=e||{},he(s.element),new t(e))}});e("Select",SelectComponent),e("Checkbox",CheckboxComponent),ge(),ie.populate(),pt(),this.start()}}if(AskPopupView.password=function(e,t,s){return new Promise(i=>{this.showModal([e,e=>i({password:e.passphrase(),username:e.username(),remember:e.remember()}),()=>i(null),!0,s||1,t])})},AskPopupView.cryptkey=()=>new Promise(e=>{const t=()=>AskPopupView.showModal([de("CRYPTO/ASK_CRYPTKEY_PASS"),s=>{let i=s.passphrase();i?qs.post("ResealCryptKey",null,{passphrase:i}).then(t=>{e(t?.Result)}).catch(s=>{111===s.code?t():(console.error(s),e(null))}):e(null)},()=>e(null),!0,1,de("CRYPTO/DECRYPT")]);t()}),"/apps/f7mail/"===window.location.pathname&&window.location.hash.startsWith("#/new-letter/")){const e=window.location.search;window.location.href="/apps/f7mail/"+e}const ra=document.querySelectorAll(".menu li");function aa(){const e=window.location.href;function t(e){ra.forEach((t,s)=>{s===e?t.classList.add("active"):t.classList.remove("active")})}document.querySelector("#V-PopupsCompose")&&document.querySelector("#V-PopupsCompose").classList.remove("active"),e.includes("/mailbox/")?t(1):e.includes("/settings/")?t(2):t(1)}ra.forEach((e,t)=>{e.addEventListener("click",function(){ra.forEach(e=>e.classList.remove("active")),this.classList.add("active"),document.querySelector("#V-PopupsCompose")&&(0===t?(history.pushState({},"","/apps/f7mail/#/new-letter/"),document.querySelector("#V-PopupsCompose").classList.add("active")):document.querySelector("#V-PopupsCompose").classList.remove("active"))})}),document.addEventListener("click",function(e){if(e.target.classList.contains("buttonEdit")){history.pushState({},"","/apps/f7mail/#/new-letter/"),document.querySelectorAll("#rl-menu ul.menu li.active").forEach(e=>e.classList.remove("active")),document.querySelectorAll("#rl-menu ul.menu li")[0]?.classList.add("active");document.querySelector("#V-PopupsCompose")&&document.querySelector("#V-PopupsCompose").classList.add("active")}if(e.target.classList.contains("buttonReply")){history.pushState({},"","/apps/f7mail/#/new-letter/"),document.querySelectorAll("#rl-menu ul.menu li.active").forEach(e=>e.classList.remove("active")),document.querySelectorAll("#rl-menu ul.menu li")[0]?.classList.add("active");document.querySelector("#V-PopupsCompose")&&document.querySelector("#V-PopupsCompose").classList.add("active")}if(e.target.classList.contains("buttonReplyAll")){history.pushState({},"","/apps/f7mail/#/new-letter/"),document.querySelectorAll("#rl-menu ul.menu li.active").forEach(e=>e.classList.remove("active")),document.querySelectorAll("#rl-menu ul.menu li")[0]?.classList.add("active");document.querySelector("#V-PopupsCompose")&&document.querySelector("#V-PopupsCompose").classList.add("active")}if(e.target.classList.contains("letterMailCustom")){history.pushState({},"","/apps/f7mail/#/new-letter/"),document.querySelectorAll("#rl-menu ul.menu li.active").forEach(e=>e.classList.remove("active")),document.querySelectorAll("#rl-menu ul.menu li")[0]?.classList.add("active");document.querySelector("#V-PopupsCompose")&&document.querySelector("#V-PopupsCompose").classList.add("active")}}),aa(),window.addEventListener("popstate",aa),window.addEventListener("hashchange",aa);document.querySelector(".addNewAccountCustom").addEventListener("click",function(){Ls(AccountPopupView)});var oa;document.querySelector(".letterMailCustom").addEventListener("click",function(){yr()}),oa=new class AppUser extends AbstractApp{constructor(){super(qs);const e=36e5;let t=Date.now();setInterval(()=>{const s=Date.now();s>t+e+1e3&&qs.request("Version",e=>100<e&&location.reload(),{version:M.app("version")}),t=s},e),B(A,["keydown","keyup"],(e=>C.toggle("rl-ctrl-key-pressed",e.ctrlKey)).debounce(500)),_("escape,enter","",dr),addEventListener("click",dr),this.folderList=Tt.folderList,this.messageList=Pi,this.ask=AskPopupView,this.loadAccountsAndIdentities=ur}moveMessagesToFolderType(e,t,s,i){let r=null,a=0;switch(e){case et.Junk:r=Et(Tt.spamFolder()),a=e,i=i||gt===Tt.spamFolder();break;case et.Inbox:r=Et(St());break;case et.Trash:r=Et(Tt.trashFolder()),a=e,i=i||t===Tt.spamFolder()||t===Tt.trashFolder();break;case et.Archive:r=Et(Tt.archiveFolder()),a=e,i=i||gt===Tt.archiveFolder()}i?Ls(AskPopupView,[de("POPUPS_ASK/DESC_WANT_DELETE_MESSAGES"),()=>{Pi.moveMessages(t,s)}]):r?Pi.moveMessages(t,s,r.fullName):Ls(FolderSystemPopupView,[a])}folderInformation(e,t){_i(e,t)}logout(){qs.request("Logout",(e,t)=>e?alert("Logout error: "+ye(e,t)):rl.logoutReload(M.app("customLogoutLink")))}bootstart(){super.bootstart(),addEventListener("beforeunload",e=>{if(xs()||!Mt.usePreviewPane()&&bi.message())return e.preventDefault(),e.returnValue=de("POPUPS_ASK/EXIT_ARE_YOU_SURE")},{capture:!0})}refresh(){pt(),ie.language(F("language")),this.start()}start(){F("Auth")?(rl.setTitle(de("GLOBAL/LOADING")),ys.notifications(!!F("SoundNotification")),Mi.enabled(!!F("DesktopNotifications")),Si.email(F("Email")),Mt.init(),wr.init(),er((e,t)=>{try{e?(Is([MailBoxUserScreen,SettingsUserScreen]),Ri(F("CheckMailInterval")),ur(),setTimeout(()=>{const e=Tt.currentFolderFullName();St()===e||_i(e),Tt.hasCapability("LIST-STATUS")||qi(!0)},1e3),setTimeout(()=>qs.request("AppDelayStart"),35e3),B(A,["touchstart","mousemove","keydown"],Mt.delayLogout,{passive:!0}),Mt.delayLogout(),setTimeout(()=>{const e=k("rl-left"),t=()=>br(e,4,ut.isMobile()||O()?0:"Width");e&&(t(),O.subscribe(t))},1),setInterval(me,6e4),ni.init(),Er.loadCertificates(),setTimeout(()=>fr(F("mailToEmail")),500)):(this.logout(),alert("Folders error: "+ye(0,t)))}catch(e){console.error(e)}})):Is([LoginUserScreen])}showMessageComposer(e=[]){let t=e[1];1==h(t)&&(t=t[0]),t?t.decrypt().then(()=>Ls(ComposePopupView,e)):Ls(ComposePopupView,e)}},rl.app=oa,rl.logoutReload=oa.logoutReload,rl.i18n=de,rl.Enums={StorageResultType:{Success:0,Error:1,Abort:2}},rl.route={root:()=>{rl.route.off(),hasher.setHash(j)},reload:()=>{rl.route.root(),setTimeout(()=>location.reload(),100)},off:()=>hasher.active=!1,on:()=>hasher.active=!0}}();
