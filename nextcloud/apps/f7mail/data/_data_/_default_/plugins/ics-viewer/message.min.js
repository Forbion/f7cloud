(t=>{const e="MailMessageView";addEventListener("rl-view-model.create",(a=>{if(e===a.detail.viewModelTemplateID){const r=document.getElementById(e),n=a.detail,d=r.content.querySelector(".attachmentsPlace"),i=/(TZID=(?<tz>[^:]+):)?(?<year>[0-9]{4})(?<month>[0-9]{2})(?<day>[0-9]{2})T(?<hour>[0-9]{2})(?<minute>[0-9]{2})(?<second>[0-9]{2})(?<utc>Z?)/,s=t=>{let e=i.exec(t)?.groups,a={dateStyle:"long",timeStyle:"short"},r=e?new Date(parseInt(e.year,10),parseInt(e.month,10)-1,parseInt(e.day,10),parseInt(e.hour,10),parseInt(e.minute,10),parseInt(e.second,10)):new Date(t);e?.tz&&(a.timeZone=windowsVTIMEZONEs[e.tz]||e.tz);try{return r.format(a)}catch(t){if(a.timeZone)return a.timeZone=void 0,r.format(a)}};d.after(Element.fromHTML('\n\t\t\t<details data-bind="if: ICSViewer, visible: ICSViewer">\n\t\t\t\t<summary data-icon="ðŸ“…" data-bind="text: ICSViewer().SUMMARY"></summary>\n\t\t\t\t<table><tbody style="white-space:pre">\n\t\t\t\t\t<tr data-bind="visible: ICSViewer().ORGANIZER_TXT"><td>Organizer: </td><td><a data-bind="text: ICSViewer().ORGANIZER_TXT, attr: { href: ICSViewer().ORGANIZER_MAIL }"></a></td></tr>\n\t\t\t\t\t<tr><td>Start: </td><td data-bind="text: ICSViewer().DTSTART"></td></tr>\n\t\t\t\t\t<tr><td>End: </td><td data-bind="text: ICSViewer().DTEND"></td></tr>\n\t\t\t\t\t<tr data-bind="visible: ICSViewer().LOCATION"><td>Location: </td><td data-bind="text: ICSViewer().LOCATION"></td></tr>\n\x3c!--\t\t\t\t<tr><td>Transparency</td><td data-bind="text: ICSViewer().TRANSP"></td></tr>--\x3e\n\t\t\t\t\t<tr><td>Attendees: </td><td data-bind="foreach: ICSViewer().ATTENDEE"><span data-bind="text: $data.replace(/;/g,\';\\n\')"></span> </td>\n\n\t\t\t\t</tbody></table>\n\t\t\t</details>')),n.ICSViewer=ko.observable(null),n.saveICS=()=>{let e=n.VEVENT();e&&t.nextcloud&&e.rawText&&t.nextcloud.selectCalendar().then((a=>a&&t.nextcloud.calendarPut(a,e)))},n.message.subscribe((e=>{if(n.ICSViewer(null),e){e.linkedData.subscribe((t=>{n.ICSViewer()||t.forEach((t=>{if(t["ical:summary"]){let e={SUMMARY:t["ical:summary"],DTSTART:s(t["ical:dtstart"]),ATTENDEE:[]};n.ICSViewer(e)}else;}))}));let a=e.attachments.find((t=>"text/calendar"==t.mimeType));a&&a.download&&t.fetch(a.linkDownload()).then((t=>t.status<400?t.text():Promise.reject(new Error({response:t})))).then((t=>{let e=ICAL.parse(t);var a=new ICAL.Component(e).getFirstSubcomponent("vevent"),r=new ICAL.Event(a);let d={};r.organizer&&r.organizer.startsWith("mailto:")?(d.ORGANIZER_TXT=r.organizer.substr(7),d.ORGANIZER_MAIL=r.organizer):d.ORGANIZER_TXT=r.organizer,d.SUMMARY=r.summary,d.DTSTART=s(a.getFirstPropertyValue("dtstart")),d.DTEND=s(a.getFirstPropertyValue("dtend")),d.LOCATION=r.location,d.ATTENDEE=[];for(let t of r.attendees)d.ATTENDEE.push(t.getFirstParameter("cn"));d&&(d.rawText=t,d.isCancelled=()=>d.STATUS?.includes("CANCELLED"),d.isConfirmed=()=>d.STATUS?.includes("CONFIRMED"),d.shouldReply=()=>d.METHOD?.includes("REPLY"),n.ICSViewer(d))}))}}))}}))})(window.rl);