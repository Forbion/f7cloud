(t=>{const e="MailMessageView";addEventListener("rl-view-model.create",(a=>{if(e===a.detail.viewModelTemplateID){const n=document.getElementById(e),i=a.detail,d=n.content.querySelector(".attachmentsPlace"),r=/(TZID=(?<tz>[^:]+):)?(?<year>[0-9]{4})(?<month>[0-9]{2})(?<day>[0-9]{2})T(?<hour>[0-9]{2})(?<minute>[0-9]{2})(?<second>[0-9]{2})(?<utc>Z?)/,s=t=>{let e=r.exec(t)?.groups,a={dateStyle:"long",timeStyle:"short"},n=e?new Date(parseInt(e.year,10),parseInt(e.month,10)-1,parseInt(e.day,10),parseInt(e.hour,10),parseInt(e.minute,10),parseInt(e.second,10)):new Date(t);e?.tz&&(a.timeZone=windowsVTIMEZONEs[e.tz]||e.tz);try{return n.format(a)}catch(t){if(a.timeZone)return a.timeZone=void 0,n.format(a)}};d.after(Element.fromHTML('\n\t\t\t<details data-bind="if: viewICS, visible: viewICS">\n\t\t\t\t<summary data-icon="ðŸ“…" data-bind="text: viewICS().SUMMARY"></summary>\n\t\t\t\t<table><tbody style="white-space:pre">\n\t\t\t\t\t<tr data-bind="visible: viewICS().ORGANIZER"><td>Organizer</td><td data-bind="text: viewICS().ORGANIZER"></td></tr>\n\t\t\t\t\t<tr><td>Start</td><td data-bind="text: viewICS().DTSTART"></td></tr>\n\t\t\t\t\t<tr><td>End</td><td data-bind="text: viewICS().DTEND"></td></tr>\n\x3c!--\t\t\t\t<tr><td>Transparency</td><td data-bind="text: viewICS().TRANSP"></td></tr>--\x3e\n\t\t\t\t\t<tr data-bind="foreach: viewICS().ATTENDEE">\n\t\t\t\t\t\t<td></td><td data-bind="text: $data.replace(/;/g,\';\\n\')"></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</details>')),i.viewICS=ko.observable(null),i.saveICS=()=>{let e=i.VEVENT();e&&t.nextcloud&&e.rawText&&t.nextcloud.selectCalendar().then((a=>a&&t.nextcloud.calendarPut(a,e)))},i.message.subscribe((e=>{if(i.viewICS(null),e){e.linkedData.subscribe((t=>{i.viewICS()||t.forEach((t=>{if(t["ical:summary"]){let e={SUMMARY:t["ical:summary"],DTSTART:s(t["ical:dtstart"]),ATTENDEE:[]};i.viewICS(e)}else;}))}));let a=e.attachments.find((t=>"text/calendar"==t.mimeType));a&&a.download&&t.fetch(a.linkDownload()).then((t=>t.status<400?t.text():Promise.reject(new Error({response:t})))).then((t=>{let e,a,n=["ATTACH","ATTENDEE","CATEGORIES","COMMENT","CONTACT","EXDATE","EXRULE","RSTATUS","RELATED","RESOURCES","RDATE","RRULE"],d=t.split(/\r?\n/),r=d.length;for(;r--;){let t=d[r];if(e){for(;t.startsWith(" ")&&r--;)t=d[r]+t.slice(1);if(t.startsWith("END:VALARM")){a={};continue}if(t.startsWith("BEGIN:VALARM")){e.VALARM||(e.VALARM=[]),e.VALARM.push(a),a=null;continue}if(t.startsWith("BEGIN:VEVENT"))break;t=t.match(/^([^:;]+)[:;](.+)$/),t&&(a?a[t[1]]=t[2]:n.includes(t[1])||"X-"==t[1].slice(0,2)?(e[t[1]]||(e[t[1]]=[]),e[t[1]].push(t[2])):("DTSTART"!==t[1]&&"DTEND"!==t[1]||(t[2]=s(t[2])),e[t[1]]=t[2]))}else t.startsWith("END:VEVENT")&&(e={})}e&&(e.rawText=t,e.isCancelled=()=>e.STATUS?.includes("CANCELLED"),e.isConfirmed=()=>e.STATUS?.includes("CONFIRMED"),e.shouldReply=()=>e.METHOD?.includes("REPLY"),i.viewICS(e))}))}}))}}))})(window.rl);