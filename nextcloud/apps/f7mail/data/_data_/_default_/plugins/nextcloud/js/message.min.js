(e=>{const t="MailMessageView";addEventListener("rl-view-model.create",(n=>{if(t===n.detail.viewModelTemplateID){const a=document.getElementById(t),l=e.settings.get("Nextcloud"),s=a.content.querySelector(".attachmentsControls"),o=a.content.querySelector("#more-view-dropdown-id + menu");s&&(s.append(Element.fromHTML('<span>\n\t\t\t\t\t<i class="fontastic iconcolor-red" data-bind="visible: saveNextcloudError">âœ–</i>\n\t\t\t\t\t<i class="fontastic" data-bind="visible: !saveNextcloudError(),\n\t\t\t\t\t\tcss: {\'icon-spinner\': saveNextcloudLoading()}">ðŸ’¾</i>\n\t\t\t\t\t<span class="g-ui-link" data-bind="click: saveNextcloud" data-i18n="NEXTCLOUD/SAVE_ATTACHMENTS"></span>\n\t\t\t\t</span>')),l.CalDAV&&s.append(Element.fromHTML('<span data-bind="visible: nextcloudICS" data-icon="ðŸ“…">\n\t\t\t\t\t\t<span class="g-ui-link" data-bind="click: nextcloudSaveICS" data-i18n="NEXTCLOUD/SAVE_ICS"></span>\n\t\t\t\t\t</span>'))),o&&o.append(Element.fromHTML('<li role="presentation">\n\t\t\t\t\t<a href="#" tabindex="-1" data-icon="ðŸ“¥" data-bind="click: nextcloudSaveMsg" data-i18n="NEXTCLOUD/SAVE_EML"></a>\n\t\t\t\t</li>'));let d=n.detail;d.saveNextcloudError=ko.observable(!1).extend({falseTimeout:7e3}),d.saveNextcloudLoading=ko.observable(!1),d.saveNextcloud=()=>{const t=(d.message()?.attachments||[]).map((e=>e?.checked()?e.download:"")).filter((e=>e));t.length&&(d.saveNextcloudLoading(!0),e.nextcloud.selectFolder().then((n=>{n?e.fetchJSON("./?/Json/&q[]=/0/",{},{Action:"AttachmentsActions",target:"nextcloud",hashes:t,NcFolder:n}).then((e=>{d.saveNextcloudLoading(!1),e?.Result||d.saveNextcloudError(!0)})).catch((()=>{d.saveNextcloudLoading(!1),d.saveNextcloudError(!0)})):d.saveNextcloudLoading(!1)})))},d.nextcloudSaveMsg=()=>{e.nextcloud.selectFolder().then((t=>{let n=d.message();t&&e.pluginRemoteRequest(((e,t)=>{}),"NextcloudSaveMsg",{msgHash:n.requestHash,folder:t,filename:n.subject()})}))},d.nextcloudICS=ko.observable(null),d.nextcloudSaveICS=()=>{let t=d.nextcloudICS();t&&e.nextcloud.selectCalendar().then((n=>n&&e.nextcloud.calendarPut(n,t)))},d.message.subscribe((t=>{if(d.nextcloudICS(null),t&&l.CalDAV){let n=t.attachments.find((e=>"text/calendar"==e.mimeType));n&&n.download&&e.fetch(n.linkDownload()).then((e=>e.status<400?e.text():Promise.reject(new Error({response:e})))).then((e=>{let t,n,a=["ATTACH","ATTENDEE","CATEGORIES","COMMENT","CONTACT","EXDATE","EXRULE","RSTATUS","RELATED","RESOURCES","RDATE","RRULE"],l=e.split(/\r?\n/),s=l.length;for(;s--;){let e=l[s];if(t){for(;e.startsWith(" ")&&s--;)e=l[s]+e.slice(1);if(e.startsWith("END:VALARM")){n={};continue}if(e.startsWith("BEGIN:VALARM")){t.VALARM||(t.VALARM=[]),t.VALARM.push(n),n=null;continue}if(e.startsWith("BEGIN:VEVENT"))break;e=e.match(/^([^:;]+)[:;](.+)$/),e&&(n?n[e[1]]=e[2]:a.includes(e[1])||"X-"==e[1].slice(0,2)?(t[e[1]]||(t[e[1]]=[]),t[e[1]].push(e[2])):t[e[1]]=e[2])}else e.startsWith("END:VEVENT")&&(t={})}t&&(t.rawText=e,t.isCancelled=()=>t.STATUS?.includes("CANCELLED"),t.isConfirmed=()=>t.STATUS?.includes("CONFIRMED"),t.shouldReply=()=>t.METHOD?.includes("REPLY"),d.nextcloudICS(t))}))}}))}}))})(window.rl);