function getElementsInNamespaces(e,t){const n={d:"DAV:",x1:"http://apple.com/ns/ical/"},s=[];for(const r in n){const o=n[r],a=e.getElementsByTagNameNS(o,t);for(const e of a)s.push(e)}return s}(e=>{const t="http://owncloud.org/ns",n=()=>parent.OC,s=()=>n().webroot+"/ocs/v2.php/apps/files_sharing/api/v1/shares",r=e=>location.protocol+"//"+location.host+(e=>n().webroot+(n().config.modRewriteWorking?"":"/index.php")+e)(e),o=`<?xml version="1.0"?>\n<propfind xmlns="DAV:" xmlns:oc="${t}" xmlns:ocs="http://open-collaboration-services.org/ns" xmlns:nc="http://nextcloud.org/ns">\n\t<prop>\n\t\t<oc:fileid/>\n\t\t<oc:size/>\n\t\t<resourcetype/>\n\t\t<getcontentlength/>\n\t\t<ocs:share-permissions/>\n\t\t<oc:share-types/>\n\t</prop>\n</propfind>`,a=new DOMParser,l=/.*\/remote.php\/dav\/[^/]+\/[^/]+/g,c=(e,t)=>((e,t,n)=>e.getElementsByTagNameNS(t,n))(e,"DAV:",t),i=(e,t)=>c(e,t)?.item(0),p=(e,t)=>+e.getElementsByTagName(t)?.item(0),m=(e,t)=>n().requestToken?((t=Object.assign({mode:"same-origin",cache:"no-cache",redirect:"error",credentials:"same-origin",headers:{}},t)).headers.requesttoken=n().requestToken,fetch(e,t)):Promise.reject(new Error("OC.requestToken missing")),d=(t,n,s)=>{let r=e.settings.get("Nextcloud");return m(r.WebDAV+"/"+t+"/"+r.UID+n,s)},h=(e,t)=>d("files",e,t),u=e=>n().requestToken?h(e,{method:"PROPFIND",headers:{"Content-Type":"application/xml; charset=utf-8"},body:o}).then((e=>e.status<400?e.text():Promise.reject(new Error({response:e})))).then((n=>{const s=[],r=c(a.parseFromString(n,"application/xml").documentElement,"response");e=e.replace(/\/$/,"");for(let n=0;n<r.length;++n){const o=r.item(n),a={name:decodeURIComponent(i(o,"href").textContent.replace(l,"").replace(/\/$/,"")),isFile:!1};if(c(i(o,"resourcetype"),"collection").length){if(a.name===e)continue}else a.isFile=!0,a.id=o.getElementsByTagNameNS(t,"fileid")?.item(0)?.textContent,a.size=i(o,"getcontentlength")?.textContent||p(o,"oc:size")?.textContent,a.shared=[...o.getElementsByTagNameNS(t,"share-type")].some((e=>"3"==e.textContent));s.push(a)}return Promise.resolve(s)})):Promise.reject(new Error("OC.requestToken missing")),g=(e,t,n,s)=>{if(n.length){try{let e=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});n.sort(((t,n)=>e.compare(t.name,n.name)))}catch(e){}n.forEach((n=>{if(!n.isFile){let s=document.createElement("li"),r=document.createElement("details"),o=document.createElement("summary"),a=document.createElement("ul");if(r.addEventListener("toggle",(()=>{a.children.length||u(n.name).then((t=>g(e,a,t,n.name)))})),o.textContent=n.name.replace(/^.*\/([^/]+)$/,"$1"),o.dataset.icon="📁",!e.files()){let e=document.createElement("button");e.name="select",e.textContent="select",e.className="button-vue",o.append(e),o.item_name=n.name}r.append(o),r.append(a),s.append(r),t.append(s)}})),e.files()&&n.forEach((e=>{if(e.isFile){let n=document.createElement("li"),s=document.createElement("input");n.item=e,n.textContent=e.name.replace(/^.*\/([^/]+)$/,"$1"),n.dataset.icon="🗎",s.type="checkbox",n.append(s),t.append(n)}}))}if(!e.files()){let e=document.createElement("li"),n=document.createElement("input"),r=document.createElement("button");r.name="create",r.textContent="create & select",r.className="button-vue",r.input=n,e.item_path=s,e.append(n),e.append(r),t.append(e)}};class f extends e.pluginPopupView{constructor(){super("NextcloudFiles"),this.addObservables({files:!1})}attach(){this.select=[],this.tree.querySelectorAll("input").forEach((e=>e.checked&&this.select.push(e.parentNode.item))),this.close()}shareInternal(){this.select=[],this.tree.querySelectorAll("input").forEach((e=>e.checked&&this.select.push({url:r(`/f/${e.parentNode.item.id}`)}))),this.close()}sharePublic(){const e=[...this.tree.querySelectorAll("input")],t=()=>{if(!e.length)return void this.close();const n=e.pop();if(n.checked){const e=n.parentNode.item;e.shared?m(s()+`?format=json&path=${encodeURIComponent(e.name)}&reshares=true`).then((e=>e.status<400?e.json():Promise.reject(new Error({response:e})))).then((e=>{this.select.push({url:e.ocs.data[0].url}),t()})):m(s(),{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({path:e.name,shareType:3,attributes:"[]"})}).then((e=>e.status<400?e.json():Promise.reject(new Error({response:e})))).then((e=>{this.select.push({url:e.ocs.data.url}),t()}))}else t()};this.select=[],t()}onBuild(e){this.tree=e.querySelector("#sm-nc-files-tree"),this.tree.addEventListener("click",(e=>{let t=e.target;if(t.matches("button")){let e=t.parentNode;if("select"==t.name)this.select=e.item_name,this.close();else if("create"==t.name){let s=t.input.value.replace(/[|\\?*<":>+[]\/&\s]/g,"");s.length&&(s=e.item_path+"/"+s,(n=s,h(n,{method:"MKCOL"})).then((e=>{201==e.status&&(this.select=s,this.close())})))}}var n}))}beforeShow(e,t){this.select="",this.files(!!e),this.fResolve=t,this.tree.innerHTML="",u("/").then((e=>{g(this,this.tree,e,"/")})).catch((e=>{}))}onHide(){this.fResolve(this.select)}}class E extends e.pluginPopupView{constructor(){super("NextcloudCalendars")}onBuild(e){this.tree=e.querySelector("#sm-nc-calendars"),this.tree.addEventListener("click",(e=>{let t=e.target;t.matches("button")&&(this.select=t.href,this.close())}))}createCalendarListItem(e,t){const{displayName:n,href:s,calendarColor:r}=e,o=document.createElement("li");o.style.display="flex";const a=document.createElement("span");a.setAttribute("role","img"),a.className="material-design-icon checkbox-blank-circle-icon",a.style.fill=r,a.style.width="20px",a.style.height="20px";const c=document.createElementNS("http://www.w3.org/2000/svg","svg");c.setAttribute("width","20"),c.setAttribute("height","20"),c.setAttribute("viewBox","0 0 24 24");const i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttribute("d","M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"),c.appendChild(i),a.appendChild(c);const p=document.createElement("button");p.className="button-vue",p.style.backgroundColor="transparent",p.style.border="0",p.style.fontSize="large",p.style.padding="0",p.style.cursor="pointer",p.style.marginLeft="5px",p.href=s.replace(l,"").replace(/\/$/,""),p.textContent=n,p.style.color="#1968DF",o.appendChild(a),o.appendChild(p),t.appendChild(o)}beforeShow(e){this.select="",this.fResolve=e,this.tree.innerHTML="",d("calendars","/",{method:"PROPFIND",headers:{"Content-Type":"application/xml; charset=utf-8"},body:'<?xml version="1.0"?>\n<d:propfind xmlns:d="DAV:" xmlns:x1="http://apple.com/ns/ical/">\n\t<d:prop>\n\t\t<d:resourcetype/>\n\t\t<d:current-user-privilege-set/>\n\t\t<d:displayname/>\n\t\t<x1:calendar-color/>\n\t</d:prop>\n</d:propfind>'}).then((e=>e.status<400?e.text():Promise.reject(new Error({response:e})))).then((e=>{const t=getElementsInNamespaces(a.parseFromString(e,"application/xml").documentElement,"response");for(let e=0;e<t.length;++e){const n=t[e];if(i(n,"resourcetype").getElementsByTagNameNS("urn:ietf:params:xml:ns:caldav","calendar").length){const e=getElementsInNamespaces(n,"displayname")[0],t=e?e.textContent.trim():"",s=getElementsInNamespaces(n,"href")[0],r=s?s.textContent.trim():"",o=getElementsInNamespaces(n,"calendar-color")[0],a={displayName:t,href:r,calendarColor:o?o.textContent.trim():"#000000"};this.createCalendarListItem(a,this.tree)}}})).catch((e=>{}))}onHide(){this.fResolve(this.select)}}e.nextcloud={selectCalendar:()=>new Promise((e=>{E.showModal([t=>e(t)])})),calendarPut:(e,t)=>{d("calendars",e+"/"+t.UID+".ics",{method:"PUT",headers:{"Content-Type":"text/calendar"},body:t.rawText.replace("METHOD:","X-METHOD:").replace("ATTENDEE:","X-ATTENDEE:").replace("ORGANIZER:","X-ORGANIZER:").replace(/RSVP=TRUE/g,"RSVP=FALSE").replace(/\r?\n/g,"\r\n")}).then((e=>{201==e.status||204==e.status||Promise.reject(new Error({response:e}))}))},selectFolder:()=>new Promise((e=>{f.showModal([!1,t=>e(t)])})),selectFiles:()=>new Promise((e=>{f.showModal([!0,t=>e(t)])}))}})(window.rl);